<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  
  <title>Zero&#39;s Blog</title>
  <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1">
  <meta name="description" content="Love Linux ♥ Love Python. 猴赛雷">
<meta property="og:type" content="website">
<meta property="og:title" content="Zero's Blog">
<meta property="og:url" content="http://czero000.github.io/page/2/index.html">
<meta property="og:site_name" content="Zero's Blog">
<meta property="og:description" content="Love Linux ♥ Love Python. 猴赛雷">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Zero's Blog">
<meta name="twitter:description" content="Love Linux ♥ Love Python. 猴赛雷">
  
    <link rel="alternate" href="/atom.xml" title="Zero&#39;s Blog" type="application/atom+xml">
  
  
    <link rel="icon" href="/favicon.png">
  
  
    <link href="//fonts.googleapis.com/css?family=Source+Code+Pro" rel="stylesheet" type="text/css">
  
  <link rel="stylesheet" href="/css/style.css">
  

</head>

<body>
  <div id="container">
    <div id="wrap">
      <header id="header">
  <div id="banner"></div>
  <div id="header-outer" class="outer">
    <div id="header-title" class="inner">
      <h1 id="logo-wrap">
        <a href="/" id="logo">Zero&#39;s Blog</a>
      </h1>
      
        <h2 id="subtitle-wrap">
          <a href="/" id="subtitle">点滴分享 多彩生活</a>
        </h2>
      
    </div>
    <div id="header-inner" class="inner">
      <nav id="main-nav">
        <a id="main-nav-toggle" class="nav-icon"></a>
        
          <a class="main-nav-link" href="/">Home</a>
        
          <a class="main-nav-link" href="/archives">Archives</a>
        
      </nav>
      <nav id="sub-nav">
        
          <a id="nav-rss-link" class="nav-icon" href="/atom.xml" title="RSS Feed"></a>
        
        <a id="nav-search-btn" class="nav-icon" title="Search"></a>
      </nav>
      <div id="search-form-wrap">
        <form action="//google.com/search" method="get" accept-charset="UTF-8" class="search-form"><input type="search" name="q" results="0" class="search-form-input" placeholder="Search"><button type="submit" class="search-form-submit">&#xF002;</button><input type="hidden" name="sitesearch" value="http://czero000.github.io"></form>
      </div>
    </div>
  </div>
</header>
      <div class="outer">
        <section id="main">
  
    <article id="post-docker-blog" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/20/docker-blog.html" class="article-date">
  <time datetime="2016-10-20T02:45:00.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运维技术/">运维技术</a>►<a class="article-category-link" href="/categories/运维技术/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/docker-blog.html">使用Dockerfile创建blog</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <p>Docker 是一个有趣的技术，在过去的两年已经从一个想法变成了全世界的机构都在采用来部署应用的技术。下面会通过 docker 来创建一个blog。</p>
<h1 id="什么是-Docker"><a href="#什么是-Docker" class="headerlink" title="什么是 Docker"></a>什么是 Docker</h1><p>Docker 是一个操作系统容器管理工具，通过将应用打包到操作系统容器里面，从而让你能轻松管理和部署应用。</p>
<h1 id="容器-vs-虚拟机"><a href="#容器-vs-虚拟机" class="headerlink" title="容器 vs 虚拟机"></a>容器 vs 虚拟机</h1><p>容器可能不如虚拟机一样为人所熟知，但是它们是另外的一种提供操作系统虚拟化的方法。然而，他们与标准的虚拟机有很大的差异。</p>
<p>标准的虚拟机通常包含一个完整的操作系统，OS 软件包，最后包含一两个应用。它是通过一个向虚拟机提供了硬件虚拟化的 Hypervisor 来实现的，允许单个服务器运行很多独立的被当做虚拟游客（virtual guest）的操作系统。</p>
<p>而容器与虚拟机的类似之处在于它们允许单个服务器运行多个操作环境（operating environment），然而这些环境不却是完整的操作系统。容器通常只包含必要的 OS 软件包和应用。他们通常不包含一个完整的操作系统或者硬件虚拟化。这也意味着比之虚拟机，容器的额外开销（overhead）更小。</p>
<p>容器和虚拟机通常被视为不能共生的技术，然而这通常是一个误解。虚拟机面向物理服务器，提供可以能与其他虚拟机一起共享这些物理资源的，功能完善的操作环境。容器通常是用来通过对单一主机的一个进程进行隔离，来保证被隔离的进程无法与处于同一个系统的其他进程进行互动。实际上，比起完全的虚拟机，容器与 BSD 的 Jail，chroot 的进程更加类似。</p>
<h1 id="Docker-提供了什么"><a href="#Docker-提供了什么" class="headerlink" title="Docker 提供了什么"></a>Docker 提供了什么</h1><p>Docker自身并不是一个容器的运行时环境；实际上 Docker 实际上是对容器技术不可知的（container technology agnostic），并且为了支持Solaris Zones和 BSD Jails 花了不少功夫。Docker 提供的是一种容器管理，打包和部署的方法。尽管这种类型的功能已经某一种程度地存在于虚拟机中，但在传统上，它们并不是为了绝大多数的容器方案而生的，而那些已经存在的，却又不如 Docker 一样容易使用且功能完善。</p>
<h1 id="通过-Dockerfile-方式部署一个-blog-转载"><a href="#通过-Dockerfile-方式部署一个-blog-转载" class="headerlink" title="通过 Dockerfile 方式部署一个 blog (转载)"></a>通过 Dockerfile 方式部署一个 blog (转载)</h1><ul>
<li>获取 blog 源码</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">git clone http://github.com/madflojo/blog.git</div><div class="line">cd blog</div></pre></td></tr></table></figure>
<ul>
<li>使用 FROM 继承一个 docker 镜像<br>Dockerfile的第一条命令是 <code>FROM</code> 指令。这用来将存在的 Docker 镜像指定为基础镜像，这会让docker 使用 nginx 镜像。如果想使用最原始的空白状态。可以制定 <code>ubuntu:latest</code>使用 ubuntu 镜像。</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">FROM nginx:latest</div><div class="line">MAINTAINER Charlie.Cui &lt;charlie.cui127@mail.com&gt;</div></pre></td></tr></table></figure>
<p>除了使用 <code>FROM</code> 指令，还使用了 <code>MAINTAINER</code> 指令，用来显示 Dockerfile 的作者。Docker支持使用 <code>#</code> 用来当做注释的标示。</p>
<ul>
<li>使用 <code>RUN</code> 来执行 <code>apt-get</code></li>
</ul>
<p>如果需要在 <code>docker</code> 中执行 <code>apt update</code> 和 <code>apt install python-dev</code>，可以通过 <code>RUN</code> 指令来实现。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">FROM nginx:latest</div><div class="line">MAINTAINER Charlie.Cui &lt;charlie.cui127@mail.com&gt;</div><div class="line"></div><div class="line">RUN apt -qq update</div><div class="line">RUN apt -qqy install python-dev python-pip</div></pre></td></tr></table></figure></p>
<ul>
<li>安装 python 模块</li>
</ul>
<p>如果需要安装 python 模块，在 docker 之外，可以使用 pip 命令完成并且引用在仓库中的一个名叫<code>requirements.txt</code>文件。Dockerfile 使用 <code>COPY</code> 指令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">FROM nginx:latest</div><div class="line">MAINTAINER Charlie.Cui &lt;charlie.cui127@mail.com&gt;</div><div class="line"></div><div class="line">RUN apt -qq update</div><div class="line">RUN apt -qqy install python-dev python-pip</div><div class="line"></div><div class="line">RUN mkdir -p /build/</div><div class="line">COPY requirements.txt /build/</div><div class="line">RUN pip install -r /build/requirements.txt</div></pre></td></tr></table></figure></p>
<ul>
<li>构建容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker build -t blog:v1 .</div></pre></td></tr></table></figure>
<p>使用 <code>-t</code> 表示来讲这个镜像打上 blog 标签</p>
<ul>
<li>Docker 构建缓存</li>
</ul>
<p>当docker 构建一个镜像的时候，不仅仅构建一个单一的镜像，它实际上在整个构建过程中构建多个镜像。每进行一步会构建一个镜像，当构建相同的容器时，会使用已经缓存的镜像，而不是重新构建一个镜像。凡是都会有两面，好的一面是当应用场景是 copy 文件，当源文件被更改，再次运行时 docker 会检测到文件不同，会从新 copy 新的文件，但是如果是安装 python-dev 这个软件包，当仓库更新了软件包版本，docker 是没法检测到这个变化，会傻傻的使用缓存，这样就会安装了一个老版本的软件。解决这个需要在 docker 构建时制定 <code>--no-cache=True</code> 来禁用缓存</p>
<ul>
<li>部署 blog 其余部分</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">FROM nginx:latest</div><div class="line">MAINTAINER Charlie.Cui &lt;charlie.cui127@mail.com&gt;</div><div class="line"></div><div class="line">RUN apt -qq update</div><div class="line">RUN apt -qqy install python-dev python-pip</div><div class="line"></div><div class="line">RUN mkdir -p /build/</div><div class="line">COPY requirements.txt /build/</div><div class="line">RUN pip install -r /build/requirements.txt</div><div class="line"></div><div class="line">COPY static /build/static</div><div class="line">COPY templates /build/templates</div><div class="line">COPY hamerkop /build/</div><div class="line">COPY config.yml /build/</div><div class="line">COPY articles /build/articles</div><div class="line"></div><div class="line">RUN /build/hamerkop -c /build/config.yml</div></pre></td></tr></table></figure>
<p>当再次运行 <code>docker build -t blog:v1 .</code>来构建 docker 镜像</p>
<ul>
<li>运行一个定制化的容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -d -p 80:80 --name=blog blog:v1</div></pre></td></tr></table></figure>
<p>使用<code>-p</code>参数，可以标志让用户将一个端口从主机映射到容器的一个端口，</p>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://czero000.github.io/2016/10/20/docker-blog.html" data-id="civlqiudg00gvc15m8oi5idpq" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-docker-images" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/20/docker-images.html" class="article-date">
  <time datetime="2016-10-20T02:44:48.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运维技术/">运维技术</a>►<a class="article-category-link" href="/categories/运维技术/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/docker-images.html">docker镜像</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="镜像"><a href="#镜像" class="headerlink" title="镜像"></a>镜像</h1><h2 id="什么是镜像"><a href="#什么是镜像" class="headerlink" title="什么是镜像"></a>什么是镜像</h2><ul>
<li>镜像是 Docker 的三大组件之一</li>
<li>Docker 镜像就是一个只读模版，一个镜像可以包含一个完整的ubuntu 操作系统，系统安装了 apache 和用户自定义应用软件。</li>
<li>镜像可以用来创建容器，Docker 提供了一个简单的机制来创建镜像或者更新现有镜像，用户甚至可以直接从其他人哪里下载已经做好的镜像来使用</li>
<li>Docker 运行容器之前需要本地存在对应镜像，如果不存在，Docker 就会从镜像仓库下载(默认是 Docker Hub 公共注册服务器的仓库)</li>
</ul>
<h2 id="获取镜像"><a href="#获取镜像" class="headerlink" title="获取镜像"></a>获取镜像</h2><p>通过 <code>docker pull</code> 命令从仓库下载所需的镜像，镜像可以通过 <code>Docker Hub</code> 获取已有镜像并更新，也可以利用本地文件系统创建一个<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">\\下载一个ubuntu16.04操作系统镜像</div><div class="line"> docker pull ubuntu:16.04</div></pre></td></tr></table></figure></p>
<p>该命令实际上是<code>docker pull registry.hub.docker.com/ubuntu:16.04</code>命令，即从注册服务器<code>registry.hub.docker.com</code>中的<code>ubuntu</code>仓库下载标记为16.04的镜像<br>有的时候官方注册服务器下载较慢，可以从其他仓库下载，如：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker pull somedomain:5000/ubuntu:16.04</div></pre></td></tr></table></figure></p>
<h2 id="列出当前镜像"><a href="#列出当前镜像" class="headerlink" title="列出当前镜像"></a>列出当前镜像</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker images           </div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             SIZE</div><div class="line">ubuntu              16.04               c73a085dc378        2 weeks ago         127.1 MB</div></pre></td></tr></table></figure>
<p>在列出的信息中，可以看到几个字段的信息</p>
<ul>
<li>来自那个仓库 -&gt; ubuntu</li>
<li>镜像的标记   -&gt; latest、16.04</li>
<li>ID         -&gt; 唯一</li>
<li>创建时间</li>
<li>镜像大小<br><code>TAG</code>信息标记来自同一个仓库的不同镜像，例如<code>ubuntu</code>仓库有多个镜像，通过TAG信息区分放行版本，例如，10.04、12.04、12.10等。通过下面命令指定镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">\\ 通过ubuntu:16.04 启动一个容器</div><div class="line">docker run -t -i ubuntu:16.04 /bin/bash</div></pre></td></tr></table></figure>
<p>如果不执行 <code>TAG</code>，则默认使用 <code>latest</code> 标记信息</p>
<h2 id="修改已有镜像"><a href="#修改已有镜像" class="headerlink" title="修改已有镜像"></a>修改已有镜像</h2><ul>
<li>利用镜像启动一个容器<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --name docker_test -i -t -d ubuntu:16.04 /bin/bash</div></pre></td></tr></table></figure>
</li>
</ul>
<p>在容器中添加vim软件<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt install -y vim</div></pre></td></tr></table></figure></p>
<p>当结束后，使用<code>exit</code>退出，现在容器被改变了，使用docker commit命令提交更新后的副本<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">docker commit -m &quot;Added Vim&quot; -a &quot;charlie.cui&quot; 50eabeaf73f6 ubuntu:16.04v2</div><div class="line">325a4e26e96fdefb70a9941db1c19ead801cf3ac5d9228bca6fc6c1a13c0ab92</div></pre></td></tr></table></figure></p>
<ul>
<li><code>-m</code> 来指定提交的说明信息,与使用版本控制工具一样</li>
<li><code>-a</code> 可以指定更新的用户信息</li>
<li>容器ID</li>
<li>指定目标镜像仓库名和tag信息<br>成功创建之后便会返回镜像的ID信息</li>
</ul>
<p>使用 <code>docker images</code> 来查看新创建的镜像</p>
<p>之后便可以使用新的镜像启动容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run -t -i ubuntu:16.04v2 /bin/bash</div></pre></td></tr></table></figure></p>
<h3 id="利用-Dockerfile-来创建镜像"><a href="#利用-Dockerfile-来创建镜像" class="headerlink" title="利用 Dockerfile 来创建镜像"></a>利用 Dockerfile 来创建镜像</h3><p>使用 <code>docker commit</code> 来扩展一个镜像相对简单，但是不方便在一个团队中分享。可以使用 <code>docker build</code> 来创建一个新的镜像，首先需要创建一个 Dockerfile ，包含一些如何创建镜像的指令</p>
<ul>
<li>新建一个目录和一个 Dockerfile</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">mkdir docker</div><div class="line">cd docker/</div><div class="line">touch Dockerfile</div></pre></td></tr></table></figure>
<ul>
<li>Dockerfile 中每一条指令都创建镜像的一层<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">cat Dockerfile</div><div class="line">#This is a comment</div><div class="line">FROM ubuntu:16.04</div><div class="line">MAINTAINER Charlie.Cui &lt; charlie.cui127@gmail.com &gt; </div><div class="line">RUN apt-get -qq update</div><div class="line">RUN apt-get -qqy install vim</div></pre></td></tr></table></figure>
</li>
</ul>
<p>Dockerfile 的基本语法</p>
<ul>
<li>使用#来注释</li>
<li><code>FROM</code>指令告诉Docker使用哪个镜像作为基础镜像</li>
<li>接着为维护者信息</li>
<li><code>RUN</code>开头的指令会在创建中运行，比如安装一个软件包，在这里使用<code>apt-get</code>安装vim</li>
</ul>
<p>编写 Dockerfile 之后，可以使用 <code>docker build</code> 来生成镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">docker build -t &quot;ubuntu16.04:v1&quot; . </div><div class="line">Sending build context to Docker daemon 3.072 kB</div><div class="line">Step 1 : FROM ubuntu:16.04</div><div class="line"> ---&gt; e9ae3c220b23</div><div class="line">Step 2 : MAINTAINER Charlie.Cui </div><div class="line"> ---&gt; Using cache</div><div class="line"> ---&gt; 16d77dc9a444</div><div class="line">Step 3 : RUN apt-get -y -qq update</div><div class="line"> ---&gt; Running in b8407b9d75c4</div><div class="line"> ---&gt; 8721117f7c1f</div><div class="line">...</div><div class="line">Processing triggers for libc-bin (2.19-0ubuntu6.6) ...</div><div class="line"> ---&gt; 5a4b35abd4c4</div><div class="line">Removing intermediate container bb09f1a73b30</div><div class="line">Successfully built 5a4b35abd4c4</div></pre></td></tr></table></figure></p>
<p>其中 <code>-t</code> 标记添加 tag，指定新的镜像用户信息。 <code>.</code>是 Dockerfile 所在的路径(当前目录)，也可以使用一个具体的 Dockerfile 路径</p>
<p>上面的过程可以看到 build 进程在执行操作。它所做的第一件事就是上传 Dockerfile 内容，应为所有的操作都是根据 Dockerfile 内容来执行。<br>然后，Dockfile 中的指令被一条一条的执行，每一步都创建了一个新的容器，在容器中执行指令并提交修改(跟 docker commit 命令一样)。当所有的指令执行之后，返回最终的镜像 ID，所有的中间步骤产生的容器都被清理掉。</p>
<p><strong>注： Dockerfile 中执行命令不能超过127</strong></p>
<p>此外，还可以利用 ADD 命令赋值本地文件到镜像；用 <code>EXPOSE</code> 命令向外部开放端口；用 <code>CMD</code> 命令来描述容器启动后运行的程序<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">ADD myApp /var/www</div><div class="line">EXPOSE 80</div><div class="line">CMD [&quot;/usr/sbin/apachectl&quot;, &quot;-d&quot;, &quot;FOREGROUND&quot;]</div></pre></td></tr></table></figure></p>
<p>现在可以利用新创建的镜像启动一个容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker]# docker run -t -i ubuntu16.04:v1 /bin/bash</div></pre></td></tr></table></figure></p>
<p>还可以用 <code>docker tag</code>命令修改镜像标签<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker tag 5a4b35abd4c4 ubuntu16.04:devel</div></pre></td></tr></table></figure></p>
<h3 id="本地文件系统导入"><a href="#本地文件系统导入" class="headerlink" title="本地文件系统导入"></a>本地文件系统导入</h3><p>要从本地文件系统导入一个镜像，可以使用openvz的模版来创建：openvz的模版下载地址：<a href="http://openvz.org/Download/templates/precreated" target="_blank" rel="external">http://openvz.org/Download/templates/precreated</a></p>
<p>下载一个centos-7-x86_64的镜像，使用下面命令导入<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">wget http://download.openvz.org/template/precreated/centos-7-x86_64.tar.gz</div><div class="line">cat centos-7-x86_64.tar.gz | docker import - centos:7</div><div class="line">45a9c0d13bd2d94a69f8a70501541f5329dbbc4760e610013a801d8e11d8cb46</div></pre></td></tr></table></figure></p>
<p>查看导入的新镜像<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker images</div><div class="line">REPOSITORY          TAG                 IMAGE ID            CREATED             VIRTUAL SIZE</div><div class="line">centos              7                   45a9c0d13bd2        7 minutes ago       564.3 MB</div></pre></td></tr></table></figure></p>
<h3 id="存出镜像"><a href="#存出镜像" class="headerlink" title="存出镜像"></a>存出镜像</h3><p>如果想要导出镜像到本地文件，可以使用<code>docker save</code>命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">\\ 保存镜像到本地文件</div><div class="line">docker save -o ubuntu_16.04.tar ubuntu:16.04</div></pre></td></tr></table></figure></p>
<h3 id="载入镜像"><a href="#载入镜像" class="headerlink" title="载入镜像"></a>载入镜像</h3><p>可以使用<code>docker load</code>从导出的本地文件在导入到本地镜像库,命令会导入镜像以及其他的元数据信息(标签等)<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker load --input ubuntu_16.04.tar</div><div class="line">或者</div><div class="line">docker load &lt; ubuntu_16.04.tar</div></pre></td></tr></table></figure></p>
<h4 id="移除本地镜像"><a href="#移除本地镜像" class="headerlink" title="移除本地镜像"></a>移除本地镜像</h4><p>如果要移除本地镜像，使用<code>docker rmi</code>命令<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">dock rmi ubuntu:16.04</div></pre></td></tr></table></figure></p>
<p><strong><em> 在删除镜像之前要先<code>docker rm</code>删除掉依赖于这个镜像的容器 </em></strong></p>
<h3 id="清理所有为打过标签的本地镜像"><a href="#清理所有为打过标签的本地镜像" class="headerlink" title="清理所有为打过标签的本地镜像"></a>清理所有为打过标签的本地镜像</h3><p><code>docker images</code> 可以列出本地的所有镜像，其中有很多中间状态的未打过标签的镜像，大量占用磁盘空间，使用下面命令清理本地镜像</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">docker rmi $(docker images -q -f &quot;dangling=true&quot;)</div><div class="line"></div><div class="line">\\ 完整写法</div><div class="line">docker rmi $(docker images --quiet --filter &quot;dangling=true&quot;)</div></pre></td></tr></table></figure>
<h3 id="镜像的实现原理"><a href="#镜像的实现原理" class="headerlink" title="镜像的实现原理"></a>镜像的实现原理</h3><blockquote>
<p>Docker 镜像是怎么实现增量的修改和维护的？ 每个镜像都由很多层次构成，Docker 使用 Union FS 将这<br>些不同的层结合到一个镜像中去。<br>通常 Union FS 有两个用途, 一方面可以实现不借助 LVM、RAID 将多个 disk 挂到同一个目录下,另一个更<br>常用的就是将一个只读的分支和一个可写的分支联合在一起，Live CD 正是基于此方法可以允许在镜像不<br>变的基础上允许用户在其上进行一些写操作。 Docker 在 AUFS 上构建的容器也是利用了类似的原理。</p>
</blockquote>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://czero000.github.io/2016/10/20/docker-images.html" data-id="civlqiude00gsc15mjvp7z1zo" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-rudiments-of-docker" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/20/rudiments-of-docker.html" class="article-date">
  <time datetime="2016-10-20T02:43:29.000Z" itemprop="datePublished">2016-10-20</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运维技术/">运维技术</a>►<a class="article-category-link" href="/categories/运维技术/Docker/">Docker</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/20/rudiments-of-docker.html">Docker入门介绍</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Docker-简介"><a href="#Docker-简介" class="headerlink" title="Docker 简介"></a>Docker 简介</h1><h2 id="Docker-是什么"><a href="#Docker-是什么" class="headerlink" title="Docker 是什么"></a>Docker 是什么</h2><blockquote>
<p>Docker is an open-source engine that automates the deployment of any application as a lightweight, portable, self-sufficient container that will run virtually anywhere.</p>
</blockquote>
<p>Docker[<a href="http://www.docker.com/" target="_blank" rel="external">http://www.docker.com/</a>] 是 PaaS 提供商 <a href="http://www.dotcloud.com/" target="_blank" rel="external">dotCloud</a> 开源的一个基于 LXC 的高级容器引擎， <a href="http://github.com/docker/docker" target="_blank" rel="external">]源代码</a>托管在 <a href="http://www.github.com" target="_blank" rel="external">Github</a> 上, 基于go语言并遵从Apache2.0协议开源。Docker近期非常火热，无论是从 GitHub 上的代码活跃度，还是Redhat宣布在 <a href="http://server.cnw.com.cn/server-os/htm2014/20140616_303249.shtml" target="_blank" rel="external">RHEL7中正式支持Docker</a>，都给业界一个信号，这是一项创新型的技术解决方案。就连 Google 公司的 Compute Engine 也支持 docker 在其之上运行，国内 “BAT” 先锋企业百度 Baidu App Engine(BAE) 平台也是<a href="http://blog.docker.com/2013/12/baidu-using-docker-for-its-paas/" target="_blank" rel="external">以Docker作为其PaaS云基础</a>。</p>
<p>Docker产生的目的就是为了解决以下问题：</p>
<ol>
<li><p>环境管理复杂：从各种 OS 到各种中间件再到各种 App，一款产品能够成功发布，作为开发者需要关心的东西太多，且难于管理，这个问题在软件行业中普遍存在并需要直接面对。Docker可以简化部署多种应用实例工作，比如 Web 应用、后台应用、数据库应用、大数据应用比如 Hadoop 集群、消息队列等等都可以打包成一个 Image 部署。</p>
</li>
<li><p>云计算时代的到来：AWS 的成功，引导开发者将应用转移到云上, 解决了硬件管理的问题，然而软件配置和管理相关的问题依然存在 (AWS cloudformation是这个方向的业界标准, 样例模板可参考这里)。Docker 的出现正好能帮助软件开发者开阔思路，尝试新的软件管理方法来解决这个问题。</p>
</li>
<li><p>虚拟化手段的变化：云时代采用标配硬件来降低成本，采用虚拟化手段来满足用户按需分配的资源需求以及保证可用性和隔离性。然而无论是 KVM 还是 Xen，在 Docker 看来都在浪费资源，因为用户需要的是高效运行环境而非OS，GuestOS 既浪费资源又难于管理，更加轻量级的 LXC 更加灵活和快速。<br><img src="http://ofc9x1ccn.bkt.clouddn.com/docker/vm.png" alt="vm"><br><img src="http://ofc9x1ccn.bkt.clouddn.com/docker/docker.png" alt="docker"></p>
</li>
<li><p>LXC 的便携性：LXC 在 Linux 2.6 的 Kernel 里就已经存在了，但是其设计之初并非为云计算考虑的，缺少标准化的描述手段和容器的可便携性，决定其构建出的环境难于分发和标准化管理(相对于 KVM 之类 image 和 snapshot 的概念)。Docker 就在这个问题上做出了实质性的创新方法。</p>
</li>
</ol>
<h2 id="Docker的主要特性"><a href="#Docker的主要特性" class="headerlink" title="Docker的主要特性"></a>Docker的主要特性</h2><ul>
<li>文件系统隔离： 每个进程容器运行在完全独立的根文件系统里。</li>
<li>资源隔离： 可以使用 cgroup 为每个进程容器分配不同的系统资源，例如 CPU 和内存。</li>
<li>网络隔离： 每个进程容器运行在自己的网络命名空间里，拥有自己的虚拟接口和 IP 地址。</li>
<li>写时复制： 采用写时复制方式创建根文件系统，这让部署变得极其快捷，并且节省内存和硬盘空间。</li>
<li>日志记录： Docker 将会收集和记录每个进程容器的标准流（stdout/stderr/stdin），用于实时检索或批量检索。</li>
<li>变更管理： 容器文件系统的变更可以提交到新的映像中，并可重复使用以创建更多的容器。无需使用模板或手动配置。</li>
<li>交互式 Shell： Docker 可以分配一个虚拟终端并关联到任何容器的标准输入上，例如运行一个一次性交互 shell。</li>
</ul>
<h2 id="Docker-vs-传统虚拟化技术"><a href="#Docker-vs-传统虚拟化技术" class="headerlink" title="Docker vs 传统虚拟化技术"></a>Docker vs 传统虚拟化技术</h2><p>作为一种新兴的虚拟化方式，Docker 跟传统的虚拟化方式（xen、kvm、vmware）相比具有众多的优势。</p>
<p>首先，Docker 容器的启动可以在秒级实现，这相比传统的虚拟机方式要快得多。 其次，Docker 对系统资源的利用率很高，一台主机上可以同时运行数千个 Docker 容器。容器除了运行其中应用外，基本不消耗额外的系统资源，使得应用的性能很高，同时系统的开销尽量小。传统虚拟机方式运行 10 个不同的应用就要起 10 个虚拟机，而 Docker 只需要启动 10 个隔离的应用即可。</p>
<p>具体说来，Docker 在如下几个方面具有较大的优势。</p>
<ul>
<li><p>更快速的交付和部署<br>对开发和运维（devop）人员来说，最希望的就是一次创建或配置，可以在任意地方正常运行。<br>开发者可以使用一个标准的镜像来构建一套开发容器，开发完成之后，运维人员可以直接使用这个容器来部署代码。 Docker 可以快速创建容器，快速迭代应用程序，并让整个过程全程可见，使团队中的其他成员更容易理解应用程序是如何创建和工作的。 Docker 容器很轻很快！容器的启动时间是秒级的，大量地节约开发、测试、部署的时间。</p>
</li>
<li><p>更高效的虚拟化<br>Docker 容器的运行不需要额外的 hypervisor 支持，它是内核级的虚拟化，因此可以实现更高的性能和效率。</p>
</li>
<li><p>更轻松的迁移和扩展<br>Docker 容器几乎可以在任意的平台上运行，包括物理机、虚拟机、公有云、私有云、个人电脑、服务器等。 这种兼容性可以让用户把一个应用程序从一个平台直接迁移到另外一个。</p>
</li>
<li><p>更简单的管理<br>使用 Docker，只需要小小的修改，就可以替代以往大量的更新工作。所有的修改都以增量的方式被分发和更新，从而实现自动化并且高效的管理。</p>
</li>
</ul>
<p>对比传统虚拟机总结：</p>
<table>
<thead>
<tr>
<th>特性</th>
<th>容器</th>
<th>虚拟机</th>
</tr>
</thead>
<tbody>
<tr>
<td>启动</td>
<td>秒级</td>
<td>分钟级</td>
</tr>
<tr>
<td>硬盘使用</td>
<td>一般为 MB</td>
<td>一般为 GB</td>
</tr>
<tr>
<td>性能</td>
<td>接近原生</td>
<td>弱于</td>
</tr>
<tr>
<td>系统支持量</td>
<td>单机支持上千个容器</td>
<td>一般几十个</td>
</tr>
</tbody>
</table>
<h2 id="Docker-vs-lxc"><a href="#Docker-vs-lxc" class="headerlink" title="Docker vs lxc"></a>Docker vs lxc</h2><p>Docker 以 Linux 容器 LXC 为基础，实现轻量级的操作系统虚拟化解决方案。在 LXC 的基础上 Docker 进行了进一步的封装，让用户不需要去关心容器的管理，使得操作更为简便，具体改进有</p>
<ul>
<li>Portable deployment across machines</li>
</ul>
<p>Docker 提供了一种可移植的配置标准化机制，允许你一致性地在不同的机器上运行同一个 Container；而 LXC 本身可能因为不同机器的不同配置而无法方便地移植运行；</p>
<ul>
<li>Application-centric</li>
</ul>
<p>Docker 以 App 为中心，为应用的部署做了很多优化，而 LXC 的帮助脚本主要是聚焦于如何机器启动地更快和耗更少的内存；</p>
<ul>
<li><p>Automatic build<br>Docker 为 App 提供了一种自动化构建机制（Dockerfile），包括打包，基础设施依赖管理和安装等等；</p>
</li>
<li><p>Versioning</p>
</li>
</ul>
<p>Docker 提供了一种类似 git 的 Container 版本化的机制，允许你对你创建过的容器进行版本管理，依靠这种机制，你还可以下载别人创建的 Container，甚至像 git 那样进行合并；</p>
<ul>
<li>Component reuse</li>
</ul>
<p>Docker Container 是可重用的，依赖于版本化机制，你很容易重用别人的 Container，作为基础版本进行扩展；</p>
<ul>
<li>Sharing</li>
</ul>
<p>Docker Container 是可共享的，有点类似 github 一样，Docker 有自己的 INDEX，你可以创建自己的 Docker 用户并上传和下载 Docker Image；</p>
<ul>
<li>Tool ecosystem</li>
</ul>
<p>Docker 提供了很多的工具链，形成了一个生态系统；这些工具的目标是自动化、个性化和集成化，包括对 PAAS 平台的支持等。</p>
<h2 id="docker-应用场景"><a href="#docker-应用场景" class="headerlink" title="docker 应用场景"></a>docker 应用场景</h2><p>Docker 作为一个开源的应用容器引擎，让开发者可以打包他们的应用以及依赖包到一个可移植的容器中，然后发布到任何流行的 Linux 机器上，也可以实现虚拟化。Docker 可以自动化打包和部署任何应用、创建一个轻量级私有 PaaS 云、搭建开发测试环境、部署可扩展的 Web 应用等。这决定了它在企业中的应用场景是有限的，Docker 将自己定位为“分发应用的开放平台”，其网站上也明确地提到了 Docker的典型应用场景</p>
<blockquote>
<ul>
<li>Automating the packaging and deployment of applications</li>
<li>Creation of lightweight, private PAAS environments</li>
<li>Automated testing and continuous integration/deployment</li>
<li>Deploying and scaling web apps, databases and backend services</li>
</ul>
</blockquote>
<p>对应用进行自动打包和部署，创建轻量、私有的 PAAS 环境，自动化测试和持续整合与部署，部署和扩展Web应用、数据库和后端服务。</p>
<p>平台即服务一般与大数据量系统同在，反观当前我司各 IT 系统，可以在以下情形下使用 docker 替代方案：</p>
<ol>
<li><p>结合 vagrant 或 supervisor，搭建统一的开发、测试环境<br>多个开发人员共同进行一个项目，就必须保持开发环境完全一致，部署到测试环境、正式环境后，最好都是同一套环境，通过容器来保存状态，分发给开发人员或部署，可以让“代码在我机子上运行没有问题”这种说辞将成为历史。</p>
</li>
<li><p>对 memcached、mysql 甚至 tomcat，打包成一个个容器，避免重复配置<br>比如将一个稳定版本的、已配置完善的 mysql，固化在一个镜像中，假如有新的环境要用到 mysql 数据库，便不需要重新安装、配置，而只需要启动一个容器瞬间完成。tomcat 应用场景更多，可以将不同版本的 jvm 和 tomcat 打包分发，应用于多 tomcat 集群，或在测试服务器上隔离多个不同运行环境要求的测试应用（例如旧系统采用的是 jdk6，新系统在jdk7上开发，但共用同一套测试环境）。</p>
</li>
</ol>
<p><strong>docker不足</strong></p>
<ul>
<li><p>LXC 是基于 cgroup 等 linux kernel 功能的，因此 container 的 guest 系统只能是 linux base 的</p>
</li>
<li><p>隔离性相比 KVM之类的虚拟化方案还是有些欠缺，所有 container公用一部分的运行库</p>
</li>
<li><p>网络管理相对简单，主要是基于 namespace 隔离</p>
</li>
<li><p>cgroup 的 cpu 和 cpuset 提供的 cpu 功能相比 KVM 的等虚拟化方案相比难以度量(所以 dotcloud 主要是安内存收费)</p>
</li>
<li><p>container 随着用户进程的停止而销毁，container 中的 log 等用户数据不便收集</p>
</li>
</ul>
<p>另外，Docker 是面向应用的，其终极目标是构建 PAAS 平台，而现有虚拟机主要目的是提供一个灵活的计算资源池，是面向架构的，其终极目标是构建一个 IAAS 平台，所以它不能替代传统虚拟化解决方案。目前在容器可管理性方面，对于方便运维，提供 UI 来管理监控各个 containers的功能还不足，还都是第三方实现如 DockerUI、Dockland、Shipyard 等。</p>
<h2 id="docker-组成部分"><a href="#docker-组成部分" class="headerlink" title="docker 组成部分"></a>docker 组成部分</h2><p><img src="http://ofc9x1ccn.bkt.clouddn.com/docker/make_docker.png" alt="make_docker"><br>Docker 使用客户端-服务器 (client-server) 架构模式。Docker 客户端会与 Docker 守护进程进行通信。Docker 守护进程会处理复杂繁重的任务，例如建立、运行、发布你的Docker 容器。Docker 客户端和守护进程可以运行在同一个系统上，当然你也可以使用 Docker 客户端去连接一个远程的 Docker 守护进程。Docker 客户端和守护进程之间通过socket或者 RESTful API 进行通信。</p>
<h3 id="images-镜像"><a href="#images-镜像" class="headerlink" title="images 镜像"></a>images 镜像</h3><p>Docker 镜像就是一个只读的模板。例如，一个镜像可以包含一个完整的 ubuntu 操作系统环境，里面仅安装了 Apache 或用户需要的其它应用程序。<br>镜像可以用来创建 Docker 容器。<br>Docker 提供了一个很简单的机制来创建镜像或者更新现有的镜像，用户甚至可以直接从其他人那里下载一个已经做好的镜像来直接使用。</p>
<h3 id="container-容器"><a href="#container-容器" class="headerlink" title="container 容器"></a>container 容器</h3><p>Docker 利用容器来运行应用。容器是从镜像创建的运行实例。它可以被启动、开始、停止、删除。每个容器都是相互隔离的、保证安全的平台。可以把容器看做是一个简易版的 Linux 环境（包括root用户权限、进程空间、用户空间和网络空间等）和运行在其中的应用程序。 镜像是只读的，容器在启动的时候创建一层可写层作为最上层。</p>
<h3 id="repository-仓库"><a href="#repository-仓库" class="headerlink" title="repository 仓库"></a>repository 仓库</h3><p>仓库是集中存放镜像文件的场所。有时候会把仓库和仓库注册服务器（Registry）混为一谈，并不严格区分。实际上，仓库注册服务器上往往存放着多个仓库，每个仓库中又包含了多个镜像，每个镜像有不同的标签（tag）。</p>
<ul>
<li>公开仓库</li>
</ul>
<p>docker团队控制的top-level的顶级repository，即<a href="http://registry.hub.docker.com/" target="_blank" rel="external">Docker Hub</a>，存放了数量庞大的镜像供用户下载，任何人都能读取，里面包含了许多常用的镜像，如ubuntu, mysql ,redis, python等。</p>
<ul>
<li>个人仓库</li>
</ul>
<p>个人公共库也是被托管在Docker Hub上，网络上的其它用户也可以pull你的仓库（如docker pull seanloook/centos6）你可以在修改完自己的container之后，通过commit命令把它变成本地的一个image，push到自己的个人公共库。（在此之前你需要docker login登录，或者vi ~/.dockercfg。）</p>
<ul>
<li>私有仓库</li>
</ul>
<p>首先与另外一种仓库区分——Docker Hub Private Repository，它简单理解为公网上的个人私有库，与上面的个人公共库相对应，在Docker Hub上Create Repository时选择Private便是，只有你自己才可以读写。<br>这里所说的私有仓库是指自己在本地服务器上搭建的专属自己的内部仓库docker-registry，俗称“私服”，供无法访问互联网的内部网络使用，或者镜像到本地一份以加快pull、push的速度。<br>它与公共仓库最明显的区分就是repository的命名，如必须使用带.的主机名或域名，后面必须接:port，如sean.tp-link.net:5000/centos6:your_tag_name，而公共仓库第一个斜杠前表示的是登录用户名。命名关系到推送到哪个服务器的哪个位置，</p>
<h2 id="运行一个容器的内部过程"><a href="#运行一个容器的内部过程" class="headerlink" title="运行一个容器的内部过程"></a>运行一个容器的内部过程</h2><p>docker client告诉docker daemon运行一个容器，例如：docker run -i -t ubuntu /bin/bash<br>让我们分解一下这个命令，docker client启动使用一个二进制的docker命令，最小的docker client需要你告诉docker daemon你的容器是从哪个docker镜像构建的，你希望在容器内部运行哪个命令。所以启动过程如下：</p>
<ul>
<li>Pulling the ubuntu image</li>
</ul>
<p>docker检查是否存在ubuntu镜像，如果本地不存在ubuntu镜像，则docker会到docker index下载。</p>
<ul>
<li>Creates a new container</li>
</ul>
<p>利用镜像创建容器</p>
<ul>
<li>Allocates a filesystem and mounts a read-write layer</li>
</ul>
<p>为镜像创建文件系统层和read-write层</p>
<ul>
<li>Allocates a network / bridge interface</li>
</ul>
<p>为容器创建网络接口，使容器和本地机器可以通讯</p>
<ul>
<li>Sets up an IP address</li>
</ul>
<p>在地址池中为容器分配一个可用的IP地址</p>
<ul>
<li>Executes a process that you specify</li>
</ul>
<p>运行你的应用</p>
<ul>
<li>Captures and provides application output</li>
</ul>
<p>连接log的标准输入、输出、错误，以使你直到你的应用是否正常运行</p>
<h1 id="安装-Docker"><a href="#安装-Docker" class="headerlink" title="安装 Docker"></a>安装 Docker</h1><p>Docker可以运行在Ubuntu16.04 LTS 和 CentOS7.x上，可能会和其他的二进制 EL7 兼容工作，但是 Docker 官方并没有去做测试。</p>
<h2 id="准备"><a href="#准备" class="headerlink" title="准备"></a>准备</h2><p>先决条件：</p>
<ul>
<li>运行64为CPU架构（x86_64和amd64），不支持32位</li>
<li>运行Linux3.8 或更高版本，老版本的2.6.x及之后版本也可以运行，但是运行结果大不相同</li>
<li>内核必须支持合适的存储驱动（storagedriver）<ul>
<li>Device Manager</li>
<li>AUFS</li>
<li>vfs</li>
<li>btrfs</li>
</ul>
</li>
<li>内核必须支持并开启cgroup和命名空间功能</li>
</ul>
<h2 id="安装"><a href="#安装" class="headerlink" title="安装"></a>安装</h2><ul>
<li>更新系统</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">apt-get update</div><div class="line">apt install linux-image-extra-$(uname -r) linux-image-extra-virtual</div><div class="line">apt-get install apt-transport-https ca-certificates</div></pre></td></tr></table></figure>
<ul>
<li>添加 GPG Key</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apt-key adv --keyserver hkp://p80.pool.sks-keyservers.net:80 --recv-keys 58118E89F3A912897C070ADBF76221572C52609D</div></pre></td></tr></table></figure>
<ul>
<li>增加安装源</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">vim /etc/apt/sources.list.d/docker.list</div><div class="line">// On Ubuntu Precise 12.04 (LTS)</div><div class="line">deb http://apt.dockerproject.org/repo ubuntu-precise main</div><div class="line">// On Ubuntu Trusty 14.04 (LTS)</div><div class="line">deb http://apt.dockerproject.org/repo ubuntu-trusty main</div><div class="line">// Ubuntu Wily 15.10</div><div class="line">deb http://apt.dockerproject.org/repo ubuntu-wily main</div><div class="line">// Ubuntu Xenial 16.04 (LTS)</div><div class="line">deb http://apt.dockerproject.org/repo ubuntu-xenial main</div></pre></td></tr></table></figure>
<ul>
<li>安装docker</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">apt update</div><div class="line">apt install docker</div></pre></td></tr></table></figure>
<ul>
<li>启动docker</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">systemctl start docker</div></pre></td></tr></table></figure>
<ul>
<li>验证启动</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">docker info</div><div class="line">Containers: 0</div><div class="line"> Running: 0</div><div class="line"> Paused: 0</div><div class="line"> Stopped: 0</div><div class="line">Images: 0</div><div class="line">Server Version: 1.12.2</div><div class="line">Storage Driver: aufs</div><div class="line"> Root Dir: /var/lib/docker/aufs</div><div class="line"> Backing Filesystem: extfs</div><div class="line"> Dirs: 0</div><div class="line"> Dirperm1 Supported: true</div><div class="line">Logging Driver: json-file</div><div class="line">Cgroup Driver: cgroupfs</div></pre></td></tr></table></figure>
<h1 id="使用-Docker及-docker-命令汇总"><a href="#使用-Docker及-docker-命令汇总" class="headerlink" title="使用 Docker及 docker 命令汇总"></a>使用 Docker及 docker 命令汇总</h1><h2 id="查看-docker-信息"><a href="#查看-docker-信息" class="headerlink" title="查看 docker 信息"></a>查看 docker 信息</h2><ul>
<li>查看 docker 版本</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker Version</div></pre></td></tr></table></figure>
<ul>
<li>显示 docker 系统的信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker info</div></pre></td></tr></table></figure>
<h2 id="镜像相关"><a href="#镜像相关" class="headerlink" title="镜像相关"></a>镜像相关</h2><ul>
<li>检索 image</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// docker search image_name</div><div class="line">docker search ubuntu:16.04</div></pre></td></tr></table></figure>
<ul>
<li>下载一个预建立的镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// docker pull image_name</div><div class="line">docker pull ubuntu:16.04</div><div class="line">Digest: sha256:28d4c5234db8d5a634d5e621c363d900f8f241240ee0a6a978784c978fe9c737</div><div class="line">Status: Downloaded newer image for ubuntu:16.04</div></pre></td></tr></table></figure>
<p>这个将从索引仓库中通过名字找到ubuntu镜像，并从索引仓库中心下载到本地镜像存储<br>当镜像下载成功后，你可以看到12位的hash值，如c73a085dc378，这是下载完整的镜像的精简ID，这些短的镜像ID是完整镜像ID前12个字符—可以使用docker inspect或者docker images -no-trunc=true来获取完整镜像ID</p>
<ul>
<li>列出镜像列表</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker images</div></pre></td></tr></table></figure>
<ul>
<li>删除一个或者多个镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//docker rmi image_name</div><div class="line">docker rmi ubuntu:16.04</div></pre></td></tr></table></figure>
<ul>
<li>显示一个镜像的历史</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// docker history image_name</div><div class="line">docker history ubuntu:16.04</div></pre></td></tr></table></figure>
<h2 id="容器操作"><a href="#容器操作" class="headerlink" title="容器操作"></a>容器操作</h2><ul>
<li>创建容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//使用 docker run 命令创建容器,-i 保证容器中 STDIN 开启，-t 分配一个伪终端</div><div class="line">docker run -i -t ubuntu /bin/bash</div></pre></td></tr></table></figure>
<p>使用 ubuntu:16.04 运行一个交互性的 shell,分配一个伪终端，附带 stdin 和 stout ,如果想要退出伪终端，使用 CTRL -p + CTRL -q,容器只有在指定的 /bin/bash 命令处于运行状态，容器才会运行，一旦退出 <code>/bin/bash</code>，容器随之停止。</p>
<p>如果容器因为某种错误导致停止，可以通过<code>--restart</code>标志，让docker自动重启容器。–restart会检查容器的退出状态，并据此来判断是否要重启容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --restart=always --name=docker_test -i -t -d ubuntu:16,04 /bin/bash</div></pre></td></tr></table></figure></p>
<ul>
<li>容器命名</li>
</ul>
<p>容器命名可以是使用小写字母a-z、大写字母A-Z、数字0-9、下划线、圆点、横线。容器的命名必须是唯一<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --name docker_test -i -t ubuntu:16.04 /bin/bash</div></pre></td></tr></table></figure></p>
<p>可以通过增加 <code>-d</code> 参数，创建一个长时间运行的容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker run --name docker_test -i -t -d ubuntu:16.04 /bin/bash</div></pre></td></tr></table></figure></p>
<ul>
<li>查看容器状态</li>
</ul>
<p>通过 <code>docker ps -a</code>可以列出所有停止、运行的容器<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">docker ps -a</div><div class="line">CONTAINER ID        IMAGE               COMMAND             CREATED             STATUS              PORTS               NAMES</div><div class="line">fd74d17e54f1        ubuntu:16.04        &quot;/bin/bash&quot;         2 minutes ago       Up 2 minutes                            docker_test</div></pre></td></tr></table></figure></p>
<ul>
<li>查看容器进程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker top docker_test</div></pre></td></tr></table></figure>
<ul>
<li>深入容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 获取更加详细的 docker 信息</div><div class="line">docker inspect docker_test</div></pre></td></tr></table></figure>
<ul>
<li>启动、重启、连接容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">//启动</div><div class="line">docker start docker_test</div><div class="line"></div><div class="line">//停止</div><div class="line">docker stop docker_test</div><div class="line"></div><div class="line">// 杀死</div><div class="line">docker stop docker_test</div><div class="line"></div><div class="line">// 连接</div><div class="line">docker sttach docker_test</div></pre></td></tr></table></figure>
<ul>
<li>在容器内部运行进程</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// -d 表明在后台运行一个进程</div><div class="line">docker exec -d docker_test touch /etc/new_config_file</div><div class="line"></div><div class="line">// 打开一个交互性的shell</div><div class="line">docker exec -i -t docker_test /bin/bash</div></pre></td></tr></table></figure>
<ul>
<li>查看容器输出</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">//到目前为止收集的输出</div><div class="line">docker logs docker_test</div><div class="line">//使用-f 可以监控docker输出</div><div class="line">docker logs -f docker_test</div><div class="line">//加上tail 命令可以查看某段输出，如最后10行</div><div class="line">docker log --tail 10 docker_tet</div><div class="line">//使用 -t 可以在每条日志加上时间戳</div><div class="line">docker log -ft docker_test</div></pre></td></tr></table></figure>
<ul>
<li>保存容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// docker commit id new_image_name</div><div class="line">docker commit 2194cf55f5ea docker_test</div></pre></td></tr></table></figure>
<ul>
<li>删除容器</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 所有容器</div><div class="line">docker rm `docker ps -a -q`</div><div class="line">// 指定容器</div><div class="line">docker rm name/id</div></pre></td></tr></table></figure>
<ul>
<li>查看容器被修改的文件或目录</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker diff docker_test</div></pre></td></tr></table></figure>
<ul>
<li>拷贝文件</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker cp [name|id]:container_path  local_path</div></pre></td></tr></table></figure>
<h2 id="保存和加载镜像"><a href="#保存和加载镜像" class="headerlink" title="保存和加载镜像"></a>保存和加载镜像</h2><ul>
<li>保存镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker save image_name -o file_path</div></pre></td></tr></table></figure>
<ul>
<li>加载本地镜像</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">docker load -i file_path</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://czero000.github.io/2016/10/20/rudiments-of-docker.html" data-id="civlqiudb00goc15m4h4nk8z0" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/docker/">docker</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ansible-playbook" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/19/ansible-playbook.html" class="article-date">
  <time datetime="2016-10-19T06:41:10.000Z" itemprop="datePublished">2016-10-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运维自动化/">运维自动化</a>►<a class="article-category-link" href="/categories/运维自动化/Ansible/">Ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/19/ansible-playbook.html">Ansible-Playbooks</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="Playbooks"><a href="#Playbooks" class="headerlink" title="Playbooks"></a>Playbooks</h1><p>Playbooks 是 Ansible 的配置、部署、编排语言，相当于控制远程主机的一系列命令的集合，通过 YAML 语言编写。Ansible-Playbook 命令根据自上而写的顺序依次执行。 Playbook 允许传输摸个命令的状态到后面的指令，或者从一台主机的文件中获取内容并赋值变量，然后传给另外一台主机使用，这是 ansible 命令无法实现的。</p>
<h2 id="YAML-语法介绍"><a href="#YAML-语法介绍" class="headerlink" title="YAML 语法介绍"></a>YAML 语法介绍</h2><h3 id="文件开始符"><a href="#文件开始符" class="headerlink" title="文件开始符"></a>文件开始符</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">---</div></pre></td></tr></table></figure>
<h3 id="数组列表"><a href="#数组列表" class="headerlink" title="数组列表"></a>数组列表</h3><p>列表中的所有成员都开始于相同缩进级别，并使用 <code>-</code> 来作为开头<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- Apple</div><div class="line">- Orange</div><div class="line">- Mango</div></pre></td></tr></table></figure></p>
<h3 id="字典"><a href="#字典" class="headerlink" title="字典"></a>字典</h3><p>字典是有一个简单的 <code>Key: value</code> 形式组成，注意 <code>:</code> 后面有<strong>空格</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">name: charlie</div><div class="line">job: Developer</div><div class="line">mail: charlie.cui127@gmail.com</div></pre></td></tr></table></figure></p>
<p>在 playbook 中会有更为复杂的用法</p>
<ul>
<li>字典与字典嵌套</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">martin:</div><div class="line">    name: Martin D&apos;vloper</div><div class="line">    job: Developer</div><div class="line">    skill: Elite</div></pre></td></tr></table></figure>
<ul>
<li>字典与数组的嵌套</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">-  martin:</div><div class="line">    name: Martin D&apos;vloper</div><div class="line">    job: Developer</div><div class="line">    skills:</div><div class="line">      - python</div><div class="line">      - perl</div><div class="line">      - pascal</div><div class="line">-  tabitha:</div><div class="line">    name: Tabitha Bitumen</div><div class="line">    job: Developer</div><div class="line">    skills:</div><div class="line">      - lisp</div><div class="line">      - fortran</div><div class="line">      - erlang</div></pre></td></tr></table></figure>
<p>注意，如果变量里有 <code>:</code>,则需要加引号<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">foo: &quot;&#123;&#123; variable &#125;&#125;&quot;</div></pre></td></tr></table></figure></p>
<h1 id="Playbook-基本用法"><a href="#Playbook-基本用法" class="headerlink" title="Playbook 基本用法"></a>Playbook 基本用法</h1><p>最基本的 playbook 分为三部分：</p>
<ol>
<li>在什么机器上以什么身份执行<ul>
<li>hosts</li>
<li>users</li>
</ul>
</li>
<li>定义 playbook 执行需要的变量<ul>
<li>variable</li>
</ul>
</li>
<li>执行的任务是都有什么<ul>
<li>tasks</li>
</ul>
</li>
<li>善后的任务是什么<ul>
<li>handlers  </li>
</ul>
</li>
</ol>
<p><strong>执行 Playbook</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// 执行playbook</div><div class="line">Ansible-playbook user.yaml</div><div class="line"></div><div class="line">// 查看详细输出</div><div class="line">ansible-playbook user.yaml --list-hosts</div></pre></td></tr></table></figure>
<h2 id="示例"><a href="#示例" class="headerlink" title="示例"></a>示例</h2><h3 id="官方示例"><a href="#官方示例" class="headerlink" title="官方示例"></a>官方示例</h3><p>要学习更多的 playbook 用法，可以通过<a href="http://github.com/ansible/ansible-examples" target="_blank" rel="external">Playbooks 官方示例</a>。</p>
<h3 id="Playbook-分享平台"><a href="#Playbook-分享平台" class="headerlink" title="Playbook 分享平台"></a>Playbook 分享平台</h3><p>Ansible 提供了一个 Playbook 的分享平台，上面的例子是有 Ansible 使用者自己上传的。<br><a href="http://galaxy.ansible.com/" target="_blank" rel="external">Ansible分享平台</a></p>
<h3 id="简单示例"><a href="#简单示例" class="headerlink" title="简单示例"></a>简单示例</h3><ul>
<li>创建用户</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 新增一个用户</div><div class="line">cat user.yaml</div><div class="line">---</div><div class="line">- name: create user           </div><div class="line">  hosts: all                \\ host or group</div><div class="line">  user: root</div><div class="line">  gather_facts: false</div><div class="line">  vars:                     \\ variable</div><div class="line">  - user: &quot;charlie&quot;</div><div class="line">  tasks:                     \\ tasks</div><div class="line">  - name: create user</div><div class="line">    user: name= &quot;&#123;&#123; user &#125;&#125;&quot;</div><div class="line">    notify: create user ok</div><div class="line">  handlers:</div><div class="line">    - name: create user ok</div><div class="line">      debug: msg= &quot;Create User OK&quot;</div></pre></td></tr></table></figure>
<ol>
<li>name 参数对该 playbook 实现功能的一个概述，后面执行过程中会打印 name 变量值</li>
<li>hosts 参数指定了那些主机</li>
<li>user 参数执行了使用什么用户登陆远程主机</li>
<li>gather_facts 参数指定了下面任务执行前，是否先执行 setup 模块获取主机相关信息，这些后面 task 会使用 setup 获取的信息</li>
<li>vars 参数指定了变量， 变量 user，值为 charlie，值得注意的是参数要用引号</li>
<li>task 指定了一个任务，下面的 name 参数同样是对任务的描述，在执行过程中打印出来。user 指定了调用 user模块，name 是user模块中的参数，增加的用户名是上面 user 的值</li>
</ol>
<p>执行结果<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">ansible-playbook user.yaml</div><div class="line">PLAY [create user] *************************************************************</div><div class="line"></div><div class="line">TASK [create user] *************************************************************</div><div class="line">changed: [172.16.11.210]</div><div class="line">changed: [172.16.11.211]</div><div class="line"></div><div class="line">RUNNING HANDLER [create user] **************************************************</div><div class="line">ok: [172.16.11.210] =&gt; &#123;</div><div class="line">    &quot;msg&quot;: &quot;Create User OK&quot;</div><div class="line">&#125;</div><div class="line">ok: [172.16.11.211] =&gt; &#123;</div><div class="line">    &quot;msg&quot;: &quot;Create User OK&quot;</div><div class="line">&#125;</div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">172.16.11.210              : ok=1    changed=1    unreachable=0    failed=0   </div><div class="line">172.16.11.211              : ok=1    changed=1    unreachable=0    failed=0</div></pre></td></tr></table></figure></p>
<ul>
<li>安装apache</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">cat apache.yaml</div><div class="line">---</div><div class="line">- hosts: all</div><div class="line"> vars:</div><div class="line">   http_port: 80</div><div class="line">   max_clients: 2048</div><div class="line"> user: root</div><div class="line"> tasks:</div><div class="line"> - name: ensure apache is at latest version</div><div class="line">   yum: pkg=httpd state=latest</div><div class="line"> - name: write the apache config file</div><div class="line">   template: src=/srv/httpd.j2 dest=/etc/httpd.conf</div><div class="line">   notify:</div><div class="line">   - restart apache</div><div class="line"> - name: ensure apache is running</div><div class="line">   service: name=httpd state=started</div><div class="line"> handlers:</div><div class="line">   - name: restart apache</div><div class="line">     service: name=httpd state=restarted</div></pre></td></tr></table></figure>
<h2 id="主机和用户-Host-and-User"><a href="#主机和用户-Host-and-User" class="headerlink" title="主机和用户 Host and User"></a>主机和用户 Host and User</h2><p>在执行 playbook 时，可以选择操作的目标主机是那些，以那个用户执行<br>host 行的内容是一个或多个主机的 patterns， 以逗号分隔<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: 172.16.11.210, 172.16.11.211, [all]</div><div class="line">  remote_user: root</div></pre></td></tr></table></figure></p>
<p>还可以在每个 task 中，定义远程执行用户<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: all</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">  - name: test connection</div><div class="line">    ping:</div><div class="line">    remote_user: root</div></pre></td></tr></table></figure></p>
<p>也支持 sudo 方法,在 task中同样支持,在 sudo 需要密码时，可以加上选项 –ask-sudo-pass<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: all</div><div class="line">  remote_user: charlie</div><div class="line">  sudo: yes</div><div class="line">  task：</div><div class="line">    - service： name=nginx state=started</div><div class="line">      sudo: yes</div><div class="line">      sudo_user: root</div></pre></td></tr></table></figure></p>
<h2 id="任务列表-Tasks"><a href="#任务列表-Tasks" class="headerlink" title="任务列表 Tasks"></a>任务列表 Tasks</h2><ul>
<li>tasks 是从上到下顺序执行，如果中间发生错误，整个 playbook 便会中断。</li>
<li>每一个 task 是对module的一次调用,通常会带有特定参数，参数可以使用变量。</li>
<li>每一个 task 必须有一个 name 属性，name 值会在命令行中输出，以提示用户，如果没有定义，aciton 的值会作为输出信息来标记task</li>
</ul>
<h3 id="语法"><a href="#语法" class="headerlink" title="语法"></a>语法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">tasks:</div><div class="line">  - name: make sure apache is running</div><div class="line">    service: name=httpd state=running</div><div class="line"></div><div class="line">// 如果参数过长，可以使用空格或者缩进分隔为多行</div><div class="line">tasks:</div><div class="line">  - name: copy ansible inventory file to client</div><div class="line">    copy: src=/etc/ansible/hosts dest=/etc/ansible/hosts</div><div class="line">          owner=root group=root mode=0644</div><div class="line"></div><div class="line">// 或者使用 yaml 的字典作为参数</div><div class="line">tasks:</div><div class="line">  - name: copy ansible inventory file to client</div><div class="line">    copy:</div><div class="line">      src: /etc/ansible/hosts</div><div class="line">      dest: /etc/ansible/hosts</div><div class="line">      owner: root</div><div class="line">      group: root</div><div class="line">      mode: 0644</div><div class="line"></div><div class="line">// 大部分的模块都是使用 `key-value` 这种格式的，其中有两个比较特殊，command 和 shell 模块。</div><div class="line">tasks:</div><div class="line">  - name: disable selinux</div><div class="line">    command: /sbin/setenforce 0</div><div class="line">tasks:</div><div class="line">  - name: run this command and ignore the result</div><div class="line">    shell: /usr/bin/command || /bin/true</div><div class="line">tasks:</div><div class="line">  - name: run some command and ignore the reslut</div><div class="line">    shell: /usr/bin/somecommadn</div><div class="line">    ignore_error: True</div></pre></td></tr></table></figure>
<h3 id="执行状态"><a href="#执行状态" class="headerlink" title="执行状态"></a>执行状态</h3><p>task 中每个 action 会调用一个 module，在 module 中会去检查当前系统状态是否需要重新执行，具体判断需要有各个 module 自己来实现。</p>
<ul>
<li>如果执行那么 action 会得到返回值 changed；</li>
<li>如果部执行，那么 action 会得到返回值 OK</li>
</ul>
<p><strong>状态实例 以一个 copy 文件为例</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">// playbook</div><div class="line">copy.yaml                 </div><div class="line">---</div><div class="line">- name: copy a test file</div><div class="line">  hosts: all</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">    - name: copy a test file to /opt/ansible</div><div class="line">      copy: src=/opt/ansible/test.txt dest=/opt/ansible/</div><div class="line"></div><div class="line">// 第一次执行结果</div><div class="line">ansible-playbook copy.yaml</div><div class="line">PLAY [copy a test file] ********************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [172.16.11.211]</div><div class="line">ok: [172.16.11.210]</div><div class="line"></div><div class="line">TASK [copy a test file to /opt/ansible] ****************************************</div><div class="line">changed: [172.16.11.210]</div><div class="line">changed: [172.16.11.211]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">172.16.11.210              : ok=2    changed=1    unreachable=0    failed=0   </div><div class="line">172.16.11.211              : ok=2    changed=1    unreachable=0    failed=0   </div><div class="line"></div><div class="line">// 第二次执行结果</div><div class="line">ansible-playbook copy.yaml</div><div class="line"></div><div class="line">PLAY [copy a test file] ********************************************************</div><div class="line"></div><div class="line">TASK [setup] *******************************************************************</div><div class="line">ok: [172.16.11.211]</div><div class="line">ok: [172.16.11.210]</div><div class="line"></div><div class="line">TASK [copy a test file to /opt/ansible] ****************************************</div><div class="line">ok: [172.16.11.210]</div><div class="line">ok: [172.16.11.211]</div><div class="line"></div><div class="line">PLAY RECAP *********************************************************************</div><div class="line">172.16.11.210              : ok=2    changed=0    unreachable=0    failed=0   </div><div class="line">172.16.11.211              : ok=2    changed=0    unreachable=0    failed=0</div></pre></td></tr></table></figure></p>
<p>可以看到第一次 task的状态是 changed 状态，第二次再次执行，task 状态是 OK，说明文件已经存在，避免 ansible 再次重复执行。</p>
<h2 id="响应事件-Handler"><a href="#响应事件-Handler" class="headerlink" title="响应事件 Handler"></a>响应事件 Handler</h2><h3 id="什么是-handler"><a href="#什么是-handler" class="headerlink" title="什么是 handler"></a>什么是 handler</h3><p>每个主流的变成语言都会有 event 机制，那么 handler 就是 playbook 的 event。Handler 里面的每个 handler，也是对 module 的一次调用。不同的是 handler 不会默认的按照顺序执行。<br>Tasks 中的任务是有状态的，changed 或者 ok。 在 Ansible 中，只有 task 的执行状态为 changed 时，才会触发，这就是 handler。</p>
<h3 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h3><p>如果在 tasks 中修改了某个服务的配置文件，就需要重新启动服务，重新启动服务就可以设计成为一个 handler</p>
<h3 id="触发Handlers"><a href="#触发Handlers" class="headerlink" title="触发Handlers"></a>触发Handlers</h3><p><strong>只有 action 是 changed 时，才会执行 handler</strong></p>
<ul>
<li>第一次执行时，tasks 的状态是 changed， 回触发 handler</li>
<li>第二次执行时，task 的状态是 OK， 那么就不会触发 handler</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div></pre></td><td class="code"><pre><div class="line">// 一个 handler 最多被执行一次,在任务执行中，有多个 task notify 同一个 handler， 那么只执行一次</div><div class="line">---</div><div class="line">- name: handler state</div><div class="line">  hosts: all</div><div class="line">  remote_user: root</div><div class="line">  vars:</div><div class="line">    random_number1: &quot;&#123;&#123; 10 | random &#125;&#125;&quot;</div><div class="line">    random_number2: &quot;&#123;&#123; 100 | random &#125;&#125;&quot;</div><div class="line">  tasks:</div><div class="line">  - name: Copy the /etc/hosts to /opt/ansible/host.&#123;&#123; random_number1 &#125;&#125;</div><div class="line">    copy: src=/etc/hosts dest=/opt/ansible/host.&#123;&#123; random_number1 &#125;&#125;</div><div class="line">    notify:</div><div class="line">      - call in every action</div><div class="line">  - name: Copy the /etc/hosts to /opt/ansible/host.&#123;&#123; random_number2 &#125;&#125;</div><div class="line">    copy: src=/etc/hosts dest=/opt/ansible/host.&#123;&#123; random_number2 &#125;&#125;</div><div class="line">    notify:</div><div class="line">      - call in every action</div><div class="line">  handlers:</div><div class="line">    - name: call in every action</div><div class="line">      debug: msg=&apos;call in every action, but execute only one time&apos;</div><div class="line"></div><div class="line">// 按照 handler 的定义顺序执行,handlers 是按照在 handlers 中定义的顺序执行的， 而不是按照 notify 的顺序执行的</div><div class="line">// notify 的定义顺序是 3 &gt; 2 &gt; 1，而实际 handler 结果是 handler 定义的顺序 1 &gt; 2 &gt; 3。</div><div class="line">cat handler_notify.yaml                 </div><div class="line">---</div><div class="line">- hosts: all</div><div class="line">  gather_facts: no</div><div class="line">  remote_user: root</div><div class="line">  vars:</div><div class="line">    random_number1: &quot;&#123;&#123; 10 | random &#125;&#125;&quot;</div><div class="line">    random_number2: &quot;&#123;&#123; 100 | random &#125;&#125;&quot;</div><div class="line">    random_number3: &quot;&#123;&#123; 1000 | random &#125;&#125;&quot;</div><div class="line">  tasks:</div><div class="line">    - name: copy the /ets/hosts to /tmp/hosts.&#123;&#123; random_number1 &#125;&#125;</div><div class="line">      copy: src=/etc/hosts dest=/tmp/hosts.&#123;&#123; random_number1 &#125;&#125;</div><div class="line">      notify:</div><div class="line">        - define the 3nd handler</div><div class="line"></div><div class="line">    - name: copy the /ets/hosts to /tmp/hosts.&#123;&#123; random_number2 &#125;&#125;</div><div class="line">      copy: src=/etc/hosts dest=/tmp/hosts.&#123;&#123; random_number2 &#125;&#125;</div><div class="line">      notify:</div><div class="line">        - define the 2nd handler</div><div class="line"></div><div class="line">    - name: copy the /ets/hosts to /tmp/hosts.&#123;&#123; random_number3 &#125;&#125;</div><div class="line">      copy: src=/etc/hosts dest=/tmp/hosts.&#123;&#123; random_number3 &#125;&#125;</div><div class="line">      notify:</div><div class="line">        - define the 1nd handler</div><div class="line">  handlers:</div><div class="line">    - name: define the 1nd handler</div><div class="line">      debug: msg=&quot; defind the 1nd handler&quot;</div><div class="line"></div><div class="line">    - name: define the 2nd handler</div><div class="line">      debug: msg=&quot; defind the 2nd handler&quot;</div><div class="line"></div><div class="line">    - name: define the 3nd handler</div><div class="line">      debug: msg=&quot; defind the 3nd handler&quot;</div></pre></td></tr></table></figure>
<h1 id="playbook-roles-和-include"><a href="#playbook-roles-和-include" class="headerlink" title="playbook roles 和 include"></a>playbook roles 和 include</h1><p>在刚开始使用 playbook 时，习惯性会把 playbook 写成一个很大的文件，然而在实际情况下， 有些文件是可以重用的。playbook 可以使用 include，把其他 playbook 文件中的 variables、tasks 或者 handlers 从其他文件拉取过来。</p>
<h2 id="规划目录组织结构"><a href="#规划目录组织结构" class="headerlink" title="规划目录组织结构"></a>规划目录组织结构</h2><p>通过目录规格，可以使 playbook 模块化，使代码易读、可以重用、层次清晰。</p>
<p>可以通过 <code>ansible-galaxy</code> 工具，初始化一个 role 目录<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div></pre></td><td class="code"><pre><div class="line">// init</div><div class="line">ansible-galaxy init httpd</div><div class="line"></div><div class="line">// tree</div><div class="line">.</div><div class="line">├── defaults</div><div class="line">│   └── main.yml</div><div class="line">├── files</div><div class="line">├── handlers</div><div class="line">│   └── main.yml</div><div class="line">├── meta</div><div class="line">│   └── main.yml</div><div class="line">├── README.md</div><div class="line">├── tasks</div><div class="line">│   └── main.yml</div><div class="line">├── templates</div><div class="line">├── tests</div><div class="line">│   ├── inventory</div><div class="line">│   └── test.yml</div><div class="line">└── vars</div><div class="line">    └── main.yml</div></pre></td></tr></table></figure></p>
<h2 id="include-语句"><a href="#include-语句" class="headerlink" title="include 语句"></a>include 语句</h2><h3 id="普通用法"><a href="#普通用法" class="headerlink" title="普通用法"></a>普通用法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 可以像其他 include 语句一样， 直接include</div><div class="line"># possibly saved as tasks/firewall_httpd_default.yaml</div><div class="line">- name: insert firewalld rule for httpd</div><div class="line">  firewalld: port=80/tcp permanent=true state=enable immediate=yes</div><div class="line"></div><div class="line">// main.yml</div><div class="line">tasks:</div><div class="line">  - include: tasks/firewall_httpd_default.yml</div></pre></td></tr></table></figure>
<h3 id="高级用法，传递参数"><a href="#高级用法，传递参数" class="headerlink" title="高级用法，传递参数"></a>高级用法，传递参数</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 添加参数</div><div class="line">tasks:</div><div class="line">  - include: tasks/firewall.yml port=80</div><div class="line">  - include: tasks/firewall.yml port=3306</div><div class="line"></div><div class="line">//  支持结构化</div><div class="line">tasks:</div><div class="line">  - include: tasks/firewall.yml</div><div class="line">    vars:</div><div class="line">      wp_user: charlie</div><div class="line">      ssh_key:</div><div class="line">        - key/one.txt</div><div class="line">        - key/two.txt</div><div class="line">// json格式</div><div class="line">tasks:</div><div class="line">  - &#123; include: wordpress.yml, wp_user: timmy, ssh_keys: [ &apos;key/one.txt&apos;, &apos;key/two.txt&apos; ] &#125;</div></pre></td></tr></table></figure>
<h3 id="在-handlers-section-中定义"><a href="#在-handlers-section-中定义" class="headerlink" title="在 handlers section 中定义"></a>在 handlers section 中定义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">// handlers.yml</div><div class="line">// this might be in a file line handlers/handlers.yml</div><div class="line">- name: restart apache</div><div class="line">  service: name = apache state=restarted</div><div class="line">// 在一个 playbook 中引用 handlers.yml</div><div class="line">handlers:</div><div class="line">  - include: handlers/handlers.yml</div></pre></td></tr></table></figure>
<p>include 语句可以和其他非 include 的 tasks 和 handlers 混合使用。</p>
<p><strong>例如：</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">- name: this is a play at the top level of a file</div><div class="line">  host: all</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">    - name: say hi</div><div class="line">      tags: foo</div><div class="line">      shell: echo &quot;Hi &quot;</div><div class="line">- include: load_balancers.yml</div><div class="line">- include: webservers.yml</div><div class="line">- include: dbservers.yml</div></pre></td></tr></table></figure></p>
<h2 id="Roles"><a href="#Roles" class="headerlink" title="Roles"></a>Roles</h2><p>Ansible 中还有一个比 include 更为强大的代码重用机制，那就是roles！。Roles 基于一个已知的文件结构，去自动加载某些 var_files, tasks, handlers，基于 roles 对内容进行分组，更有利于与其他用户分享 roles。<br>Ansible提供了一个分享role的平台, <a href="http://galaxy.ansible.com/" target="_blank" rel="external">http://galaxy.ansible.com/</a>, 在galaxy上可以找到别人写好的role.</p>
<h3 id="Roled的目录结构"><a href="#Roled的目录结构" class="headerlink" title="Roled的目录结构"></a>Roled的目录结构</h3><p>在 ansible 中，通过遵循特定的目录结构，可以实现对 role 的定义。下面的目录结构是定义了两个 role， 一个名字是 common，另外一个是 webserver，并在 site.yml 中调用这两个 role。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line">// role 的目录结构</div><div class="line">site.yml</div><div class="line">webservers.yml</div><div class="line">fooservers.yml</div><div class="line">roles/</div><div class="line">   common/</div><div class="line">     files/</div><div class="line">     templates/</div><div class="line">     tasks/</div><div class="line">     handlers/</div><div class="line">     vars/</div><div class="line">     defaults/</div><div class="line">     meta/</div><div class="line">   webservers/</div><div class="line">     files/</div><div class="line">     templates/</div><div class="line">     tasks/</div><div class="line">     handlers/</div><div class="line">     vars/</div><div class="line">     defaults/</div><div class="line">     meta/</div><div class="line"></div><div class="line">// site.yml 中使用</div><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  roles:</div><div class="line">    - common</div><div class="line">    - webservers</div></pre></td></tr></table></figure></p>
<h3 id="使用带参数的-role"><a href="#使用带参数的-role" class="headerlink" title="使用带参数的 role"></a>使用带参数的 role</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  roles:</div><div class="line">    - common</div><div class="line">    - &#123; role: foo_app_instance, dir: &apos;/opt/a&apos;, port: 5000 &#125;</div><div class="line">    - &#123; role: foo_app_instance, dir: &apos;/opt/b&apos;, port: 5001 &#125;</div><div class="line">// 设置触发条件,条件语句应用到 role 中的每个 task上。</div><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  roles:</div><div class="line">    - &#123; role: some_role, when: &quot;ansible_os_family == &apos;RedHat&apos;&quot; &#125;</div><div class="line">// 分配 tags</div><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  roles:</div><div class="line">    - &#123; role: foo, tags: [ &quot;bar&quot; , &quot;baz&quot; ] &#125;</div></pre></td></tr></table></figure>
<h3 id="指定默认的参数"><a href="#指定默认的参数" class="headerlink" title="指定默认的参数"></a>指定默认的参数</h3><p>在指定默认参数后，如果在调用时传参数，那么就使用传入的参数值，否则使用默认参数。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">//指定默认参数</div><div class="line">main.yml</div><div class="line">roles:</div><div class="line">  role_with_var</div><div class="line">    tasks:</div><div class="line">      main.yml</div><div class="line">    vars:</div><div class="line">      main.yml</div><div class="line">// roles/role_with_var/vars/main.yml</div><div class="line">param: &quot;I am the default value&quot;</div></pre></td></tr></table></figure></p>
<h3 id="与条件语句一起执行"><a href="#与条件语句一起执行" class="headerlink" title="与条件语句一起执行"></a>与条件语句一起执行</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">//定义只有在 RedHat 系列才执行的 role</div><div class="line">---</div><div class="line">- host: webservers</div><div class="line">  roles:</div><div class="line">    - &#123; role: some_role, when: &quot;ansible_os_family == &apos;RedHat&apos;&quot; &#125;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://czero000.github.io/2016/10/19/ansible-playbook.html" data-id="civlqiu5v002wc15mi81dygxp" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/">ansible</a></li></ul>

    </footer>
  </div>
  
</article>


  
    <article id="post-ansible-variable" class="article article-type-post" itemscope itemprop="blogPost">
  <div class="article-meta">
    <a href="/2016/10/19/ansible-variable.html" class="article-date">
  <time datetime="2016-10-19T06:38:32.000Z" itemprop="datePublished">2016-10-19</time>
</a>
    
  <div class="article-category">
    <a class="article-category-link" href="/categories/运维自动化/">运维自动化</a>►<a class="article-category-link" href="/categories/运维自动化/Ansible/">Ansible</a>
  </div>

  </div>
  <div class="article-inner">
    
    
      <header class="article-header">
        
  
    <h1 itemprop="name">
      <a class="article-title" href="/2016/10/19/ansible-variable.html">Ansible--变量使用</a>
    </h1>
  

      </header>
    
    <div class="article-entry" itemprop="articleBody">
      
        <h1 id="变量"><a href="#变量" class="headerlink" title="变量"></a>变量</h1><p>自动化技术使得重复做事变的更加容易，当系统有所不同，Ansible 可以是使用相同的 template，通过变量来处理不同系统。<br>Ansible 的变量名称可以以 <strong><code>字母、数字和下划线</code></strong> 命名，变量开头要以 <strong>字母开头</strong></p>
<ul>
<li>在 inventory 中定义变量</li>
</ul>
<p>可以参考 「Ansible–入门」 inventory 章节介绍</p>
<ul>
<li>在 playbook 中定义变量</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">- hosts: web</div><div class="line">  vars:</div><div class="line">    http_port: 80</div></pre></td></tr></table></figure>
<h2 id="使用变量"><a href="#使用变量" class="headerlink" title="使用变量"></a>使用变量</h2><p>在 template 语言 jinjia2 的语法引用，利用中括号和点号来访问子属性<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">foo[&apos;field1&apos;]</div><div class="line">foo.field2</div></pre></td></tr></table></figure></p>
<h2 id="在-playbook-中使用变量"><a href="#在-playbook-中使用变量" class="headerlink" title="在 playbook 中使用变量"></a>在 playbook 中使用变量</h2><p>在 playbook 中使用，需要用两个大括号引用即可</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  vars:</div><div class="line">    apache_config: labs.conf</div><div class="line">  tasks:</div><div class="line">    - name: deploy haproxy config</div><div class="line">      template: src=&#123;&#123; apache_config &#125;&#125; dest=/etc/httpd/conf.d/&#123;&#123; apache_config &#125;&#125;</div></pre></td></tr></table></figure>
<p>在 playbook 中使用变量文件定义变量<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  vars_files:</div><div class="line">    - vars/server_vars.yml</div><div class="line">  tasks:</div><div class="line">    - name: deploy haproxy config</div><div class="line">      template: src=&#123;&#123; apache_config &#125;&#125; dest=/etc/httpd/conf.d/&#123;&#123; apache_config &#125;&#125;</div></pre></td></tr></table></figure></p>
<p>变量文件 <code>vars/server_vars.yml</code> 内容<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">apache_config: labs.conf</div></pre></td></tr></table></figure></p>
<h3 id="YAML-陷阱"><a href="#YAML-陷阱" class="headerlink" title="YAML 陷阱"></a>YAML 陷阱</h3><p>YAML 语法要求如果值以 <code></code> 开头，需要讲整行用双引号扩起来，为了确保你不是在声明一个字典。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// 错误</div><div class="line">---</div><div class="line">- hosts: app_servers</div><div class="line">  vars:</div><div class="line">    app_path: &#123;&#123; base_path &#125;&#125;/22</div><div class="line">// 正确</div><div class="line">---</div><div class="line">- hosts: app_servers</div><div class="line">  vars:</div><div class="line">    app_path: &quot;&#123;&#123; base_path &#125;&#125;/22&quot;</div></pre></td></tr></table></figure></p>
<h2 id="使用-Facts-获取主机系统变量"><a href="#使用-Facts-获取主机系统变量" class="headerlink" title="使用 Facts 获取主机系统变量"></a>使用 Facts 获取主机系统变量</h2><p>Ansible 可以通过 module_setup 收集远程主机的系统信息–facts，通过 facts 收集的信息，可以以变量形式来使用。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">ansible all -m setup</div></pre></td></tr></table></figure></p>
<h3 id="在-playbook-中使用-facts-变量"><a href="#在-playbook-中使用-facts-变量" class="headerlink" title="在 playbook 中使用 facts 变量"></a>在 playbook 中使用 facts 变量</h3><p>命令会返回海量的变量数据，这些变量可以在 playbook 中直接使用<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: all</div><div class="line">  name: install some package</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">    - name: echo system</div><div class="line">      shell: echo &#123;&#123; ansible_os_family &#125;&#125;</div><div class="line">    - name: install Git on RedHat</div><div class="line">      yum: name=git state=present</div><div class="line">      when: ansible_os_family == &quot;RedHat&quot;</div><div class="line">    - name: install Git on Debian</div><div class="line">      apt: name=git state=installed</div><div class="line">      when: ansible_os_family == &quot;Debian&quot;</div></pre></td></tr></table></figure></p>
<h3 id="使用复杂的-facts-变量"><a href="#使用复杂的-facts-变量" class="headerlink" title="使用复杂的 facts 变量"></a>使用复杂的 facts 变量</h3><p>使用通过 fact 收集到复杂的、多层次的变量。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">&quot;ansible_eth1&quot;: &#123;</div><div class="line">            &quot;active&quot;: true,</div><div class="line">            &quot;device&quot;: &quot;eth1&quot;,</div><div class="line">            &quot;ipv4&quot;: &#123;</div><div class="line">                &quot;address&quot;: &quot;172.16.11.210&quot;,</div><div class="line">                &quot;broadcast&quot;: &quot;172.16.11.255&quot;,</div><div class="line">                &quot;netmask&quot;: &quot;255.255.255.0&quot;,</div><div class="line">                &quot;network&quot;: &quot;172.16.11.0&quot;</div><div class="line">            &#125;,</div><div class="line">            &quot;ipv6&quot;: [</div><div class="line">                &#123;</div><div class="line">                    &quot;address&quot;: &quot;fe80::5054:ff:fec0:b2b3&quot;,</div><div class="line">                    &quot;prefix&quot;: &quot;64&quot;,</div><div class="line">                    &quot;scope&quot;: &quot;link&quot;</div><div class="line">                &#125;</div><div class="line">            ],</div><div class="line">            &quot;macaddress&quot;: &quot;52:54:00:c0:b2:b3&quot;,</div><div class="line">            &quot;module&quot;: &quot;virtio_net&quot;,</div><div class="line">            &quot;mtu&quot;: 1500,</div><div class="line">            &quot;pciid&quot;: &quot;virtio1&quot;,</div><div class="line">            &quot;promisc&quot;: false,</div><div class="line">            &quot;type&quot;: &quot;ether&quot;</div><div class="line">        &#125;,</div></pre></td></tr></table></figure></p>
<p>可以通过下面两种方式访问到复杂变量的自变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">// 中括号</div><div class="line">&#123;&#123; ansible_eth1[&quot;ipv4&quot;][&quot;address&quot;] &#125;&#125;</div><div class="line">// 点号</div><div class="line">&#123;&#123; ansible_eth1.ipv4.address &#125;&#125;</div></pre></td></tr></table></figure>
<h3 id="关闭facts"><a href="#关闭facts" class="headerlink" title="关闭facts"></a>关闭facts</h3><p>在 playbook 中， 可以设置是否启用 gather_facts 来获取远程系统信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  gather_facts: no</div></pre></td></tr></table></figure></p>
<h3 id="使用被控端自定义变量"><a href="#使用被控端自定义变量" class="headerlink" title="使用被控端自定义变量"></a>使用被控端自定义变量</h3><p>在被控端可以在 <code>/etc/ansible/facts.d</code> 目录中，任何以 <code>.fact</code> 结尾的文件都可以在 Ansible 提供局部 facts。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">//定义 /etc/ansible/facts.d/perferences.fact 文件</div><div class="line">[general]</div><div class="line">abcd=1</div><div class="line">bcde=2</div><div class="line"></div><div class="line">// 主控端获取变量</div><div class="line">172.16.11.210 | SUCCESS =&gt; &#123;</div><div class="line">    &quot;ansible_facts&quot;: &#123;</div><div class="line">        &quot;ansible_local&quot;: &#123;</div><div class="line">            &quot;perferences&quot;: &#123;</div><div class="line">                &quot;general&quot;: &#123;</div><div class="line">                    &quot;abcd&quot;: &quot;1&quot;,</div><div class="line">                    &quot;bcde&quot;: &quot;2&quot;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;,</div><div class="line">    &quot;changed&quot;: false</div><div class="line">&#125;</div></pre></td></tr></table></figure></p>
<p>这样就可以在 playbook 中引用变量或者覆盖掉系统的 facts 值<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: all</div><div class="line">  user: root</div><div class="line">  tasks:</div><div class="line">    - name: create directory for ansible custom facts</div><div class="line">      file: state=directory recurse=yes path=/etc/ansible/facts.d/</div><div class="line">    - name: install custom ipmi fact</div><div class="line">      copy: src=/opt/ansible/playbooks/ipmi.fact dest=/etc/ansible/facts.d</div><div class="line">    - name: re-read facts after adding custom fact</div><div class="line">      setup: filter=ansible_local</div></pre></td></tr></table></figure></p>
<h2 id="注册变量"><a href="#注册变量" class="headerlink" title="注册变量"></a>注册变量</h2><p>可以把 tasks 运行结果作为变量，供后面的 action 使用，在运行 playbook 时，可以使用 -v 参数看到结果值，<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: webservers</div><div class="line">  tasks:</div><div class="line">    - shell: /bin/ls</div><div class="line">      register: result</div><div class="line">      ignore_errors: true</div><div class="line">    - shell: /bin/echo &quot;&#123;&#123; result.stdout &#125;&#125;&quot;</div><div class="line">      when: result.rc == 5</div><div class="line">    - debug: msg=&quot;&#123;&#123; result.stdout &#125;&#125;&quot;</div></pre></td></tr></table></figure></p>
<h2 id="在文件模板中使用变量"><a href="#在文件模板中使用变量" class="headerlink" title="在文件模板中使用变量"></a>在文件模板中使用变量</h2><p>Ansible 使用的模本是 python 的一个 jinja2 模板。在 playbook 中定义的变量，可以直接在 template 中使用。</p>
<h3 id="template-变量的定义"><a href="#template-变量的定义" class="headerlink" title="template 变量的定义"></a>template 变量的定义</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div></pre></td><td class="code"><pre><div class="line">// 使用template module来拷贝文件 index.html.j2，并替换 index.html.j2 中的变量为 playbook 中定义的变量。</div><div class="line">---</div><div class="line">- hosts: web</div><div class="line">  vars:</div><div class="line">    http_port: 80</div><div class="line">    defined_name: &quot;Hello My name is Charlie&quot;</div><div class="line">  remote_user: root</div><div class="line">  tasks:</div><div class="line">  - name: ensure apache is at the latest version</div><div class="line">    yum: pkg=httpd state=latest</div><div class="line"></div><div class="line">  - name: Write the configuration file</div><div class="line">    template: src=templates/httpd.conf.j2 dest=/etc/httpd/conf/httpd.conf</div><div class="line">    notify:</div><div class="line">    - restart apache</div><div class="line"></div><div class="line">  - name: Write the default index.html file</div><div class="line">    template: src=templates/index2.html.j2 dest=/var/www/html/index.html</div><div class="line"></div><div class="line">  - name: ensure apache is running</div><div class="line">    service: name=httpd state=started</div><div class="line">  - name: insert firewalld rule for httpd</div><div class="line">    firewalld: port=&#123;&#123; http_port &#125;&#125;/tcp permanent=true state=enabled immediate=yes</div><div class="line"></div><div class="line">  handlers:</div><div class="line">    - name: restart apache</div><div class="line">      service: name=httpd state=restarted</div></pre></td></tr></table></figure>
<h3 id="template-变量的使用"><a href="#template-变量的使用" class="headerlink" title="template 变量的使用"></a>template 变量的使用</h3><p>在 template index.html.j2 中可以直接使用系统变量和用户自定义的变量</p>
<ul>
<li>系统变量 <strong>, </strong></li>
<li>用户自定义变量： <strong></strong></li>
</ul>
<h2 id="命令行中传递变量"><a href="#命令行中传递变量" class="headerlink" title="命令行中传递变量"></a>命令行中传递变量</h2><p>在执行 playbook 命令时可以通过 <code>vars_prompt</code> 和 <code>vars_files</code> 传递变量</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div></pre></td><td class="code"><pre><div class="line">---</div><div class="line">- hosts: &apos;&#123;&#123; hosts &#125;&#125;&apos;</div><div class="line">  remote_user: &apos;&#123;&#123; user &#125;&#125;&apos;</div><div class="line">  tasks:</div><div class="line">    - ....</div><div class="line">// 在命令行中传递参数</div><div class="line">ansible-playbook release.yml --extra-vars &quot;hosts=webservers user=web&quot;</div><div class="line"></div><div class="line">// 使用 JSON 格式传递参数</div><div class="line">ansible-playbook release.yml --extra-vars &quot;&#123;&apos;hosts&apos;:&apos;webservers&apos;, &apos;user&apos;:&apos;web&apos;&#125;&quot;</div><div class="line"></div><div class="line">// 通过文件传递参数</div><div class="line">ansible-playbook release.yml --extra-vars &quot;@vars.json&quot;</div></pre></td></tr></table></figure>

      
    </div>
    <footer class="article-footer">
      <a data-url="http://czero000.github.io/2016/10/19/ansible-variable.html" data-id="civlqiu630035c15m5pkxztf5" class="article-share-link">Share</a>
      
      
  <ul class="article-tag-list"><li class="article-tag-list-item"><a class="article-tag-list-link" href="/tags/ansible/">ansible</a></li></ul>

    </footer>
  </div>
  
</article>


  


  <nav id="page-nav">
    <a class="extend prev" rel="prev" href="/">&laquo; __('prev')</a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><a class="page-number" href="/page/4/">4</a><span class="space">&hellip;</span><a class="page-number" href="/page/21/">21</a><a class="extend next" rel="next" href="/page/3/">__('next') &raquo;</a>
  </nav>
</section>
        
          <aside id="sidebar">
  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Categories</h3>
    <div class="widget">
      <ul class="category-list"><li class="category-list-item"><a class="category-list-link" href="/categories/Blog/">Blog</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/">Database</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Database/MySQL/">MySQL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Database/Redis/">Redis</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Markdown/">Markdown</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Python/">Python</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/">System</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/System/Bash/">Bash</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/CentOS/">CentOS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Command/">Command</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/DNS/">DNS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Debian/">Debian</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Git/">Git</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Gitlab/">Gitlab</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/IPTABLES/">IPTABLES</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/L2TP/">L2TP</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Monitor/">Monitor</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/NFS/">NFS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Other/">Other</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Proxy/">Proxy</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/RRDTOOL/">RRDTOOL</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/System/Security/">Security</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/">Web</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/Web/Apache/">Apache</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/Web/Nginx/">Nginx</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化/">虚拟化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/虚拟化/KVM/">KVM</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维技术/">运维技术</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/运维技术/Docker/">Docker</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维技术/ELK/">ELK</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维技术/GlusterFS/">GlusterFS</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维技术/MooseFS/">MooseFS</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维自动化/">运维自动化</a><ul class="category-list-child"><li class="category-list-item"><a class="category-list-link" href="/categories/运维自动化/Ansible/">Ansible</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维自动化/Cobbler/">Cobbler</a></li><li class="category-list-item"><a class="category-list-link" href="/categories/运维自动化/SaltStack/">SaltStack</a></li></ul></li><li class="category-list-item"><a class="category-list-link" href="/categories/随笔/">随笔</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tags</h3>
    <div class="widget">
      <ul class="tag-list"><li class="tag-list-item"><a class="tag-list-link" href="/tags/Blog/">Blog</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Git/">Git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/HTTP状态码/">HTTP状态码</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/Hexo/">Hexo</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/MooseFS/">MooseFS</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ansible/">ansible</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/apache/">apache</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/awk/">awk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bash/">bash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/bind/">bind</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cacti/">cacti</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/centos/">centos</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chinese/">chinese</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/chromium/">chromium</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/cobbler/">cobbler</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/curl/">curl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/debian/">debian</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/docker/">docker</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/download/">download</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/dropbox/">dropbox</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch/">elasticsearch</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elasticsearch-elk/">elasticsearch.elk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/elk/">elk</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/em1/">em1</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/epel/">epel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/eth0/">eth0</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/fishshell/">fishshell</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/git/">git</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitlab/">gitlab</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gitolite/">gitolite</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glances/">glances</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glibc/">glibc</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/glusterfs/">glusterfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/gpt/">gpt</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/https/">https</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iftop/">iftop</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/inotify/">inotify</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/iptables/">iptables</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kernel/">kernel</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kibana/">kibana</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/kvm/">kvm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/l2tp/">l2tp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logrotate/">logrotate</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logstash/">logstash</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/logstash-forwarder/">logstash-forwarder</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/markdown/">markdown</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/megacli/">megacli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mindmap/">mindmap</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/monitor/">monitor</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mycli/">mycli</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/mysql/">mysql</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nfs/">nfs</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx/">nginx</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/nginx-vim/">nginx.vim</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ntp/">ntp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/openssl/">openssl</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/parted/">parted</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/passwd/">passwd</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php/">php</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/php-fpm/">php-fpm</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/pptp/">pptp</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/proxy/">proxy</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/python/">python</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/raid/">raid</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/redis/">redis</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rrdtool/">rrdtool</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/rsync/">rsync</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/saltstack/">saltstack</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/security/">security</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/servicewrapper/">servicewrapper</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/shadowsocks/">shadowsocks</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/smokeping/">smokeping</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/socks5/">socks5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ss5/">ss5</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/transmission/">transmission</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/ubuntu/">ubuntu</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/virsh/">virsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/vncserver/">vncserver</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/xz/">xz</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/yum/">yum</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/zsh/">zsh</a></li><li class="tag-list-item"><a class="tag-list-link" href="/tags/书写指南/">书写指南</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Tag Cloud</h3>
    <div class="widget tagcloud">
      <a href="/tags/Blog/" style="font-size: 10px;">Blog</a> <a href="/tags/Git/" style="font-size: 10px;">Git</a> <a href="/tags/HTTP状态码/" style="font-size: 10px;">HTTP状态码</a> <a href="/tags/Hexo/" style="font-size: 10px;">Hexo</a> <a href="/tags/MooseFS/" style="font-size: 10px;">MooseFS</a> <a href="/tags/ansible/" style="font-size: 17.5px;">ansible</a> <a href="/tags/apache/" style="font-size: 10px;">apache</a> <a href="/tags/awk/" style="font-size: 11.25px;">awk</a> <a href="/tags/bash/" style="font-size: 18.75px;">bash</a> <a href="/tags/bind/" style="font-size: 11.25px;">bind</a> <a href="/tags/cacti/" style="font-size: 10px;">cacti</a> <a href="/tags/centos/" style="font-size: 12.5px;">centos</a> <a href="/tags/chinese/" style="font-size: 11.25px;">chinese</a> <a href="/tags/chromium/" style="font-size: 10px;">chromium</a> <a href="/tags/cobbler/" style="font-size: 11.25px;">cobbler</a> <a href="/tags/curl/" style="font-size: 10px;">curl</a> <a href="/tags/debian/" style="font-size: 10px;">debian</a> <a href="/tags/docker/" style="font-size: 12.5px;">docker</a> <a href="/tags/download/" style="font-size: 10px;">download</a> <a href="/tags/dropbox/" style="font-size: 10px;">dropbox</a> <a href="/tags/elasticsearch/" style="font-size: 10px;">elasticsearch</a> <a href="/tags/elasticsearch-elk/" style="font-size: 10px;">elasticsearch.elk</a> <a href="/tags/elk/" style="font-size: 12.5px;">elk</a> <a href="/tags/em1/" style="font-size: 10px;">em1</a> <a href="/tags/epel/" style="font-size: 10px;">epel</a> <a href="/tags/eth0/" style="font-size: 10px;">eth0</a> <a href="/tags/fishshell/" style="font-size: 10px;">fishshell</a> <a href="/tags/git/" style="font-size: 13.75px;">git</a> <a href="/tags/gitlab/" style="font-size: 10px;">gitlab</a> <a href="/tags/gitolite/" style="font-size: 10px;">gitolite</a> <a href="/tags/glances/" style="font-size: 10px;">glances</a> <a href="/tags/glibc/" style="font-size: 10px;">glibc</a> <a href="/tags/glusterfs/" style="font-size: 12.5px;">glusterfs</a> <a href="/tags/gpt/" style="font-size: 10px;">gpt</a> <a href="/tags/https/" style="font-size: 10px;">https</a> <a href="/tags/iftop/" style="font-size: 10px;">iftop</a> <a href="/tags/inotify/" style="font-size: 11.25px;">inotify</a> <a href="/tags/iptables/" style="font-size: 10px;">iptables</a> <a href="/tags/kernel/" style="font-size: 10px;">kernel</a> <a href="/tags/kibana/" style="font-size: 10px;">kibana</a> <a href="/tags/kvm/" style="font-size: 10px;">kvm</a> <a href="/tags/l2tp/" style="font-size: 10px;">l2tp</a> <a href="/tags/logrotate/" style="font-size: 10px;">logrotate</a> <a href="/tags/logstash/" style="font-size: 11.25px;">logstash</a> <a href="/tags/logstash-forwarder/" style="font-size: 10px;">logstash-forwarder</a> <a href="/tags/markdown/" style="font-size: 10px;">markdown</a> <a href="/tags/megacli/" style="font-size: 11.25px;">megacli</a> <a href="/tags/mindmap/" style="font-size: 11.25px;">mindmap</a> <a href="/tags/monitor/" style="font-size: 15px;">monitor</a> <a href="/tags/mycli/" style="font-size: 10px;">mycli</a> <a href="/tags/mysql/" style="font-size: 10px;">mysql</a> <a href="/tags/nfs/" style="font-size: 10px;">nfs</a> <a href="/tags/nginx/" style="font-size: 20px;">nginx</a> <a href="/tags/nginx-vim/" style="font-size: 10px;">nginx.vim</a> <a href="/tags/ntp/" style="font-size: 10px;">ntp</a> <a href="/tags/openssl/" style="font-size: 10px;">openssl</a> <a href="/tags/parted/" style="font-size: 10px;">parted</a> <a href="/tags/passwd/" style="font-size: 10px;">passwd</a> <a href="/tags/php/" style="font-size: 10px;">php</a> <a href="/tags/php-fpm/" style="font-size: 10px;">php-fpm</a> <a href="/tags/pptp/" style="font-size: 11.25px;">pptp</a> <a href="/tags/proxy/" style="font-size: 15px;">proxy</a> <a href="/tags/python/" style="font-size: 12.5px;">python</a> <a href="/tags/raid/" style="font-size: 10px;">raid</a> <a href="/tags/redis/" style="font-size: 10px;">redis</a> <a href="/tags/rrdtool/" style="font-size: 10px;">rrdtool</a> <a href="/tags/rsync/" style="font-size: 10px;">rsync</a> <a href="/tags/saltstack/" style="font-size: 16.25px;">saltstack</a> <a href="/tags/security/" style="font-size: 10px;">security</a> <a href="/tags/servicewrapper/" style="font-size: 10px;">servicewrapper</a> <a href="/tags/shadowsocks/" style="font-size: 10px;">shadowsocks</a> <a href="/tags/smokeping/" style="font-size: 13.75px;">smokeping</a> <a href="/tags/socks5/" style="font-size: 11.25px;">socks5</a> <a href="/tags/ss5/" style="font-size: 10px;">ss5</a> <a href="/tags/transmission/" style="font-size: 10px;">transmission</a> <a href="/tags/ubuntu/" style="font-size: 10px;">ubuntu</a> <a href="/tags/virsh/" style="font-size: 10px;">virsh</a> <a href="/tags/vncserver/" style="font-size: 10px;">vncserver</a> <a href="/tags/xz/" style="font-size: 10px;">xz</a> <a href="/tags/yum/" style="font-size: 10px;">yum</a> <a href="/tags/zsh/" style="font-size: 10px;">zsh</a> <a href="/tags/书写指南/" style="font-size: 10px;">书写指南</a>
    </div>
  </div>

  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Archives</h3>
    <div class="widget">
      <ul class="archive-list"><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/11/">November 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/10/">October 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/07/">July 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/05/">May 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/04/">April 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/03/">March 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/02/">February 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2016/01/">January 2016</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/12/">December 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/11/">November 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/10/">October 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/07/">July 2015</a></li><li class="archive-list-item"><a class="archive-list-link" href="/archives/2015/06/">June 2015</a></li></ul>
    </div>
  </div>


  
    
  <div class="widget-wrap">
    <h3 class="widget-title">Recent Posts</h3>
    <div class="widget">
      <ul>
        
          <li>
            <a href="/2016/11/17/Git-basic.html">Git基础</a>
          </li>
        
          <li>
            <a href="/2016/10/26/ansible-managment-windows.html">使用ansible管理windows主机</a>
          </li>
        
          <li>
            <a href="/2016/10/20/git-different-sshkey.html">配置不同ssh-key访问不同git仓库</a>
          </li>
        
          <li>
            <a href="/2016/10/20/l2tp-vpn.html">IPsec和L2TP搭建VPN</a>
          </li>
        
          <li>
            <a href="/2016/10/20/ansible-dynamic-create-vhost.html">通过jinja2生成虚拟主机配置</a>
          </li>
        
      </ul>
    </div>
  </div>

  
</aside>
        
      </div>
      <footer id="footer">
  
  <div class="outer">
    <div id="footer-info" class="inner">
      &copy; 2016 C.c<br>
      Powered by <a href="http://hexo.io/" target="_blank">Hexo</a>
    </div>
  </div>
</footer>
    </div>
    <nav id="mobile-nav">
  
    <a href="/" class="mobile-nav-link">Home</a>
  
    <a href="/archives" class="mobile-nav-link">Archives</a>
  
</nav>
    

<script src="//ajax.googleapis.com/ajax/libs/jquery/2.0.3/jquery.min.js"></script>


  <link rel="stylesheet" href="/fancybox/jquery.fancybox.css">
  <script src="/fancybox/jquery.fancybox.pack.js"></script>


<script src="/js/script.js"></script>

  </div>
</body>
</html>