<!doctype html>



  


<html class="theme-next pisces use-motion">
<head>
  <meta charset="UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>



<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />












  
  
  <link href="/vendors/fancybox/source/jquery.fancybox.css?v=2.1.5" rel="stylesheet" type="text/css" />




  
  
  
  

  
    
    
  

  

  

  

  

  
    
    
    <link href="//fonts.googleapis.com/css?family=Lato:300,300italic,400,400italic,700,700italic&subset=latin,latin-ext" rel="stylesheet" type="text/css">
  






<link href="/vendors/font-awesome/css/font-awesome.min.css?v=4.4.0" rel="stylesheet" type="text/css" />

<link href="/css/main.css?v=5.0.2" rel="stylesheet" type="text/css" />


  <meta name="keywords" content="Linux, Python" />








  <link rel="shortcut icon" type="image/x-icon" href="/favicon.ico?v=5.0.2" />






<meta name="description" content="Love Linux ♥ Love Python. 猴赛雷">
<meta property="og:type" content="website">
<meta property="og:title" content="Czero's Blog">
<meta property="og:url" content="http://czero000.github.io/page/2/index.html">
<meta property="og:site_name" content="Czero's Blog">
<meta property="og:description" content="Love Linux ♥ Love Python. 猴赛雷">
<meta name="twitter:card" content="summary">
<meta name="twitter:title" content="Czero's Blog">
<meta name="twitter:description" content="Love Linux ♥ Love Python. 猴赛雷">



<script type="text/javascript" id="hexo.configuration">
  var NexT = window.NexT || {};
  var CONFIG = {
    scheme: 'Pisces',
    sidebar: {"position":"left","display":"post"},
    fancybox: true,
    motion: true,
    duoshuo: {
      userId: '0',
      author: '主编大人'
    }
  };
</script>




  <link rel="canonical" href="http://czero000.github.io/page/2/"/>


  <title> Czero's Blog </title>
</head>

<body itemscope itemtype="//schema.org/WebPage" lang="zh-Hans">

  



  <script type="text/javascript">
    var _hmt = _hmt || [];
    (function() {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?8598c7081881fc1631368a001586d2c8";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>








  
  
    
  

  <div class="container one-collumn sidebar-position-left 
   page-home 
 ">
    <div class="headband"></div>

    <header id="header" class="header" itemscope itemtype="//schema.org/WPHeader">
      <div class="header-inner"><div class="site-meta ">
  

  <div class="custom-logo-site-title">
    <a href="/"  class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <span class="site-title">Czero's Blog</span>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>
  <p class="site-subtitle">点滴分享 多彩生活</p>
</div>

<div class="site-nav-toggle">
  <button>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
    <span class="btn-bar"></span>
  </button>
</div>

<nav class="site-nav">
  

  
    <ul id="menu" class="menu">
      
        
        <li class="menu-item menu-item-home">
          <a href="/" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-home"></i> <br />
            
            首页
          </a>
        </li>
      
        
        <li class="menu-item menu-item-categories">
          <a href="/categories" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-th"></i> <br />
            
            分类
          </a>
        </li>
      
        
        <li class="menu-item menu-item-about">
          <a href="/about" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-user"></i> <br />
            
            关于
          </a>
        </li>
      
        
        <li class="menu-item menu-item-archives">
          <a href="/archives" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-archive"></i> <br />
            
            归档
          </a>
        </li>
      
        
        <li class="menu-item menu-item-tags">
          <a href="/tags" rel="section">
            
              <i class="menu-item-icon fa fa-fw fa-tags"></i> <br />
            
            标签
          </a>
        </li>
      

      
    </ul>
  

  
</nav>

 </div>
    </header>

    <main id="main" class="main">
      <div class="main-inner">
        <div class="content-wrap">
          <div id="content" class="content">
            
  <section id="posts" class="posts-expand">
    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/saltstack-nodegroup.html" itemprop="url">
                  SaltStack-Nodegroup
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-07T10:57:33+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/saltstack-nodegroup.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/saltstack-nodegroup.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/07/saltstack-nodegroup.html" class="leancloud_visitors" data-flag-title="SaltStack-Nodegroup">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <p>为了便于管理功能相似的minion，SaltStack提供了分组模式，官方文档：<a href="http://docs.saltstack.com/en/latest/topics/targeting/nodegroups.html" target="_blank" rel="external">http://docs.saltstack.com/en/latest/topics/targeting/nodegroups.html</a><br>Node group为预先在master配置文件中定义的minion组，用来进行批量对minion操作。在master配置文件中，删除<code>default_include: master.d/*.conf</code>注释。</p>
<ul>
<li>编辑配置文件： /etc/salt/master.d/nodegroup.conf</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">#####         Node Groups           #####</div><div class="line">##########################################</div><div class="line"># Node groups allow for logical groupings of minion nodes. A group consists of a group</div><div class="line"># name and a compound target.</div><div class="line">nodegroups:</div><div class="line">  minion: &apos;172.16.11.211&apos;</div></pre></td></tr></table></figure>
<ul>
<li>重启master</li>
</ul>
<p>测试通过-N参数在命令行指定运行的节点组：<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">salt -N minion test.ping</div><div class="line">172.16.11.211:</div><div class="line">    True</div></pre></td></tr></table></figure></p>
<ul>
<li>在top file中增加组分类</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">base:</div><div class="line">  minion:</div><div class="line">    - match: nodegroup</div><div class="line">    - apache</div><div class="line">    - ssh</div></pre></td></tr></table></figure>
<p><img src="http://www.zerounix.com/images/devops/saltstack/nodegroup.png" alt="nodegroup"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/07/saltstack-states.html" itemprop="url">
                  SaltStack-States
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-07T10:53:38+08:00" content="2016-04-07">
              2016-04-07
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/07/saltstack-states.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/07/saltstack-states.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/07/saltstack-states.html" class="leancloud_visitors" data-flag-title="SaltStack-States">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="SaltStack的state"><a href="#SaltStack的state" class="headerlink" title="SaltStack的state"></a>SaltStack的state</h2><p>SaltStack使用state模块文件进行配置管理，state使用YAML语法编写，其实它也支持python编写。sls(salt state file)文件为SaltStack state模块的核心，sls文件表示一个系统应处于的系统状态，并且有一个简单的格式设置这些数据，称为配置管理。</p>
<ul>
<li><p>It is all just data<br>其实sls文件只是一个数据结构，对于sls文件的深入理解会有助于对salt state的深入理解和应用。sls文件事实上只是一个字典、列表、字符串或者数字。通过对配置进行数据结构化，使其满足开发者的各种需求，写的越多，越易于理解。</p>
</li>
<li><p>The top file<br>所有的state file都可以通过top.sl文件来分配不同的主机使用，这是个整体入口描述，在执行命令的时候，会先检查这个文件，可以看作是基础配置文件</p>
</li>
<li><p>Default data -yaml<br>默认情况下salt表现的数据格式采用最简单的序列化数据格式-YAML，由于不同架构经常使用不同的名称和安装包，apache在红帽系列中是httpd，其他发行版多为apache，salt对于底层服务器管理使用init下的脚本，系统命令名，配置文件等，执行service.get_all函数来获取对应服务器可用的服务名称</p>
</li>
</ul>
<hr>
<h2 id="使用state"><a href="#使用state" class="headerlink" title="使用state"></a>使用state</h2><h3 id="通过命令查看state使用方法"><a href="#通过命令查看state使用方法" class="headerlink" title="通过命令查看state使用方法"></a>通过命令查看state使用方法</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">// 查看所有states列表</div><div class="line">salt -N minion&apos; sys.list_state_modules</div><div class="line">// 查看指定states的functions</div><div class="line">salt -N &apos;minion&apos; sys.list_state_functions file</div><div class="line">//查看指定states的用法</div><div class="line">salt -N &apos;minion&apos; sys.state_doc file</div></pre></td></tr></table></figure>
<h3 id="通过示例了解state"><a href="#通过示例了解state" class="headerlink" title="通过示例了解state"></a>通过示例了解state</h3><ul>
<li>安装软件包及启动服务</li>
</ul>
<p>由于不同架构经常使用不同的名称和安装包，apache在红帽系列中是httpd，其他发行版多为apache，salt对于底层服务器管理使用init下的脚本，系统命令名，配置文件等，执行service.get_all函数来获取对应服务器可用的服务名称</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line"><span class="attr">httpd:</span></div><div class="line"><span class="attr">  pkg:</span></div><div class="line"><span class="bullet">    -</span> installed</div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="bullet">    -</span> running</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> httpd</div></pre></td></tr></table></figure>
<p>这些sls数据确保apache包被安装而且apache服务处于运行状态。<br>第一行：被称为ID，这个ID是将要执行这些命令的名字<br>第二行和第四行：用来声明salt state开始的状态，分别使用包管理和服务管理，这个pkg状态管理，通过本地的软件包管理器进行软件安装，service管理系统守护进程<br>第三行、第五行：是要执行的function，这些函数被定义在pkg和service中，这里标示包会被安装，并且apache守护进行会运行<br>最后一行：require是一个必要的声明，用来定义状态之剑的依赖，他们保证apache服务安装成功后才会启动apache守护进程<br>state和方法可以通过点连接起来，上例和下文相同：<br><figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="attr">httpd:</span></div><div class="line">  pkg.installed</div><div class="line">  service.running</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> httpd</div></pre></td></tr></table></figure></p>
<p>在实际配置管理中，需要编写大量state.sls文件。这些文件会有一个top.sls（非必须）文件作为入口文件，负责指定minion调用某些state.sls文件。</p>
<p>将上面的sls保存为init.sls放置在salt://apache目录下，</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">/srv/salt/</div><div class="line">├── apache</div><div class="line">│   └── init.sls</div><div class="line">└── top.sls</div></pre></td></tr></table></figure>
<ul>
<li>添加配置文件和用户</li>
</ul>
<p>​    当建立类似Apache服务器这样的服务时，许多组件需要被安装。apache的配置文件要被管理起来，而且还需要特定的用户和用户</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div></pre></td><td class="code"><pre><div class="line"><span class="attr">httpd:</span></div><div class="line"><span class="attr">  pkg:</span></div><div class="line"><span class="bullet">    -</span> installed</div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="bullet">    -</span> running</div><div class="line"><span class="attr">    - watch:</span></div><div class="line"><span class="attr">      - pkg:</span> httpd</div><div class="line"><span class="attr">      - file:</span> /etc/httpd/conf/httpd.conf</div><div class="line"><span class="attr">      - user:</span> apache</div><div class="line">  user.present:</div><div class="line"><span class="attr">    - name:</span> apache</div><div class="line"><span class="attr">    - uid:</span> <span class="number">48</span></div><div class="line"><span class="attr">    - gid:</span> <span class="number">48</span></div><div class="line"><span class="attr">    - home:</span> /var/www</div><div class="line"><span class="attr">    - shell:</span> /bin/nologin</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - group:</span> apache</div><div class="line">  group.present:</div><div class="line"><span class="attr">    - name:</span> apache</div><div class="line"><span class="attr">    - gid:</span> <span class="number">48</span></div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> httpd</div><div class="line">/etc/httpd/conf/httpd.conf:</div><div class="line">  file.managed:</div><div class="line"><span class="attr">    - source:</span> salt://apache/httpd.conf</div><div class="line"><span class="attr">    - user:</span> root</div><div class="line"><span class="attr">    - group:</span> root</div><div class="line"><span class="attr">    - mode:</span> <span class="number">644</span></div></pre></td></tr></table></figure>
<p>​    这个例子扩展了上面，其中包括了一个配置文件、一个用户、一个用户组还有一个新的声明：watch。在service中的require换成了watch，从需要一个软件包改成监视3个state（分别是pkg、file、user）。watch语句和require很相似，都能保证被监视或者需要的state在自己之前执行，但是watch还有其他作用。当被监视的state发生变化时，定义watch语句的state与执行自己的watcher函数，当更新软件包、配置文件或者修改apache用户的uid都会触发service state的watcher函数，在本例子中，service state的watcher会重启apache服务。</p>
<ul>
<li>多个sls文件</li>
</ul>
<p>​    在具有扩展性的SaltStack时，需要不止一个sls，上面的例子中只使用了1个sls文件，多个sls文件可以结合成state tree。sls文件以一定的目录结构分布在master，sls和要发到minion上的文件只是普通文件.</p>
<p>ssh/init.sls</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div></pre></td><td class="code"><pre><div class="line">::::::::::::::</div><div class="line">init.sls</div><div class="line">::::::::::::::</div><div class="line"><span class="attr">include:</span></div><div class="line"><span class="bullet">  -</span> client</div><div class="line"><span class="bullet">  -</span> server</div><div class="line"></div><div class="line">::::::::::::::</div><div class="line">client.sls</div><div class="line">::::::::::::::</div><div class="line"><span class="attr">openssh-clients:</span></div><div class="line">  pkg.installed</div><div class="line">/etc/ssh/ssh_config:</div><div class="line">  file.managed:</div><div class="line"><span class="attr">    - user:</span> root</div><div class="line"><span class="attr">    - group:</span> root</div><div class="line"><span class="attr">    - mode:</span> <span class="number">644</span></div><div class="line"><span class="attr">    - source:</span> salt://ssh/files/ssh_config</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> openssh-clients</div><div class="line">      </div><div class="line">::::::::::::::</div><div class="line">server.sls</div><div class="line">::::::::::::::</div><div class="line"><span class="attr">include:</span></div><div class="line"><span class="bullet">  -</span> ssh</div><div class="line"><span class="attr">openssh-server:</span></div><div class="line">  pkg.installed</div><div class="line"><span class="attr">sshd:</span></div><div class="line">  service.running:</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> openssh-clients</div><div class="line"><span class="attr">      - pkg:</span> openssh-server</div><div class="line"><span class="attr">      - file:</span> /etc/ssh/sshd_config</div><div class="line">/etc/ssh/sshd_config:</div><div class="line">  file.managed:</div><div class="line"><span class="attr">    - user:</span> root</div><div class="line"><span class="attr">    - group:</span> root</div><div class="line"><span class="attr">    - mode:</span> <span class="number">644</span></div><div class="line"><span class="attr">    - source:</span> salt://ssh/files/sshd_config</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> openssh-server</div></pre></td></tr></table></figure>
<ul>
<li><p>扩展被引用的sls数据</p>
<p>  什么是扩展呢。在ssh/server.sls文件中定义了一个apache通用的服务器，现在需要增加一个带有mod_python模块的apache，不需要重新写sls，可以直接include原来的server.sls，然后增加安装mod_python的state，在apache service的watch列表中增加mod_python即可。<em>**</em></p>
</li>
</ul>
<p>python/mod_ypthon.sls内容如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">include:  </div><div class="line">- apache</div><div class="line"></div><div class="line">extend:</div><div class="line">  apache:</div><div class="line">    service:</div><div class="line">      - watch: </div><div class="line">        - pkg:mod_python</div><div class="line"></div><div class="line">mod_python:  pkg.installed</div></pre></td></tr></table></figure>
<p>这个例子中，先把apache目录下init.sls文件包含进来（在include一个目录时，salt会自动查找init.sls文件），然后拓展了ID为apache下的service state中的watch列表。也可以在extending中修改下载文件位置。extend是salt 的sls更加灵活。</p>
<ul>
<li><p>理解渲染系统Render System</p>
<p> 因为sls仅是数据，所以不是非要用YAML来表达。salt 默认用YAML，只是因为容易学习和使用，只要提供一个渲染器，sls文件可以以任意格式呈现出来。</p>
</li>
</ul>
<p>​    缺省的渲染系统是yaml_jinja渲染器。yaml_jinja渲染器使用jinjia2模版引擎来处理sls，然后在调用YAML解析。其他可用的渲染其还包括：yaml_mako模版引擎；yaml_wempy，使用Wempy模版引擎；py，使用Python写sls文件；pydsl，建立在python语法基础上的描述语言。</p>
<ul>
<li><p>默认渲染器—yaml_jinja</p>
<p>关于jinjia模板系统使用参考官方稳定：<a href="http://jinja.pocoo.org/docs" target="_blank" rel="external">http://jinja.pocoo.org/docs</a></p>
</li>
</ul>
<p>在基于模板引擎的渲染器，可以从3个组件中获取需要的数据：salt，grains和pilla。在模板文件中，salt对象允许任何salt函数从模板内容进行调用，grains允许grains从模板中访问：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div></pre></td><td class="code"><pre><div class="line">apache:</div><div class="line">  pkg:</div><div class="line">    - installed</div><div class="line">    &#123;% if grains[ &apos;os&apos; ] == &apos;CentOS&apos; %&#125;</div><div class="line">    - name: httpd</div><div class="line">    &#123;% endif %&#125;</div><div class="line">  service:</div><div class="line">    - running</div><div class="line">    &#123;% if grains[ &apos;os&apos; ] == &apos;CentOS&apos;%&#125;</div><div class="line">    - name: httpd</div><div class="line">    &#123;% endif %&#125;</div><div class="line">    - watch:</div><div class="line">      - pkg: apache</div><div class="line">      - file: /etc/httpd/conf/httpd.conf</div><div class="line">      - user: apache</div><div class="line">  user.present:</div><div class="line">    - name: apache</div><div class="line">    - uid: 48</div><div class="line">    - gid: 48</div><div class="line">    - home: /var/www</div><div class="line">    - shell: /bin/nologin</div><div class="line">    - require:</div><div class="line">      - group: apache</div><div class="line">  group.present:</div><div class="line">    - name: apache</div><div class="line">    - gid: 48</div><div class="line">    - require:</div><div class="line">      - pkg: apache</div><div class="line">/etc/httpd/conf/httpd.conf:</div><div class="line">  file.managed:</div><div class="line">    - source: salt://apache/files/httpd.conf</div><div class="line">    - user: root</div><div class="line">    - group: root</div><div class="line">    - mode: 644</div></pre></td></tr></table></figure>
<p>这个例子很容易理解，用到jinja中的条件结构，如果grains中os表明minion的操作系统是CentOS，那么apache的软件包和服务名应当是httpd。更有意思的例子，用到jinja的循环结构，在设置MooseFS分布式中chunkserver：</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line">moosefs/chunk.sls：</div><div class="line"><span class="attr">include:</span></div><div class="line"><span class="bullet">    -</span> moosefs</div><div class="line">&#123;% for mnt in salt[<span class="string">'cmd.run'</span>](<span class="string">'ls /dev/data/moose*'</span>).split() %&#125;</div><div class="line">/mnt/moose&#123;&#123; mnt[<span class="bullet">-1</span>] &#125;&#125;:</div><div class="line">  mount.mounted:</div><div class="line"><span class="attr">    - device:</span> &#123;&#123; mnt &#125;&#125;</div><div class="line"><span class="attr">    - fstype:</span> xfs</div><div class="line"><span class="attr">    - mkmnt:</span> <span class="literal">True</span></div><div class="line">  file.directory:</div><div class="line"><span class="attr">    - user:</span> mfs</div><div class="line"><span class="attr">    - group:</span> mfs</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - user:</span> mfs</div><div class="line"><span class="attr">      - group:</span> mfs</div><div class="line">&#123;% endfor %&#125;</div><div class="line">/etc/mfshdd.cfg:</div><div class="line">  file.managed:</div><div class="line"><span class="attr">    - source:</span> salt://moosefs/mfshdd.cfg</div><div class="line"><span class="attr">    - user:</span> root</div><div class="line"><span class="attr">    - group:</span> root</div><div class="line"><span class="attr">    - mode:</span> <span class="number">644</span></div><div class="line"><span class="attr">    - template:</span> jinja</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> mfs-chunkserver</div><div class="line"> </div><div class="line">/etc/mfschunkserver.cfg:</div><div class="line">  file.managed:</div><div class="line"><span class="attr">    - source:</span> salt://moosefs/mfschunkserver.cfg</div><div class="line"><span class="attr">    - user:</span> root</div><div class="line"><span class="attr">    - group:</span> root</div><div class="line"><span class="attr">    - mode:</span> <span class="number">644</span></div><div class="line"><span class="attr">    - template:</span> jinja</div><div class="line"><span class="attr">    - require:</span></div><div class="line"><span class="attr">      - pkg:</span> mfs-chunkserver</div><div class="line"> </div><div class="line"><span class="attr">mfs-chunkserver:</span></div><div class="line"><span class="attr">  pkg:</span></div><div class="line"><span class="bullet">    -</span> installed</div><div class="line"><span class="attr">mfschunkserver:</span></div><div class="line"><span class="attr">  service:</span></div><div class="line"><span class="bullet">    -</span> running</div><div class="line"><span class="attr">    - require:</span></div><div class="line">&#123;% for mnt in salt[<span class="string">'cmd.run'</span>](<span class="string">'ls /dev/data/moose*'</span>) %&#125;</div><div class="line"><span class="attr">      - mount:</span> /mnt/moose&#123;&#123; mnt[<span class="bullet">-1</span>] &#125;&#125;</div><div class="line"><span class="attr">      - file:</span> /mnt/moose&#123;&#123; mnt[<span class="bullet">-1</span>] &#125;&#125;</div><div class="line">&#123;% endfor %&#125;</div><div class="line"><span class="attr">      - file:</span> /etc/mfschunkserver.cfg</div><div class="line"><span class="attr">      - file:</span> /etc/mfshdd.cfg</div><div class="line"><span class="attr">      - file:</span> /var/lib/mfs</div></pre></td></tr></table></figure>
<p>这个例子展示了jinja的强大之处，多个for循环用来动态的检查并挂载磁盘，并多次使用salt cmd.run执行模块执行shell命令。</p>
<ul>
<li><p>运行和调用salt states</p>
<p>一旦写好sls文件，就应该测试，以保证能够正常工作，调用这些规则，只需要在命令行中执行 salt * state.highstate。如果返回的只有主机名，很可能是sls文件存在问题，在minion，使用salt-call命令执行 salt-call state.highstate -l debug来调试输出的作物信息，亦可以在前台执行salt-minion -l debug</p>
</li>
</ul>
<h3 id="state多环境配置"><a href="#state多环境配置" class="headerlink" title="state多环境配置"></a>state多环境配置</h3><ul>
<li>master</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">file_roots:</div><div class="line">  base:</div><div class="line">    - /srv/salt/base</div><div class="line">  dev:</div><div class="line">    - /srv/salt/dev</div></pre></td></tr></table></figure>
<ul>
<li>通过命令执行不同环境state</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt -N &apos;minion&apos; state.sls saltenv=&apos;dev&apos;</div><div class="line">salt -N &apos;minion&apos; state.sls saltenv=&apos;base&apos;</div></pre></td></tr></table></figure>
          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/06/saltstack-pillar.html" itemprop="url">
                  SaltStack-Pillar
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-06T15:57:33+08:00" content="2016-04-06">
              2016-04-06
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/06/saltstack-pillar.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/06/saltstack-pillar.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/06/saltstack-pillar.html" class="leancloud_visitors" data-flag-title="SaltStack-Pillar">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h2 id="什么是pillar"><a href="#什么是pillar" class="headerlink" title="什么是pillar"></a>什么是pillar</h2><p>Pillar是SaltStack非常重要的一个组件，经常与States配合使用在配置管理中。它用于给特定的minin定义任何你需要的数据，定义存储格式与grains类似，都是用dict结构，使用YAML格式。pillar数据和minion相关联，每个minion只可以看到自己的数据，所以可以用pillar传递敏感数据。pillar可以在以下场景中使用到：</p>
<ul>
<li>敏感数据<br>例如ssh key、加密证书、由于Pillar使用独立的加密session，可以确保敏感数据不被其他minion看到</li>
<li>变量<br>可以在pillar中处理平台差异化，比如针对不同的操作系统设置软件包名称，然后在state中引用</li>
<li>其他数据<br>可以在pillar中添加任意可以使用到的数据，例如定义用户和UID的关系、minion角色</li>
<li>Targetting<br>可以用来选择minion，使用-I参数<br>默认master配置文件中的所有数据到添加到pillar中，且对所有minion可用。如果要禁用，可以在修改master配置文件<code>#pillar_opts: True</code></li>
</ul>
<hr>
<h2 id="使用配置pillar"><a href="#使用配置pillar" class="headerlink" title="使用配置pillar"></a>使用配置pillar</h2><h3 id="创建pillar目录"><a href="#创建pillar目录" class="headerlink" title="创建pillar目录"></a>创建pillar目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div></pre></td><td class="code"><pre><div class="line">// 修改master配置文件，定义pillar工作目录</div><div class="line">pillar_roots:</div><div class="line">  base:</div><div class="line">    - /srv/pillar</div><div class="line"></div><div class="line">// 创建工作目录</div><div class="line">mkdir /srv/pillar</div><div class="line"></div><div class="line">//创建top.sls入口文件,用来组织其他pillar文件,可以定义多个环境不同的pillar目录</div><div class="line">cat top.sls</div><div class="line">base:                        //指定环境</div><div class="line">  &apos;*&apos;:                       // 引用主机</div><div class="line">    - packages               // 引用packages.sls或者packages/init.sls</div><div class="line">    - services               // 引用services.sls或者services/init.sls</div><div class="line">    - test                   // 引用test.sls或者test/init.sls</div><div class="line">dev:</div><div class="line">  &apos;os:CentOS&apos;                 //pillar还可以使用其他的匹配方式来选择minion</div><div class="line">    - git</div><div class="line"></div><div class="line">// 定义pillar</div><div class="line">cat test/init.sls</div><div class="line">NAME: zero</div><div class="line">ID: 1314</div><div class="line">CONTENT: This is a test !!</div><div class="line"></div><div class="line">cat packages/init.sls</div><div class="line">&#123;% if grains[&apos;os&apos;] == &apos;CentOS&apos; %&#125;</div><div class="line">  apache: httpd</div><div class="line">  git: git</div><div class="line">&#123;% elif grains[&apos;os&apos;] == &apos;Debian&apos; %&#125;</div><div class="line">  apache: apache2</div><div class="line">  git: git-core</div><div class="line">&#123;&amp; endif &amp;&#125;</div></pre></td></tr></table></figure>
<p>base环境中所有的minion都具有packages、services、test 中定义的数据。pillar采用与file server相同的文件映射方式。packages映射到文件/srv/pillar/packages/init.sls。services映射到/srv/pillar/services/init.sls。值得注意的是key与value要用冒号分隔，没有空格的话解析会失败。</p>
<h3 id="查看定义的pillar"><a href="#查看定义的pillar" class="headerlink" title="查看定义的pillar"></a>查看定义的pillar</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">salt &apos;*&apos; pillar.data</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    CONTENT:</div><div class="line">        This is a test !!</div><div class="line">    ID:</div><div class="line">        1314</div><div class="line">    NAME:</div><div class="line">        zero</div><div class="line">    http:</div><div class="line">        ----------</div><div class="line">        package-name:</div><div class="line">            httpd</div><div class="line">        port:</div><div class="line">            80</div><div class="line">        user:</div><div class="line">            nobody</div><div class="line">        version:</div><div class="line">            2.4.6</div><div class="line"></div><div class="line"></div><div class="line">salt &apos;*&apos; saltutil.refresh_pillar  // 在master上修改pillar文件后，需要用命令刷新minion数据</div></pre></td></tr></table></figure>
<h3 id="在pillar中使用列表"><a href="#在pillar中使用列表" class="headerlink" title="在pillar中使用列表"></a>在pillar中使用列表</h3><p>pillar的key/value结构中的value可以是string，也可以是一个list。pillar文件定义如下：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">/srv/pillar/users/init.sls:</div><div class="line">users:</div><div class="line">  zero:  1000</div><div class="line">  damon:  1001</div><div class="line"></div><div class="line">在top.sls中引用pillar文件，对所有的minion应用users中的内容：</div><div class="line">/srv/pillar/top.sls:</div><div class="line">base:</div><div class="line">  &apos;*&apos;:</div><div class="line">    - users</div><div class="line"></div><div class="line">// 现在所有的minion都既有user数据，可以在state文件中使用：</div><div class="line">/srv/salt/user/init.sls:</div><div class="line">&#123;% for user,uid in pillar.get(&apos;users&apos;,&#123;&#125;).items() %&#125;</div><div class="line">&#123;&#123;user&#125;&#125;:</div><div class="line">  user.present:</div><div class="line">    - uid: &#123;&#123;uid&#125;&#125;</div><div class="line">&#123;% endfor %&#125;</div></pre></td></tr></table></figure>
<h3 id="利用pillar处理平台差异"><a href="#利用pillar处理平台差异" class="headerlink" title="利用pillar处理平台差异"></a>利用pillar处理平台差异</h3><p>不同的操作系统不仅管理资源的方式不同，软件包的名字、配置文件的路径也有可能不一样。Salt的执行模块屏蔽了系统管理资源的差异。其他的差异可以根据grains中的os、cpuarch等信息来处理，这些条件判断可以写在state，但会使得state文件的逻辑不清晰。pillar可以很好的解决这些问题。下面的例子中，在不同的os上安装对应的软件包，但是state file完全相同，不需要针对os做修改，灵活方便。<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">/srv/pillar/pkg/init.sls:</div><div class="line">packages:</div><div class="line">  &#123;% if grains[&apos;os_family&apos;] == &apos;CentOS&apos; %&#125;</div><div class="line">    apache: httpd</div><div class="line">    vim:  vim-enhanced</div><div class="line">  &#123;% elif grains[&apos;os_family&apos;] == &apos;Debian&apos; %&#125;</div><div class="line">    apache: apache2</div><div class="line">    vim:  vim</div><div class="line">  (% elif grains[&apos;os&apos;] == &apos;arch&apos; %)</div><div class="line">    apache: apache</div><div class="line">    vim: vim</div><div class="line">  &#123;&amp; endif &amp;&#125;</div><div class="line">/srv/pillar/top.sls：</div><div class="line">base:&apos;*&apos;:- data</div><div class="line">    - users</div><div class="line">    - pkg    </div><div class="line">/srv/salt/apache/init.sls：</div><div class="line"></div><div class="line">apache:</div><div class="line">  pkg.installed:- name: &#123;&#123; pillar[&apos;pkgs&apos;][&apos;apache&apos;] &#125;&#125;</div><div class="line"></div><div class="line">// 还可以在state file中设置默认值： srv/salt/apache/init.sls：</div><div class="line"></div><div class="line">apache:</div><div class="line">  pkg.installed:- name: &#123;&#123; salt[&apos;pillar.get&apos;](&apos;pkgs:apache&apos;, &apos;httpd&apos;) &#125;&#125;</div></pre></td></tr></table></figure></p>
<h3 id="Grains-和Pillar区别"><a href="#Grains-和Pillar区别" class="headerlink" title="Grains 和Pillar区别"></a>Grains 和Pillar区别</h3><p>在下面的表格中通过多个维度对它们进行对比。</p>
<table>
<thead>
<tr>
<th>名称</th>
<th>存储位置</th>
<th>数据类型</th>
<th>数据采集更新方式</th>
<th>应用</th>
</tr>
</thead>
<tbody>
<tr>
<td>Grains</td>
<td>Minion端</td>
<td>静态数据</td>
<td>Minion启动时收集，也可以使用saltutil.sync_grains进行刷新。</td>
<td>存储Minion基本数据。比如用于匹配Minion，自身数据可以用来做资产管理等。</td>
</tr>
<tr>
<td>Pillar</td>
<td>Master端</td>
<td>动态数据</td>
<td>在Master端定义，指定给对应的Minion。可以使用saltutil.refresh_pillar刷新</td>
<td>存储Master指定的数据，只有指定的Minion可以看到。用于敏感数据保存</td>
</tr>
</tbody>
</table>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/glusterfs-technical-explanation.html" itemprop="url">
                  GlusterFS技术详解
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-05T15:42:12+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/分布式文件系统/" itemprop="url" rel="index">
                    <span itemprop="name">分布式文件系统</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/glusterfs-technical-explanation.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/glusterfs-technical-explanation.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/05/glusterfs-technical-explanation.html" class="leancloud_visitors" data-flag-title="GlusterFS技术详解">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h1 id="什么是GlusterFS"><a href="#什么是GlusterFS" class="headerlink" title="什么是GlusterFS"></a>什么是GlusterFS</h1><p> <img src="http://www.zerounix.com/images/opstech/glusterfs/logo.png" alt="logo"></p>
<h2 id="GlusterFS概述"><a href="#GlusterFS概述" class="headerlink" title="GlusterFS概述"></a>GlusterFS概述</h2><p>  <a href="http://www.gluster.com/products/glusterfs/" target="_blank" rel="external">GlusterFS</a>是Scale-Out存储解决方案Gluster的核心，他是一个开源的分布式文件系统，具有强大的横向扩展能力，通过扩展能够支持数PB存储容量和处理数千客户端。GlusterFS借助TCP/IP或InfiniBand RDMA(一种支持多并发链接的“转换线缆”技术)网络将物理分布的存储资源聚集在一起，使用单一全局命名空间来管理数据。GlusterFS基于可堆叠的用户空间设计，可为各种不同的数据负载提供优异的性能。</p>
<p> <img src="http://www.zerounix.com\images\opstech\glusterfs\glusterfs_mount.png" alt="glusterfs_mount"></p>
<p>  GlusterFS支持运行在任何标准IP网络上标准应用程序的标准客户端，如图2所示，用户可以在全局统一的命名空间中使用NFS/CIFS等标准协议来访问应用数据。GlusterFS使得用户可摆脱原有的独立、高成本的封闭存储系统，能够利用普通廉价的存储设备来部署可集中管理、横向扩展、虚拟化的存储池，存储容量可扩展至TB/PB级。GlusterFS主要特征如下：</p>
<ul>
<li><strong>扩展性和高性能</strong></li>
</ul>
<p>GlusterFS利用双重特性来提供几TB至数PB的高扩展存储解决方案。Scale-Out架构允许通过简单地增加资源来提高存储容量和性能，磁盘、计算和I/O资源都可以独立增加，支持10GbE和InfiniBand等高速网络互联。Gluster弹性哈希（Elastic Hash）解除了GlusterFS对元数据服务器的需求，消除了单点故障和性能瓶颈，真正实现了并行化数据访问。</p>
<ul>
<li><strong>高可用性</strong></li>
</ul>
<p>GlusterFS可以对文件进行自动复制，如镜像或多次复制，从而确保数据总是可以访问，甚至是在硬件故障的情况下也能正常访问。自我修复功能能够把数据恢复到正确的状态，而且修复是以增量的方式在后台执行，几乎不会产生性能负载。GlusterFS没有设计自己的私有数据文件格式，而是采用操作系统中主流标准的磁盘文件系统（如EXT3、ZFS）来存储文件，因此数据可以使用各种标准工具进行复制和访问。</p>
<ul>
<li><strong>全局统一命名空间</strong></li>
</ul>
<p>全局统一命名空间将磁盘和内存资源聚集成一个单一的虚拟存储池，对上层用户和应用屏蔽了底层的物理硬件。存储资源可以根据需要在虚拟存储池中进行弹性扩展， 比如扩容或收缩。当存储虚拟机映像时，存储的虚拟映像文件没有数量限制，成千虚拟机均通过单一挂载点进行数据共享。虚拟机I/O可在命名空间内的所有服务器上自动进行负载均衡，消除了SAN环境中经常发生的访问热点和性能瓶颈问题。</p>
<ul>
<li><strong>弹性哈希算法</strong></li>
</ul>
<p>GlusterFS采用弹性哈希算法在存储池中定位数据，而不是采用集中式或分布式元数据服务器索引。在其他的Scale-Out存储系统中，元数据服务器通常会导致I/O性能瓶颈和单点故障问题。GlusterFS中，所有在Scale-Out存储配置中的存储系统都可以智能地定位任意数据分片，不需要查看索引或者向其他服务器查询。这种设计机制完全并行化了数据访问，实现了真正的线性性能扩展。</p>
<ul>
<li><strong>弹性卷管理</strong></li>
</ul>
<p>数 据储存在逻辑卷中，逻辑卷可以从虚拟化的物理存储池进行独立逻辑划分而得到。存储服务器可以在线进行增加和移除，不会导致应用中断。逻辑卷可以在所有配置 服务器中增长和缩减，可以在不同服务器迁移进行容量均衡，或者增加和移除系统，这些操作都可在线进行。文件系统配置更改也可以实时在线进行并应用，从而可 以适应工作负载条件变化或在线性能调优。</p>
<ul>
<li><strong>基于标准协议</strong></li>
</ul>
<p>Gluster存储服务支持NFS, CIFS, HTTP, FTP以及Gluster原生协议，完全与POSIX标准兼容。现有应用程序不需要作任何修改或使用专用API，就可以对Gluster中的数据进行访问。这在公有云环境中部署Gluster时非常有用，Gluster对云服务提供商专用API进行抽象，然后提供标准POSIX接口。</p>
<hr>
<h2 id="设计目标"><a href="#设计目标" class="headerlink" title="设计目标"></a>设计目标</h2><p>GlusterFS的设计思想显著区别有现有并行/集群/分布式文件系统。如果GlusterFS在设计上没有本质性的突破，难以在与Lustre、PVFS2、Ceph等的竞争中占据优势，更别提与GPFS、StorNext、ISILON、IBRIX等具有多年技术沉淀和市场积累的商用文件系统竞争。其核心设计目标包括如下三个：</p>
<ul>
<li><strong>弹性存储系统（Elasticity）</strong></li>
</ul>
<p>存储系统具有弹性能力，意味着企业可以根据业务需要灵活地增加或缩减数据存储以及增删存储池中的资源，而不需要中断系统运行。GlusterFS设计目标之一就是弹性，允许动态增删数据卷、扩展或缩减数据卷、增删存储服务器等，不影响系统正常运行和业务服务。GlusterFS早期版本中弹性不足，部分管理工作需要中断服务，目前最新的3.1.X版本已经弹性十足，能够满足对存储系统弹性要求高的应用需求，尤其是对云存储服务系统而言意义更大。GlusterFS主要通过存储虚拟化技术和逻辑卷管理来实现这一设计目标。</p>
<ul>
<li><strong>线性横向扩展（Linear Scale-Out）</strong></li>
</ul>
<p>线性扩展对于存储系统而言是非常难以实现的，通常系统规模扩展与性能提升之间是LOG对数曲线关系，因为同时会产生相应负载而消耗了部分性能的提升。现在的很多并行/集群/分布式文件系统都具很高的扩展能力，Luster存储节点可以达到1000个以上，客户端数量能够达到25000以上，这个扩展能力是非常强大的，但是Lustre也不是线性扩展的。</p>
<p>纵向扩展（Scale-Up）旨在提高单个节点的存储容量或性能，往往存在理论上或物理上的各种限制，而无法满足存储需求。横向扩展（Scale-Out）通过增加存储节点来提升整个系统的容量或性能，这一扩展机制是目前的存储技术热点，能有效应对容量、性能等存储需求。目前的并行/集群/分布式文件系统大多都具备横向扩展能力。</p>
<p>GlusterFS是线性横向扩展架构，它通过横向扩展存储节点即可以获得线性的存储容量和性能的提升。因此，结合纵向扩展GlusterFS可以获得多维扩展能力，增加每个节点的磁盘可增加存储容量，增加存储节点可以提高性能，从而将更多磁盘、内存、I/O资源聚集成更大容量、更高性能的虚拟存储池。GlusterFS利用三种基本技术来获得线性横向扩展能力：</p>
<ol>
<li><strong>消除元数据服务</strong></li>
<li><strong>高效数据分布，获得扩展性和可靠性</strong></li>
<li><strong>通过完全分布式架构的并行化获得性能的最大化**</strong></li>
<li><strong>高可靠性（Reliability）</strong></li>
</ol>
<p>与GFS（Google File System）类似，GlusterFS可以构建在普通的服务器和存储设备之上，因此可靠性显得尤为关键。GlusterFS从设计之初就将可靠性纳入核心设计，采用了多种技术来实现这一设计目标。首先，它假设故障是正常事件，包括硬件、磁盘、网络故障以及管理员误操作造成的数据损坏等。GlusterFS设计支持自动复制和自动修复功能来保证数据可靠性，不需要管理员的干预。其次，GlusterFS利用了底层EXT3/ZFS等磁盘文件系统的日志功能来提供一定的数据可靠性，而没有自己重新发明轮子。再次，GlusterFS是无元数据服务器设计，不需要元数据的同步或者一致性维护，很大程度上降低了系统复杂性，不仅提高了性能，还大大提高了系统可靠性。</p>
<hr>
<h2 id="技术特点"><a href="#技术特点" class="headerlink" title="技术特点"></a>技术特点</h2><p>GlusterFS在技术实现上与传统存储系统或现有其他分布式文件系统有显著不同之处，主要体现在如下几个方面。</p>
<ul>
<li><strong>完全软件实现（Software Only）</strong></li>
</ul>
<p>GlusterFS认为存储是软件问题，不能够把用户局限于使用特定的供应商或硬件配置来解决。GlusterFS采用开放式设计，广泛支持工业标准的存储、网络和计算机设备，而非与定制化的专用硬件设备捆绑。对于商业客户，GlusterFS可以以虚拟装置的形式交付，也可以与虚拟机容器打包，或者是公有云中部署的映像。开源社区中，GlusterFS被大量部署在基于廉价闲置硬件的各种操作系统上，构成集中统一的虚拟存储资源池。简而言之，GlusterFS是开放的全软件实现，完全独立于硬件和操作系统。</p>
<ul>
<li><strong>完整的存储操作系统栈（Complete Storage Operating System Stack）</strong></li>
</ul>
<p>GlusterFS不仅提供了一个分布式文件系统，而且还提供了许多其他重要的分布式功能，比如分布式内存管理、I/O调度、软RAID和自我修复等。GlusterFS汲取了微内核架构的经验教训，借鉴了GNU/Hurd操作系统的设计思想，在用户空间实现了完整的存储操作系统栈。</p>
<ul>
<li><strong>用户空间实现（User Space）</strong></li>
</ul>
<p>与传统的文件系统不同，GlusterFS在用户空间实现，这使得其安装和升级特别简便。另外，这也极大降低了普通用户基于源码修改GlusterFS的门槛，仅仅需要通用的C程序设计技能，而不需要特别的内核编程经验。</p>
<ul>
<li><strong>模块化堆栈式架构（Modular Stackable Architecture）</strong></li>
</ul>
<p>GlusterFS采用模块化、堆栈式的架构，可通过灵活的配置支持高度定制化的应用环境，比如大文件存储、海量小文件存储、云存储、多传输协议应用等。每个功能以模块形式实现，然后以积木方式进行简单的组合，即可实现复杂的功能。比如，Replicate模块可实现RAID1，Stripe模块可实现RAID0，通过两者的组合可实现RAID10和RAID01，同时获得高性能和高可靠性。</p>
<ul>
<li><strong>原始数据格式存储（Data Stored in Native Formats）</strong></li>
</ul>
<p>GlusterFS以原始数据格式（如EXT3、EXT4、XFS、ZFS）储存数据，并实现多种数据自动修复机制。因此，系统极具弹性，即使离线情形下文件也可以通过其他标准工具进行访问。如果用户需要从GlusterFS中迁移数据，不需要作任何修改仍然可以完全使用这些数据。</p>
<ul>
<li><strong>无元数据服务设计（No Metadata with the Elastic Hash Algorithm）</strong></li>
</ul>
<p>对Scale-Out存 储系统而言，最大的挑战之一就是记录数据逻辑与物理位置的映像关系，即数据元数据，可能还包括诸如属性和访问权限等信息。传统分布式存储系统使用集中式或 分布式元数据服务来维护元数据，集中式元数据服务会导致单点故障和性能瓶颈问题，而分布式元数据服务存在性能负载和元数据同步一致性问题。特别是对于海量 小文件的应用，元数据问题是个非常大的挑战。</p>
<p>GlusterFS独 特地采用无元数据服务的设计，取而代之使用算法来定位文件，元数据和数据没有分离而是一起存储。集群中的所有存储系统服务器都可以智能地对文件数据分片进 行定位，仅仅根据文件名和路径并运用算法即可，而不需要查询索引或者其他服务器。这使得数据访问完全并行化，从而实现真正的线性性能扩展。无元数据服务器 极大提高了GlusterFS的性能、可靠性和稳定性。</p>
<hr>
<h2 id="总体架构和设计"><a href="#总体架构和设计" class="headerlink" title="总体架构和设计 "></a>总体架构和设计 <img src="http://www.zerounix.com\images\opstech\glusterfs\gluster架构和组成.png" alt="gluster架构和组成"></h2><p>GlusterFS总体架构与组成部分如上图所示，它主要由存储服务器（Brick Server）、客户端以及NFS/Samba存储网关组成。不难发现，GlusterFS架构中没有元数据服务器组件，这是其最大的设计这点，对于提升整个系统的性能、可靠性和稳定性都有着决定性的意义。GlusterFS支持TCP/IP和InfiniBand RDMA高速网络互联，客户端可通过原生Glusterfs协议访问数据，其他没有运行GlusterFS客户端的终端可通过NFS/CIFS标准协议通过存储网关访问数据。</p>
<p>存储服务器主要提供基本的数据存储功能，最终的文件数据通过统一的调度策略分布在不同的存储服务器上。它们上面运行着Glusterfsd进行，负责处理来自其他组件的数据服务请求。如前所述，数据以原始格式直接存储在服务器的本地文件系统上，如EXT3、EXT4、XFS、ZFS等，运行服务时指定数据存储路径。多个存储服务器可以通过客户端或存储网关上的卷管理器组成集群，如Stripe（RAID0）、Replicate（RAID1）和DHT（分布式Hash）存储集群，也可利用嵌套组合构成更加复杂的集群，如RAID10。</p>
<p>由于没有了元数据服务器，客户端承担了更多的功能，包括数据卷管理、I/O调度、文件定位、数据缓存等功能。客户端上运行Glusterfs进程，它实际是Glusterfsd的符号链接，利用FUSE（File system in User Space）模块将GlusterFS挂载到本地文件系统之上，实现POSIX兼容的方式来访问系统数据。在最新的3.1.X版本中，客户端不再需要独立维护卷配置信息，改成自动从运行在网关上的glusterd弹性卷管理服务进行获取和更新，极大简化了卷管理。GlusterFS客户端负载相对传统分布式文件系统要高，包括CPU占用率和内存占用。</p>
<p>GlusterFS存储网关提供弹性卷管理和NFS/CIFS访问代理功能，其上运行Glusterd和Glusterfs进程，两者都是Glusterfsd符号链接。卷管理器负责逻辑卷的创建、删除、容量扩展与缩减、容量平滑等功能，并负责向客户端提供逻辑卷信息及主动更新通知功能等。GlusterFS 3.1.X实现了逻辑卷的弹性和自动化管理，不需要中断数据服务或上层应用业务。对于Windows客户端或没有安装GlusterFS的客户端，需要通过NFS/CIFS代理网关来访问，这时网关被配置成NFS或Samba服务器。相对原生客户端，网关在性能上要受到NFS/Samba的制约。</p>
<p> <img src="http://www.zerounix.com\images\opstech\glusterfs\gluster模块化堆栈设计.png" alt="gluster模块化堆栈设计"></p>
<p>GlusterFS是模块化堆栈式的架构设计，如图3所示。模块称为Translator，是GlusterFS提供的一种强大机制，借助这种良好定义的接口可以高效简便地扩展文件系统的功能。服务端与客户端模块接口是兼容的，同一个translator可同时在两边加载。每个translator都是SO动态库，运行时根据配置动态加载。每个模块实现特定基本功能，GlusterFS中所有的功能都是通过translator实现，比如Cluster, Storage, Performance, Protocol, Features等，基本简单的模块可以通过堆栈式的组合来实现复杂的功能。这一设计思想借鉴了GNU/Hurd微内核的虚拟文件系统设计，可以把对外部系统的访问转换成目标系统的适当调用。大部分模块都运行在客户端，比如合成器、I/O调度器和性能优化等，服务端相对简单许多。客户端和存储服务器均有自己的存储栈，构成了一棵Translator功能树，应用了若干模块。模块化和堆栈式的架构设计，极大降低了系统设计复杂性，简化了系统的实现、升级以及系统维护。</p>
<hr>
<h2 id="弹性哈希算法"><a href="#弹性哈希算法" class="headerlink" title="弹性哈希算法"></a>弹性哈希算法</h2><p>对于分布式系统而言，元数据处理是决定系统扩展性、性能以及稳定性的关键。GlusterFS另辟蹊径，彻底摒弃了元数据服务，使用弹性哈希算法代替传统分布式文件系统中的集中或分布式元数据服务。这根本性解决了元数据这一难题，从而获得了接近线性的高扩展性，同时也提高了系统性能和可靠性。GlusterFS使用算法进行数据定位，集群中的任何服务器和客户端只需根据路径和文件名就可以对数据进行定位和读写访问。换句话说，GlusterFS不需要将元数据与数据进行分离，因为文件定位可独立并行化进行。GlusterFS中数据访问流程如下：</p>
<ol>
<li><strong>计算hash值，输入参数为文件路径和文件名；</strong></li>
<li><strong>根据hash值在集群中选择子卷（存储服务器），进行文件定位；</strong></li>
<li><strong>对所选择的子卷进行数据访问。</strong></li>
</ol>
<p>GlusterFS目前使用Davies-Meyer算法计算文件名hash值，获得一个32位整数。Davies-Meyer算法具有非常好的hash分布性，计算效率很高。假设逻辑卷中的存储服务器有N个，则32位整数空间被平均划分为N个连续子空间，每个空间分别映射到一个存储服务器。这样，计算得到的32位hash值就会被投射到一个存储服务器，即我们要选择的子卷。难道真是如此简单？现在让我们来考虑一下存储节点加入和删除、文件改名等情况，GlusterFS如何解决这些问题而具备弹性的呢？</p>
<p>逻辑卷中加入一个新存储节点，如果不作其他任何处理，hash值 映射空间将会发生变化，现有的文件目录可能会被重新定位到其他的存储服务器上，从而导致定位失败。解决问题的方法是对文件目录进行重新分布，把文件移动到 正确的存储服务器上去，但这大大加重了系统负载，尤其是对于已经存储大量的数据的海量存储系统来说显然是不可行的。另一种方法是使用一致性哈希算法，修改 新增节点及相邻节点的hash映射空间，仅需要移动相邻节点上的部分数据至新增节点，影响相对小了很多。然而，这又带来另外一个问题，即系统整体负载不均衡。GlusterFS没有采用上述两种方法，而是设计了更为弹性的算法。GlusterFS的 哈希分布是以目录为基本单位的，文件的父目录利用扩展属性记录了子卷映射信息，其下面子文件目录在父目录所属存储服务器中进行分布。由于文件目录事先保存 了分布信息，因此新增节点不会影响现有文件存储分布，它将从此后的新创建目录开始参与存储分布调度。这种设计，新增节点不需要移动任何文件，但是负载均衡 没有平滑处理，老节点负载较重。GlusterFS在设计中考虑了这一问题，在新建文件时会优先考虑容量负载最轻的节点，在目标存储节点上创建文件链接直向真正存储文件的节点。另外，GlusterFS弹性卷管理工具可以在后台以人工方式来执行负载平滑，将进行文件移动和重新分布，此后所有存储服务器都会均会被调度。</p>
<p>GlusterFS目前对存储节点删除支持有限，还无法做到完全无人干预的程度。如果直接删除节点，那么所在存储服务器上的文件将无法浏览和访问，创建文件目录也会失败。当前人工解决方法有两个，一是将节点上的数据重新复制到GlusterFS中，二是使用新的节点来替换删除节点并保持原有数据。</p>
<p>如果一个文件被改名，显然hash算法将产生不同的值，非常可能会发生文件被定位到不同的存储服务器上，从而导致文件访问失败。采用数据移动的方法，对于大文件是很难在实时完成的。为了不影响性能和服务中断，GlusterFS采 用了文件链接来解决文件重命名问题，在目标存储服务器上创建一个链接指向实际的存储服务器，访问时由系统解析并进行重定向。另外，后台同时进行文件迁移， 成功后文件链接将被自动删除。对于文件移动也作类似处理，好处是前台操作可实时处理，物理数据迁移置于后台选择适当时机执行。</p>
<p> <img src="http://www.zerounix.com\images\opstech\glusterfs\GlusterFS弹性卷管理.png" alt="GlusterFS弹性卷管理"></p>
<p>弹性哈希算法为文件分配逻辑卷，那么GlusterFS如何为逻辑卷分配物理卷呢？GlusterFS3.1.X实现了真正的弹性卷管理，如图4所 示。存储卷是对底层硬件的抽象，可以根据需要进行扩容和缩减，以及在不同物理系统之间进行迁移。存储服务器可以在线增加和移除，并能在集群之间自动进行数 据负载平衡，数据总是在线可用，没有应用中断。文件系统配置更新也可以在线执行，所作配置变动能够快速动态地在集群中传播，从而自动适应负载波动和性能调 优。</p>
<p>​    弹性哈希算法本身并没有提供数据容错功能，GlusterFS使用镜像或复制来保证数据可用性，推荐使用镜像或3路复制。复制模式下，存储服务器使用同步写复制到其他的存储服务器，单个服务器故障完全对客户端透明。此外，GlusterFS没有对复制数量进行限制，读被分散到所有的镜像存储节点，可以提高读性能。弹性哈希算法分配文件到唯一的逻辑卷，而复制可以保证数据至少保存在两个不同存储节点，两者结合使得GlusterFS具备更高的弹性。</p>
<hr>
<h2 id="Translators"><a href="#Translators" class="headerlink" title="Translators"></a>Translators</h2><p>如前所述，Translators是GlusterFS提供的一种强大文件系统功能扩展机制，这一设计思想借鉴于GNU/Hurd微内核操作系统。GlusterFS中所有的功能都通过Translator机制实现，运行时以动态库方式进行加载，服务端和客户端相互兼容。GlusterFS 3.1.X中，主要包括以下几类Translator：</p>
<ol>
<li><strong>Cluster</strong>：存储集群分布，目前有AFR, DHT, Stripe三种方式</li>
<li><strong>Debug</strong>：跟踪GlusterFS内部函数和系统调用</li>
<li><strong>Encryption</strong>：简单的数据加密实现</li>
<li><strong>Features</strong>：访问控制、锁、Mac兼容、静默、配额、只读、回收站等</li>
<li><strong>Mgmt</strong>：弹性卷管理</li>
<li><strong>Mount</strong>：FUSE接口实现</li>
<li><strong>Nfs</strong>：内部NFS服务器</li>
<li><strong>Performance</strong>：io-cache, io-threads, quick-read, read-ahead, stat-prefetch, sysmlink-cache, write-behind等性能优化</li>
<li><strong>Protocol</strong>：服务器和客户端协议实现</li>
<li><strong>Storage</strong>：底层文件系统POSIX接口实现</li>
</ol>
<p>这里我们重点介绍一下Cluster Translators，它是实现GlusterFS集群存储的核心，它包括AFR（Automatic File Replication）、DHT（Distributed Hash Table）和Stripe三种类型。</p>
<p>AFR相当于RAID1，同一文件在多个存储节点上保留多份，主要用于实现高可用性以及数据自动修复。AFR所有子卷上具有相同的名字空间，查找文件时从第一个节点开始，直到搜索成功或最后节点搜索完毕。读数据时，AFR会把所有请求调度到所有存储节点，进行负载均衡以提高系统性能。写数据时，首先需要在所有锁服务器上对文件加锁，默认第一个节点为锁服务器，可以指定多个。然后，AFR以日志事件方式对所有服务器进行写数据操作，成功后删除日志并解锁。AFR会自动检测并修复同一文件的数据不一致性，它使用更改日志来确定好的数据副本。自动修复在文件目录首次访问时触发，如果是目录将在所有子卷上复制正确数据，如果文件不存则创建，文件信息不匹配则修复，日志指示更新则进行更新。</p>
<p>DHT即上面所介绍的弹性哈希算法，它采用hash方式进行数据分布，名字空间分布在所有节点上。查找文件时，通过弹性哈希算法进行，不依赖名字空间。但遍历文件目录时，则实现较为复杂和低效，需要搜索所有的存储节点。单一文件只会调度到唯一的存储节点，一旦文件被定位后，读写模式相对简单。DHT不具备容错能力，需要借助AFR实现高可用性, 如图5所示应用案例。</p>
<p>Stripe相当于RAID0，即分片存储，文件被划分成固定长度的数据分片以Round-Robin轮转方式存储在所有存储节点。Stripe所有存储节点组成完整的名字空间，查找文件时需要询问所有节点，这点非常低效。读写数据时，Stripe涉及全部分片存储节点，操作可以在多个节点之间并发执行，性能非常高。Stripe通常与AFR组合使用，构成RAID10/RAID01，同时获得高性能和高可用性，当然存储利用率会低于50%。</p>
<p> <img src="http://www.zerounix.com\images\opstech\glusterfs\AFR_DHT.png" alt="AFR_DHT"></p>
<hr>
<h2 id="设计讨论"><a href="#设计讨论" class="headerlink" title="设计讨论"></a>设计讨论</h2><p>GlusterFS是一个具有高扩展性、高性能、高可用性、可横向扩展的弹性分布式文件系统，在架构设计上非常有特点，比如无元数据服务器设计、堆栈式架构等。然而，存储应用问题是很复杂的，GlusterFS也不可能满足所有的存储需求，设计实现上也一定有考虑不足之处，下面我们作简要分析。</p>
<ul>
<li><strong>无元数据服务器 vs 元数据服务器</strong></li>
</ul>
<p>无元数据服务器设计的好处是没有单点故障和性能瓶颈问题，可提高系统扩展性、性能、可靠性和稳定性。对于海量小文件应用，这种设计能够有效解决元数据的难点 问题。它的负面影响是，数据一致问题更加复杂，文件目录遍历操作效率低下，缺乏全局监控管理功能。同时也导致客户端承担了更多的职能，比如文件定位、名字 空间缓存、逻辑卷视图维护等等，这些都增加了客户端的负载，占用相当的CPU和内存。</p>
<ul>
<li><strong>用户空间 vs 内核空间</strong></li>
</ul>
<p>用户空间实现起来相对要简单许多，对开发者技能要求较低，运行相对安全。用户空间效率低，数据需要多次与内核空间交换，另外GlusterFS借助FUSE来实现标准文件系统接口，性能上又有所损耗。内核空间实现可以获得很高的数据吞吐量，缺点是实现和调试非常困难，程序出错经常会导致系统崩溃，安全性低。纵向扩展上，内核空间要优于用户空间，GlusterFS有横向扩展能力来弥补。l  </p>
<ul>
<li><strong>堆栈式 vs 非堆栈式</strong></li>
</ul>
<p>这有点像操作系统的微内核设计与单一内核设计之争。GlusterFS堆栈式设计思想源自GNU/Hurd微内核操作系统，具有很强的系统扩展能力，系统设计实现复杂性降低很多，基本功能模块的堆栈式组合就可以实现强大的功能。查看GlusterFS卷配置文件我们可以发现，translator功能树通常深达10层以上，一层一层进行调用，效率可见一斑。非堆栈式设计可看成类似Linux的单一内核设计，系统调用通过中断实现，非常高效。后者的问题是系统核心臃肿，实现和扩展复杂，出现问题调试困难。</p>
<ul>
<li><strong>原始存储格式 vs 私有存储格式</strong></li>
</ul>
<p>GlusterFS使 用原始格式存储文件或数据分片，可以直接使用各种标准的工具进行访问，数据互操作性好，迁移和数据管理非常方便。然而，数据安全成了问题，因为数据是以平凡的方式保存的，接触数据的人可以直接复制和查看。这对很多应用显然是不能接受的，比如云存储系统，用户特别关心数据安全，这也是影响公有云存储发展的一 个重要原因。私有存储格式可以保证数据的安全性，即使泄露也是不可知的。GlusterFS要实现自己的私有格式，在设计实现和数据管理上相对复杂一些，也会对性能产生一定影响。</p>
<ul>
<li><strong>大文件 vs 小文件</strong></li>
</ul>
<p>GlusterFS适合大文件还是小文件存储？弹性哈希算法和Stripe数据分布策略，移除了元数据依赖，优化了数据分布，提高数据访问并行性，能够大幅提高大文件存储的性能。对于小文件，无元数据服务设计解决了元数据的问题。但GlusterFS并没有在I/O方面作优化，在存储服务器底层文件系统上仍然是大量小文件，本地文件系统元数据访问是一个瓶颈，数据分布和并行性也无法充分发挥作用。因此，GlusterFS适合存储大文件，小文件性能较差，还存在很大优化空间。</p>
<ul>
<li><strong>可用性 vs 存储利用率</strong></li>
</ul>
<p>GlusterFS使用复制技术来提供数据高可用性，复制数量没有限制，自动修复功能基于复制来实现。可用性与存储利用率是一个矛盾体，可用性高存储利用率就低，反之亦然。采用复制技术，存储利用率为1/复制数，镜像是50%，三路复制则只有33%。其实，可以有方法来同时提高可用性和存储利用率，比如RAID5的利用率是(n-1)/n，RAID6是(n-2)/n，而纠删码技术可以提供更高的存储利用率。但是，鱼和熊掌不可得兼，它们都会对性能产生较大影响。另外，GlusterFS目前的代码实现不够好，系统不够稳定，BUGS数量相对还比较多。从其官方网站的部署情况来看，测试用户非常多，但是真正在生产环境中的应用较少，存储部署容量几TB－几十TB的占很大比率，数百TB－PB级案例非常少。这也可以从另一个方面说明，GlusterFS目前还不够稳定，需要更长的时间来检验。然而不可否认，GlusterFS是一个有着光明前景的集群文件系统，线性横向扩展能力使它具有天生的优势，尤其是对于云存储系统。</p>
<hr>
<h1 id="使用GlusterFS"><a href="#使用GlusterFS" class="headerlink" title="使用GlusterFS"></a>使用GlusterFS</h1><h2 id="术语解释"><a href="#术语解释" class="headerlink" title="术语解释"></a>术语解释</h2><p><strong>Brick</strong> ：GFS中的存储单元，通过是一个受信存储池中的服务器的一个导出目录。可以通过主机名和目录名来标识，如’SERVER:EXPORT’</p>
<p><strong>Client</strong> ：挂载了GFS卷的设备</p>
<p><strong>Extended Attributes:xattr</strong> 是一个文件系统的特性，其支持用户或程序关联文件/目录和元数据。</p>
<p><strong>FUSE:Filesystem</strong> Userspace是一个可加载的内核模块，其支持非特权用户创建自己的文件系统而不需要修改内核代码。通过在用户空间运行文件系统的代码通过FUSE代码与内核进行桥接。</p>
<p><strong>Geo-Replication</strong></p>
<p><strong>GFID</strong> ：GFS卷中的每个文件或目录都有一个唯一的128位的数据相关联，其用于模拟inode</p>
<p><strong>Namespace</strong> ：每个Gluster卷都导出单个ns作为POSIX的挂载点</p>
<p><strong>Node</strong> ：一个拥有若干brick的设备</p>
<p><strong>RDMA</strong>：远程直接内存访问，支持不通过双方的OS进行直接内存访问。</p>
<p>RRDNS：round robin DNS是一种通过DNS轮转返回不同的设备以进行负载均衡的方法</p>
<p><strong>Self-heal</strong>：用于后台运行检测复本卷中文件和目录的不一致性并解决这些不一致。</p>
<p><strong>Split-brain</strong>：脑裂</p>
<p><strong>Translator</strong>：</p>
<p><strong>Volfile</strong>：glusterfs进程的配置文件，通常位于/var/lib/glusterd/vols/volname</p>
<p><strong>Volume</strong>：一组bricks的逻辑集合</p>
<hr>
<h2 id="安装GlusterFS"><a href="#安装GlusterFS" class="headerlink" title="安装GlusterFS"></a>安装GlusterFS</h2><h3 id="系统环境介绍"><a href="#系统环境介绍" class="headerlink" title="系统环境介绍"></a>系统环境介绍</h3><ul>
<li>OS版本：<code>CentOS Linux release 7.1.1503 (Core)</code></li>
<li>软件版本： 3.7.3（最新为3.7.10）</li>
<li>系统节点</li>
</ul>
<table>
<thead>
<tr>
<th style="text-align:left">ip地址</th>
<th style="text-align:left">挂载路径</th>
</tr>
</thead>
<tbody>
<tr>
<td style="text-align:left">172.16.18.241</td>
<td style="text-align:left">/export/brick1/gv0</td>
</tr>
<tr>
<td style="text-align:left">172.16.18.242</td>
<td style="text-align:left">/export/brick1/gv0</td>
</tr>
<tr>
<td style="text-align:left">172.16.18.243</td>
<td style="text-align:left">/export/brick1/gv0</td>
</tr>
<tr>
<td style="text-align:left">172.16.18.244</td>
<td style="text-align:left">/export/brick1/gv0</td>
</tr>
</tbody>
</table>
<h3 id="安装GlusterFS-1"><a href="#安装GlusterFS-1" class="headerlink" title="安装GlusterFS"></a>安装GlusterFS</h3><h4 id="安装软件包"><a href="#安装软件包" class="headerlink" title="安装软件包"></a>安装软件包</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">// 下载GlusterFs yum源配置</div><div class="line">wget -P /etc/yum.repos.d http://download.gluster.org/pub/gluster/glusterfs/LATEST/CentOS/glusterfs-epel.repo</div><div class="line"></div><div class="line">// 安装GlusterFS</div><div class="line">yum install -y glusterfs glusterfs-fuse glusterfs-server xfsprogs</div></pre></td></tr></table></figure>
<h4 id="配置开机启动"><a href="#配置开机启动" class="headerlink" title="配置开机启动"></a>配置开机启动</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">#systemctl enable glusterfsd.service</div><div class="line">systemctl enable glusterd.service</div><div class="line">systemctl start glusterd</div><div class="line">#systemctl start glusterfsd</div></pre></td></tr></table></figure>
<h2 id="配置GlusterFS集群"><a href="#配置GlusterFS集群" class="headerlink" title="配置GlusterFS集群"></a>配置GlusterFS集群</h2><h3 id="添加节点到GlusterFS集群"><a href="#添加节点到GlusterFS集群" class="headerlink" title="添加节点到GlusterFS集群"></a>添加节点到GlusterFS集群</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div></pre></td><td class="code"><pre><div class="line">//添加节点到存储池，在其中一个节点上操作</div><div class="line"> gluster peer probe 172.16.18.241</div><div class="line">peer probe: success: on localhost not needed</div><div class="line"></div><div class="line"> gluster peer probe 172.16.18.242</div><div class="line">peer probe: success</div><div class="line"></div><div class="line">gluster peer probe 172.16.18.243</div><div class="line">peer probe: success</div><div class="line"></div><div class="line"> gluster peer probe 172.16.18.244</div><div class="line">peer probe: success</div><div class="line"></div><div class="line">//查看各个节点状态</div><div class="line">gluster peer status</div><div class="line">Number of Peers: 3</div><div class="line">Hostname: 172.16.18.242</div><div class="line">Uuid: beb0aae7-a939-45ec-a273-0c21c2f59546</div><div class="line">State: Peer in Cluster (Connected)</div><div class="line">Hostname: 172.16.18.243</div><div class="line">Uuid: eab486b3-d1a1-4851-b9ec-45aab1ef9a66</div><div class="line">State: Peer in Cluster (Connected)</div><div class="line">Hostname: 172.16.18.244</div><div class="line">Uuid: 3108764d-d6b3-4356-810d-88872d56ceb6</div><div class="line">State: Peer in Cluster (Connected)</div></pre></td></tr></table></figure>
<h3 id="创建数据存储目录"><a href="#创建数据存储目录" class="headerlink" title="创建数据存储目录"></a>创建数据存储目录</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">parted  /dev/sdb rm 1</div><div class="line">mkfs.xfs -i size=512 /dev/sdb -f</div><div class="line">mkdir -p /export/brick1</div><div class="line">/bin/mount -t xfs /dev/sdb /export/brick1</div><div class="line">mkdir /export/brick1/gv0</div><div class="line">echo &quot;/dev/sdb        /export/brick1  xfs     defaults        1       2&quot; &gt;&gt; /etc/fstab</div></pre></td></tr></table></figure>
<h3 id="创建GlusterFS磁盘卷"><a href="#创建GlusterFS磁盘卷" class="headerlink" title="创建GlusterFS磁盘卷"></a>创建GlusterFS磁盘卷</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 创建系统卷gv0（副本卷）</div><div class="line">gluster volume create gv0 replica 2 172.16.18.241:/export/brick1/gv0 172.16.18.242:/export/brick1/gv0 172.16.18.243:/export/brick1/gv0 172.16.18.244:/export/brick1/gv0 force</div><div class="line"></div><div class="line">//启动系统卷gv0</div><div class="line"> gluster volume start gv0</div><div class="line">volume create: gv0: success: please start the volume to access data</div><div class="line"></div><div class="line">//查看系统卷信息</div><div class="line">gluster volume info</div><div class="line"> </div><div class="line">Volume Name: gv0</div><div class="line">Type: Distributed-Replicate</div><div class="line">Volume ID: e64cb61c-0f18-41b5-bf4d-c45ee085ca3b</div><div class="line">Status: Started</div><div class="line">Number of Bricks: 2 x 2 = 4</div><div class="line">Transport-type: tcp</div><div class="line">Bricks:</div><div class="line">Brick1: 172.16.18.241:/export/brick1/gv0</div><div class="line">Brick2: 172.16.18.242:/export/brick1/gv0</div><div class="line">Brick3: 172.16.18.243:/export/brick1/gv0</div><div class="line">Brick4: 172.16.18.244:/export/brick1/gv0</div><div class="line">Options Reconfigured:</div><div class="line">performance.readdir-ahead: on</div></pre></td></tr></table></figure>
<h3 id="安装客户端并mount-GlusterFS文件系统"><a href="#安装客户端并mount-GlusterFS文件系统" class="headerlink" title="安装客户端并mount GlusterFS文件系统"></a>安装客户端并mount GlusterFS文件系统</h3><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 下载仓库文件</div><div class="line">wget -P /etc/yum.repos.d  http://download.gluster.org/pub/gluster/glusterfs/LATEST/CentOS/glusterfs-epel.repo</div><div class="line"></div><div class="line">//安装软件</div><div class="line">yum install glusterfs glusterfs-fuse glusterfs-server</div><div class="line"></div><div class="line">//创建挂载点</div><div class="line">mkdir -p /opt/vmx/gv0</div><div class="line"></div><div class="line">//client挂载</div><div class="line">/bin/mount -t glusterfs 172.16.18.241:/gv0 /opt/vmx/gv0</div><div class="line"></div><div class="line">df -h</div><div class="line">Filesystem               Size  Used Avail Use% Mounted on</div><div class="line">/dev/mapper/centos-root   50G  5.6G   45G  12% /</div><div class="line">devtmpfs                  12G     0   12G   0% /dev</div><div class="line">tmpfs                     12G   12K   12G   1% /dev/shm</div><div class="line">tmpfs                     12G   25M   12G   1% /run</div><div class="line">tmpfs                     12G     0   12G   0% /sys/fs/cgroup</div><div class="line">/dev/mapper/centos-home  217G   33M  217G   1% /home</div><div class="line">/dev/sda1                497M  102M  395M  21% /boot</div><div class="line">/dev/sdb                 280G   33M  280G   1% /export/brick1</div><div class="line">172.16.18.241:/gv0         559G  1.6G  558G   1% /opt/vmx/gv0</div></pre></td></tr></table></figure>
<hr>
<h2 id="管理使用GlusterFS"><a href="#管理使用GlusterFS" class="headerlink" title="管理使用GlusterFS"></a>管理使用GlusterFS</h2><h3 id="Gluster节点管理"><a href="#Gluster节点管理" class="headerlink" title="Gluster节点管理"></a>Gluster节点管理</h3><p>在创建volume之前需要先将一组存储设备组成一个存储池，通过存储设备提供的bricks来组成卷。在设备上启动glusterd之后，可通过设备的主机名或IP地址，将设备加到存储池中。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">gluster peer command</div></pre></td></tr></table></figure>
<h4 id="节点状态"><a href="#节点状态" class="headerlink" title="节点状态"></a>节点状态</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">// 在任意节点操作，可以看到其他节点与本节点的连接状态</div><div class="line">gluster peer status</div><div class="line">Number of Peers: 3</div><div class="line">Hostname: 172.16.18.242</div><div class="line">Uuid: beb0aae7-a939-45ec-a273-0c21c2f59546</div><div class="line">State: Peer in Cluster (Connected)</div><div class="line">Hostname: 172.16.18.243</div><div class="line">Uuid: eab486b3-d1a1-4851-b9ec-45aab1ef9a66</div><div class="line">State: Peer in Cluster (Connected)</div><div class="line">Hostname: 172.16.18.244</div><div class="line">Uuid: 3108764d-d6b3-4356-810d-88872d56ceb6</div><div class="line">State: Peer in Cluster (Connected)</div></pre></td></tr></table></figure>
<h4 id="添加节点"><a href="#添加节点" class="headerlink" title="添加节点"></a>添加节点</h4><p><strong>命令：<code>gluster peer HostName</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 将节点server添加到存储池中</div><div class="line">gluster peer prober server</div></pre></td></tr></table></figure>
<h4 id="删除节点"><a href="#删除节点" class="headerlink" title="删除节点"></a>删除节点</h4><p><strong>命令： <code>gluster peer detach HostName</code></strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 将节点server从存储池中移除，移除节点时要保证节点上没有brick，需要提前移除brick</div><div class="line">gluster peer detch server</div></pre></td></tr></table></figure>
<p>gluster对于每个节点都会生成一个UUID来标识，因此如果节点的IP或主机名发生了变化，只需要重新执行peer probe即可。不过如果一个主机名曾经用过，想再改回去，则gluster会提示已经保存过。此时只能把节点detach掉，然后重新probe。</p>
<hr>
<h3 id="Gluster卷管理"><a href="#Gluster卷管理" class="headerlink" title="Gluster卷管理"></a>Gluster卷管理</h3><p>Gluster文件系统基于需求支持不同类型的卷类型。有些卷类型有益于扩展存储大小、一些可以提高性能、还有可以兼顾两者。</p>
<h4 id="卷的类型"><a href="#卷的类型" class="headerlink" title="卷的类型"></a>卷的类型</h4><ul>
<li><p><strong>Distributed Glusterfs Volume（分布卷）</strong></p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Distributed_Volume.png" alt="Distributed_Volume"></p>
</li>
</ul>
<p>这个是GlusterFS文件系统默认的卷类型，文件通过hash算法随机的分布到由bricks组成的卷上，因此不存在数据冗余。对于这样一个存储卷的优点是磁盘容量扩展强和使用率高。但是这也意味着一个brick损坏将导致数据丢失，除非brick底层使用硬件Raid等外部冗余措施。</p>
<ul>
<li><strong>Replicated Glusterfs Volume（镜像卷、副本卷）</strong></li>
</ul>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Replicated_Volume.png" alt=""></p>
<p>镜像卷类似raid1，解决了数据冗余问题，在创建时指定副本数量，副本在存储时会存放到不同brick上， 因此，有几个复本就必须提供至少多个brick。</p>
<p><strong>注意：在创建复本卷时，brick数量与复本个数必须相等；否则将会报错。另外如果同一个节点提供了多个brick，也可以在同一个结点上创建复本卷，但这并不安全，因为一台设备挂掉，其上面的所有brick就无法访问了。</strong></p>
<ul>
<li><p><strong>Striped Glusterfs Volume（条带卷）</strong></p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Striped_Volume.png" alt="Striped_Volume"></p>
</li>
</ul>
<p>类似与raid0，但是考虑一个大文件被存储在一个brick，许多客户在同一时间经常访问。这将导致单个brick过多的负载并会降低性能。带区卷数据存储在砖后将它划分为不同的条纹，将大文件将被分为小块(等于brick的数量体积),每个块都存储在一个brick。实现负载分布和文件可以获取更快读取速度，但不提供数据冗余。</p>
<ul>
<li><p><strong>Distributed Replicated Glusterfs Volume（分布式复制卷）</strong></p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Distributed_Replicated_Volume.png" alt="Distributed_Replicated_Volume"></p>
</li>
</ul>
<p>此类型卷是基本复本卷的扩展,兼顾分布卷和复制卷的功能。，可以指定若干brick组成一个复本卷，另外若干brick组成另个复本卷。单个文件在复本卷内数据保持复制，不同文件在不同复本卷之间进行分布。</p>
<ul>
<li><p><strong>Striped Glusterfs Volume（分布式条带卷）</strong></p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Distributed_Striped_Volume.png" alt="Distributed_Striped_Volume"></p>
</li>
</ul>
<p>volume中brick所包含的存储服务器数必须是stripe的倍数(&gt;=2倍)，兼顾分布式和条带式的功能。</p>
<ul>
<li><p>其他拓展卷</p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Distributed_Striped_Replicated_Volume.png" alt="Distributed_Striped_Replicated_Volume" title="分布式镜像条带卷"></p>
<p><img src="http://www.zerounix.com\images\opstech\glusterfs\Striped_Replicated_Volume.png" alt="Striped_Replicated_Volume" title="条带镜像卷"></p>
</li>
</ul>
<hr>
<h4 id="创建卷"><a href="#创建卷" class="headerlink" title="创建卷"></a>创建卷</h4><ul>
<li>创建分布式卷(DHT)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// DHT卷将数据以哈希计算方式分布到各个brick上，数据是以文件为单位存取，基本达到分布均衡，提供的容量为各个brick的容量总和</div><div class="line">gluster volume create NEW-VOLNAME [transport [tcp | rdma | tcp,rdma]] NEW-BRICK...</div><div class="line">gluster volume create dht_vol 172.16.18.&#123;241,242,243,244&#125;:/export/brick1/gv0</div></pre></td></tr></table></figure>
<ul>
<li>创建副本卷(AFR)</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// AFR提供数据副本，副本数为replica，即每个文件存储replica份数，文件不分割，以文件为存储单位：副本数需要等于brick数；当brick数是副本的倍数时，则自动变化为Replicated-Distributed卷</div><div class="line">gluster volume create NEW-VOLNAME [replica COUNT] [transport [tcp | rdma | tcp,rdma]] NEW-BRICK...</div><div class="line">gluster volume create afr_vol replica 2 [transport tcp] 172.16.18.&#123;241,242,243,244&#125;:/export/brick/gv0</div></pre></td></tr></table></figure>
<p><strong>每两个brick组成一组，每组两个副本，文件又以DHT分布在三个组上，这样是副本卷和分布式卷的组合</strong></p>
<ul>
<li>创建条带卷</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">//stripe卷类似raid0，将数据条带化，分布在不同的brick，该方式将文件分块，将文件分成stripe块，分别进行存储，在大文件读取是有优势。stripe需要等于brick数；当brick数等于stripe数的倍数时，则自动变化为stripe-distributed卷。</div><div class="line">gluster volume create NEW-VOLNAME [stripe COUNT] [transport [tcp | dma | tcp,rdma]] NEW-BRICK...</div><div class="line">gluster volume create str_vol stripe 2 172.16.18.&#123;241,242,243,244&#125;:/export/brick1/gv0</div></pre></td></tr></table></figure>
<p><strong>每2个brick组成一组，每组2个brick，文件以DHT分布在两个组中，每个组中将文件条带成2块</strong></p>
<ul>
<li>创建Replicated-Stripe-Distributed卷</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//使用8个brick创建一个组合卷，即brick数是stripe*replica的倍数，则创建三种基本卷的组合卷，若刚好等于stripe*replica则为stript-Distrubted卷</div><div class="line">gluster volume create str_afr_dht_vol stripe 2 replica 2 172.16.18.&#123;241,242,243,244&#125;:/export/brick1/gv0  172.16.18.&#123;241,242,243,244&#125;:/export/brick1/gv1</div></pre></td></tr></table></figure>
<h4 id="卷信息"><a href="#卷信息" class="headerlink" title="卷信息"></a>卷信息</h4><p><strong>命令：gluster volume info</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 该命令能够查看存储池中当前卷的信息，包括卷方式、包含的brick、卷的当期状态、卷名及UUID等</div><div class="line">gluster volume info</div><div class="line"> </div><div class="line">Volume Name: gv0</div><div class="line">Type: Distributed-Replicate</div><div class="line">Volume ID: e64cb61c-0f18-41b5-bf4d-c45ee085ca3b</div><div class="line">Status: Started</div><div class="line">Number of Bricks: 2 x 2 = 4</div><div class="line">Transport-type: tcp</div><div class="line">Bricks:</div><div class="line">Brick1: 172.16.18.241:/export/brick1/gv0</div><div class="line">Brick2: 172.16.18.242:/export/brick1/gv0</div><div class="line">Brick3: 172.16.18.243:/export/brick1/gv0</div><div class="line">Brick4: 172.16.18.244:/export/brick1/gv0</div><div class="line">Options Reconfigured:</div><div class="line">performance.readdir-ahead: on</div></pre></td></tr></table></figure></p>
<h4 id="卷状态"><a href="#卷状态" class="headerlink" title="卷状态"></a>卷状态</h4><p><strong>命令： gluster volume status</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line">// 该命令能够查看当前卷的状态，包括其中各个brick的状态、NFS的服务状态及当前task执行情况和一些系统设置状态等</div><div class="line">gluster volume status</div><div class="line">Status of volume: gv0</div><div class="line">Gluster process                             TCP Port  RDMA Port  Online  Pid</div><div class="line">------------------------------------------------------------------------------</div><div class="line">Brick 172.16.18.241:/export/brick1/gv0      49152     0          Y       1970 </div><div class="line">Brick 172.16.18.242:/export/brick1/gv0      49152     0          Y       9547 </div><div class="line">Brick 172.16.18.243:/export/brick1/gv0      49152     0          Y       1800 </div><div class="line">Brick 172.16.18.244:/export/brick1/gv0      49152     0          Y       9741 </div><div class="line">NFS Server on localhost                     N/A       N/A        N       N/A  </div><div class="line">Self-heal Daemon on localhost               N/A       N/A        Y       2605 </div><div class="line">NFS Server on 172.16.18.244                 N/A       N/A        N       N/A  </div><div class="line">Self-heal Daemon on 172.16.18.244           N/A       N/A        Y       15386</div><div class="line">NFS Server on 172.16.18.243                 N/A       N/A        N       N/A  </div><div class="line">Self-heal Daemon on 172.16.18.243           N/A       N/A        Y       1794 </div><div class="line">NFS Server on 172.16.18.242                 N/A       N/A        N       N/A  </div><div class="line">Self-heal Daemon on 172.16.18.242           N/A       N/A        Y       1966 </div><div class="line"></div><div class="line">Task Status of Volume gv0</div><div class="line">------------------------------------------------------------------------------</div><div class="line">Task                 : Rebalance           </div><div class="line">ID                   : fad4f770-87dd-4248-b41e-733641c8bcca</div><div class="line">Status               : completed</div></pre></td></tr></table></figure></p>
<h4 id="启动、停止卷"><a href="#启动、停止卷" class="headerlink" title="启动、停止卷"></a>启动、停止卷</h4><p><strong>命令： gluster volume start/stop VOLNAME</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// 将创建的卷启动，才能进行客户端挂载；stop能够将系统将停止；此外gluster并未提供restart的重启命令</div><div class="line">gluster volume start gv0</div><div class="line">volume create: gv0: success: please start the volume to access data</div></pre></td></tr></table></figure></p>
<h4 id="删除卷"><a href="#删除卷" class="headerlink" title="删除卷"></a>删除卷</h4><p><strong>命令：gluster volume delete VOLNAME</strong></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">// 删除卷的操作能够将整个卷删除，操作前需要将卷先停止</div><div class="line">gluster volume stop gv0</div><div class="line">gluster volume delete gv0</div></pre></td></tr></table></figure>
<h4 id="均衡卷"><a href="#均衡卷" class="headerlink" title="均衡卷"></a>均衡卷</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">\\ 不迁移数据</div><div class="line">gluster volume gv0 rebalance fix-layout start</div><div class="line">gluster volume gv0 rebalance start</div><div class="line">gluster volume gv0 rebalance startforce</div><div class="line">gluster volume gv0 rebalance status</div><div class="line">gluster volume gv0 rebalance stop</div></pre></td></tr></table></figure>
<p>修复卷</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gluster volume heal mamm-volume #只修复有问题的文件  </div><div class="line">gluster volume heal mamm-volume full #修复所有文件  </div><div class="line">gluster volume heal mamm-volume info#查看自愈详情  </div><div class="line">gluster volume heal mamm-volume info healed|heal-failed|split-brain</div></pre></td></tr></table></figure>
<p><strong>设置卷</strong></p>
<p>命令：<code>gluster volume set options</code> </p>
<h4 id="设置卷传输端口类型"><a href="#设置卷传输端口类型" class="headerlink" title="设置卷传输端口类型"></a>设置卷传输端口类型</h4><ol>
<li><p>Unmount the volume on all the clients using the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># umount mount-point</div></pre></td></tr></table></figure>
</li>
<li><p>Stop the volumes using the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># gluster volume stop volname</div></pre></td></tr></table></figure>
</li>
<li><p>Change the transport type. For example, to enable both tcp and rdma execute the followimg command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># gluster volume set volname config.transport tcp,rdma OR tcp OR rdma</div></pre></td></tr></table></figure>
</li>
<li><p>Mount the volume on all the clients. For example, to mount using rdma transport, use the following command:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"># mount -t glusterfs -o transport=rdma server1:/test-volume /mnt/glusterfs</div></pre></td></tr></table></figure>
</li>
</ol>
<hr>
<h3 id="Brick管理"><a href="#Brick管理" class="headerlink" title="Brick管理"></a>Brick管理</h3><h4 id="添加brick"><a href="#添加brick" class="headerlink" title="添加brick"></a>添加brick</h4><p><strong>命令：gluster volume add-brick VOLNAME NEW-BRICK</strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">//添加两个brick到存储gv0，副本卷则要一次添加的bricks数是replica的整数倍；stripe同样要求</div><div class="line">gluster peer probe 172.16.18.245</div><div class="line">gluster peer probe 172.16.18.246</div><div class="line">gluster volume add-brick gv0 172.16.18.245:/export/brick1/gv0  172.16.18.246:/export/brick1/gv0</div></pre></td></tr></table></figure></p>
<h4 id="移除brick"><a href="#移除brick" class="headerlink" title="移除brick"></a>移除brick</h4><p><strong>命令： <code>gluster volume remove-brick VOLNAME BRICK start/status/commit</code></strong><br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 若是副本卷，则要移除的Brick是replica的整数倍，stripe具有同样的要求，副本卷要移除一对Brick，在执行移除操作时，数据会移到其他节点。</div><div class="line">gluster volume remove-brick gv0 172.16.18.245:/export/brick1/gv0  172.16.18.246:/export/brick1/gv0 start</div><div class="line"></div><div class="line">// 在执行移除操作后，可以使用status命令进行task状态查看</div><div class="line">gluster volume remove-brick gv0 172.16.18.245:/export/brick1/gv0  172.16.18.246:/export/brick1/gv0 status</div><div class="line"></div><div class="line">// 使用commit命令执行brick移除，则不会进行数据迁移而直接删除brick，符合不需要数据迁移的用户需求</div><div class="line">gluster volume remove-brick gv0 172.16.18.245:/export/brick1/gv0  172.16.18.246:/export/brick1/gv0 commit</div></pre></td></tr></table></figure></p>
<p><strong>ps：系统的扩容及缩减可以通过如上的节点、brick管理组合达到目的</strong><br><strong>1. 扩容时，可以下增加系统节点，然后添加新增节点上的brick即可</strong><br><strong>2. 缩减时，可以先移除brick，然后在进行节点删除达到缩减的目的，并保证不丢失数据</strong></p>
<h4 id="替换brick"><a href="#替换brick" class="headerlink" title="替换brick"></a>替换brick</h4><p>命令：<code>gluster volume replace-brick VOLNAME BRICKNEW-BRICK start/pause/sbort/status/commit</code> </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">// 将172.16.18.244：/export/brick1/gv0替换为172.16.18.245:/export/brick1/gv0。在执行replcase-brick，使用start启动命令之后，开始将原始brick的数据迁移到即将需要替换的brick上</div><div class="line">gluster volume replace-brick gv0 172.16.18.244:/export/brick1/gv0  172.16.18.245:/export/brick1/gv0  start force</div><div class="line"></div><div class="line">//在数据迁移过程中，可以查看替换状态</div><div class="line">gluster volume replace-brick gv0 172.16.18.244:/export/brick1/gv0  172.16.18.245:/export/brick1/gv0  status</div><div class="line"></div><div class="line">// 在数据迁移的过程中，可以执行abort命令终止brick替换</div><div class="line">gluster volume replace-brick gv0 172.16.18.244:/export/brick1/gv0  172.16.18.245:/export/brick1/gv0 abort</div><div class="line"></div><div class="line">//当数据迁移结束之后，执行commit命令结束任务，则进行brick替换。使用volume info命令可以查看到brick已经被替换</div><div class="line">gluster volume replace-brick gv0 172.16.18.244:/export/brick1/gv0  172.16.18.245:/export/brick1/gv0  start</div></pre></td></tr></table></figure>
<hr>
<h2 id="系统拓展"><a href="#系统拓展" class="headerlink" title="系统拓展"></a>系统拓展</h2><h3 id="系统配额"><a href="#系统配额" class="headerlink" title="系统配额"></a>系统配额</h3><h4 id="开启、关闭系统配额"><a href="#开启、关闭系统配额" class="headerlink" title="开启、关闭系统配额"></a>开启、关闭系统配额</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">//在使用系统配额功能时，需要使用enable将其开启；disable为关闭命令</div><div class="line">gluster volume quota VOLNAME enable/disable</div></pre></td></tr></table></figure>
<h4 id="设置目录配额"><a href="#设置目录配额" class="headerlink" title="设置目录配额"></a>设置目录配额</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gluster volume quota VOLNAME limit-usage /directory limit-value</div><div class="line"></div><div class="line">//设置gv0卷下quota子目录目录限额为10GB，这个目录是以系统挂载目录为根目录，所以/quota即客户端挂载目录下的子目录</div><div class="line">gluster volume quota gv0 limit-usage /quota 10GB</div></pre></td></tr></table></figure>
<h4 id="配额查看"><a href="#配额查看" class="headerlink" title="配额查看"></a>配额查看</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">gluster volume quota VOLNAME list</div><div class="line">gluster volume quota VOLNAME list /directory_name</div><div class="line">//可以使用上面命令查看卷的配额，第一个查看全部配额设置，第二个可以根据目录查看，显示配额大小及当前使用容量，如无使用容量则说明设置的目录有误(不存在)</div><div class="line">gluster volume quota gv0 list</div></pre></td></tr></table></figure>
<h4 id="地域复制-geo-replication"><a href="#地域复制-geo-replication" class="headerlink" title="地域复制(geo-replication)"></a>地域复制(geo-replication)</h4><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">gluster volume geo-replication MASTER SLAVE start/status/stop</div><div class="line"></div><div class="line">//地域复制是系统提供的灾备功能，能够将系统的全部数据进行异步的增量备份到另外的磁盘中</div><div class="line">gluster volume geo-replication gv0 172.16.18.250:/export/brick/gv0 start</div><div class="line"></div><div class="line">//当开始执行gv0卷的所有内容备份到18.250下的/export/brick/gv0中的task，值得注意的是，这个备份目标不能是系统中的brick</div></pre></td></tr></table></figure>
<h4 id="I-O信息查看"><a href="#I-O信息查看" class="headerlink" title="I/O信息查看"></a>I/O信息查看</h4><p><code>profile command</code>提供了一个接口查看每个卷中的每个brick的io信息<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">// 启动profiling，之后便可以进行io查看</div><div class="line">gluster volume profile VOLNAME start</div><div class="line"></div><div class="line">// 查看io信息，可以查看到每个brick的io信息</div><div class="line">gluster volume profile VOLNAME info</div><div class="line"></div><div class="line">// 管理profilinig功能</div><div class="line">gluster volume profile VOLNAME stop</div></pre></td></tr></table></figure></p>
<h4 id="top监控"><a href="#top监控" class="headerlink" title="top监控"></a>top监控</h4><p><code>top command</code>允许你查看bricks的性能，read、write、file open calls、file read caclls、file write calls、directory open calls、directory read calls。所有的查看都可以设置top数，默认是1000<br><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">// 查看打开的fd</div><div class="line">gluster volume top VOLNAME open [brick BRICK-NAME] [list-cnt cnt]</div><div class="line"></div><div class="line">// 查看调用次数最多的读调用</div><div class="line">gluster volume top VOLNAME read [brick BRICK-NAME] [list-cnt cnt]</div><div class="line"></div><div class="line">// 查看调用次数最多的写调用</div><div class="line">gluster volume top VOLNAME write [brick BRICK-NAME] [list-cnt cnt]</div><div class="line"></div><div class="line">// 查看次数最多的目录调用</div><div class="line">gluster volume top opendir [brick BRICK-NAME] [list-cnt cnt]</div><div class="line">gluster volume top readdir [brick BRICK-NAME] [list-cnt cnt]</div><div class="line"></div><div class="line">//查看每个brick的读性能</div><div class="line">gluster volume top VOLNAME read-perf [bs blk-size count count] [brick BRICK-NAME] [list-cnt cnt]</div><div class="line"></div><div class="line">//查看每个brick的写性能</div><div class="line">gluster volume top VOLNAME write-perf [bs blk-size count count] [brick BRICK-NAME] [list-cnt cnt]</div></pre></td></tr></table></figure></p>
<hr>
<h3 id="Glusterfs冗余镜像（AFR）修复原理以及脑裂分析"><a href="#Glusterfs冗余镜像（AFR）修复原理以及脑裂分析" class="headerlink" title="Glusterfs冗余镜像（AFR）修复原理以及脑裂分析"></a>Glusterfs冗余镜像（AFR）修复原理以及脑裂分析</h3><h4 id="什么是脑裂"><a href="#什么是脑裂" class="headerlink" title="什么是脑裂"></a>什么是脑裂</h4><p>所谓脑裂，就是指两个或多个节点都“认为”自身是正常节点而互相“指责”对方，导致不能选取正确的节点进行接管或修复，导致脑裂状态。这种现象出现在数据修复、集群管理等等高可用场景。Glusterfs的冗余镜像（下文简称AFR）提供了数据副本功能，能够在即使只有一个冗余节点的情况下仍能正常工作，不中断上层应用。当节点恢复后，能够将数据修复到一致状态，保证数据的安全。</p>
<p><strong>AFR工作原理</strong></p>
<p>AFR数据修复主要涉及三个方面：ENTRY，META，DATA，我们以冗余度为2即含有两个副本A和B的DATA修复为例进行讲解。记录描述副本状态的称之为ChangeLog，记录在每个副本文件扩展属性里，读入内存后以矩阵形式判断是否需要修复以及要以哪个副本为Source进行修复。初始值以及正常值为0.（注：ENTRY和META,DATA分布对应着一个数值）。</p>
<p>Write的步骤可分解为：</p>
<ol>
<li>下发Write操作</li>
<li>加锁Lock</li>
<li>向A，B副本的ChangeLog分别加1，记录到各个副本的扩展属性中</li>
<li>对A，B副本进行写操作</li>
<li>若该副本写成功则ChangeLog减1，若该副本写失败则ChangLog值不变，记录到各个副本的扩展属性中</li>
<li>解锁UnLock</li>
<li><p>向上层返回，只要有一个副本写成功就返回成功。</p>
<p>上述在AFR中是完整的一个transaction动作。根据两个副本记录的ChangeLog的数值确定了副本的几种状态：</p>
</li>
<li><p>WISE，智慧的，即该副本的ChangeLog中对方对应的数值大于0而且自身对应的数值等于0.</p>
</li>
</ol>
<ul>
<li>INNOCENT，无辜的，即该副本上的ChangeLog即不指责对方也指责自己，ChangeLog全为0.</li>
</ul>
<ul>
<li>FOOL，愚蠢的，即该副本上的ChangeLog是指责自己的。</li>
</ul>
<ul>
<li>IGNORANT，忽略的，即该副本的ChangeLog丢失。</li>
</ul>
<p>所以一般情况下，会选取WISE的副本作为Sourse进行修复。但是当两个节点都是WISE状态时，这就出现了声名狼藉的脑裂状态。</p>
<p><strong>AFR脑裂</strong></p>
<p>两个副本均为WISE时发生脑裂，那么在哪种场景下会产生脑裂呢？我们还是以冗余度为2的情况举一个简单的例子：某文件X的两个副本位于物理机A和物理机B上，在A和B上分别运行着进程a和进程b，a和b持续通过各自所在的物理机上的客户端对文件X进行不同的写操作。然后物理机A和B之间网络中断，因为AFR在一个副本的情况下仍能不中断上层应用，所以进程a和进程b仍会持续运行，但因为网络中断，文件X在A和B上的副本数据不再一致且都认为对方是异常的，当网络恢复时，两个副本互相“指责”，即出现了脑裂。当然这是脑裂发生的场景之一，有时候是有可能发生脑裂，而有时候是必然发生脑裂。</p>
<p><a href="http://gluster.readthedocs.org/en/latest/Troubleshooting/split-brain/" target="_blank" rel="external">官方提供解决方案</a></p>
<h2 id="参考文献"><a href="#参考文献" class="headerlink" title="参考文献"></a>参考文献</h2><p><a href="http://gluster.readthedocs.org/en/latest/" target="_blank" rel="external">官方文档:http://gluster.readthedocs.org/en/latest/</a></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/05/Running/跑步日记-清明3天.html" itemprop="url">
                  跑步日记-清明三天
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-05T10:58:03+08:00" content="2016-04-05">
              2016-04-05
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/悦跑生活/" itemprop="url" rel="index">
                    <span itemprop="name">悦跑生活</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/05/Running/跑步日记-清明3天.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/05/Running/跑步日记-清明3天.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/05/Running/跑步日记-清明3天.html" class="leancloud_visitors" data-flag-title="跑步日记-清明三天">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>清明小长假三天，期间有一天休息调整。从开始500M就跑不动，到现在一口气3kM，下周目标，5KM。</p>
<p> <img src="http://www.zerounix.com\images\running\running_2016-04-01.JPG" alt="running_2016-04-01"></p>
<p> <img src="http://www.zerounix.com\images\running\running_2016-04-03.JPG" alt="running_2016-04-03"></p>
<p> <img src="http://www.zerounix.com\images\running\running_2016-04-04.JPG" alt="running_2016-04-04"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/01/saltstack-grains.html" itemprop="url">
                  SaltStack--Grains
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-01T17:02:33+08:00" content="2016-04-01">
              2016-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/01/saltstack-grains.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/01/saltstack-grains.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/01/saltstack-grains.html" class="leancloud_visitors" data-flag-title="SaltStack--Grains">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="什么是Grains"><a href="#什么是Grains" class="headerlink" title="什么是Grains"></a>什么是Grains</h1><p>Grains是SaltStack组件中非常重要的组件，在实际使部署配置中会经常使用到grains。Grains与Puppet中facter功能类似，存放minion启动时收集的静态信息，也可以理解为Grains记录每台minion的常用属性，例如CPU、内存、硬盘、网络等，在下次启动minion之前，grains收集的数据不会改变所以称之为静态信息。我们可以通过<code>grains.items</code>查看某台或多台minion的grains信息。grains信息是在每台minion在启动时上报到master，在实际应用中，经常会根据实际业务需求，自定义grains，自定义grains方法如下：</p>
<ul>
<li>通过minion配置文件定义</li>
<li>通过grains相关模块定义</li>
<li>通过python脚本定义</li>
</ul>
<h2 id="Grains常用操作"><a href="#Grains常用操作" class="headerlink" title="Grains常用操作"></a>Grains常用操作</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; sys.list_functions grains</div><div class="line">172.16.11.211:</div><div class="line">    - grains.append</div><div class="line">    - grains.delval</div><div class="line">    - grains.filter_by</div><div class="line">    - grains.get</div><div class="line">    - grains.get_or_set_hash</div><div class="line">    - grains.has_value</div><div class="line">    - grains.item</div><div class="line">    - grains.items</div><div class="line">    - grains.ls</div><div class="line">    - grains.remove</div><div class="line">    - grains.setval</div><div class="line">    - grains.setvals</div><div class="line"></div><div class="line">salt &apos;*&apos; grains.ls   //列出可用的grains    </div><div class="line">salt &apos;*&apos; grains.items   //列出所有grains的名称和内容</div></pre></td></tr></table></figure>
<hr>
<h2 id="定义Grains"><a href="#定义Grains" class="headerlink" title="定义Grains"></a>定义Grains</h2><h3 id="通过minion配置文件"><a href="#通过minion配置文件" class="headerlink" title="通过minion配置文件"></a>通过minion配置文件</h3><p>通过文件定义Grains，有三种格式符合YAML格式的</p>
<p><code>Key:value</code>：<code>os:CentOS</code></p>
<p>字典格式:<code>ip_interfaces: {&#39;lo&#39;: [&#39;127.0.0.1&#39;], &#39;em1&#39;: [&#39;172.16.11.211&#39;], em2: []}</code></p>
<p>多分行列表：</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">osmajorrrelease:</div><div class="line">    6</div><div class="line">    5</div></pre></td></tr></table></figure>
<p>修改minion配置文件，将<code>default_include: minion.d/*.conf</code>取消注释，并在<code>/etc/salt/minion.d/</code>添加grains配置文件</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">grains:                  //官方示例</div><div class="line">  roles:</div><div class="line">    - webserver</div><div class="line">    - memcache</div><div class="line">  deployment: datacenter4</div><div class="line">  cabinet: 13</div><div class="line">  cab_u: 14-15</div></pre></td></tr></table></figure>
<p>重启minion，使自定义grains生效</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; grains.item roles</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    roles:</div><div class="line">        - webserver</div><div class="line">        - memcache</div><div class="line">// 可以看到自定义的grainis已经生效</div></pre></td></tr></table></figure>
<h3 id="通过grains模块定义"><a href="#通过grains模块定义" class="headerlink" title="通过grains模块定义"></a>通过grains模块定义</h3><ul>
<li>设置自定义granins</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; grains.append salt &apos;Hello World&apos;     //自定义granins</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    salt:</div><div class="line">        - Hello World</div><div class="line"></div><div class="line">salt &apos;172.16.11.211&apos; grains.item salt                        // 查看grains</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    salt:</div><div class="line">        - Hello World</div></pre></td></tr></table></figure>
<ul>
<li>使用Grains.setvals同时设置多个grains</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; grains.setvals &quot;&#123;&apos;Salt&apos;: &apos;Hello&apos;, &apos;Stack&apos;: &apos;World&apos;&#125;&quot;</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    Salt:</div><div class="line">        Hello</div><div class="line">    Stack:</div><div class="line">        World</div></pre></td></tr></table></figure>
<ul>
<li>在_grains目录定义grains</li>
</ul>
<p>使用默认的master的<code>file_root配置路径 /srv/salt，那么_grains的位置是/srv/salt/_grains</code>，添加自定义grains item，注意的是python脚本返回值是一个字典。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">// 脚本内容</div><div class="line">def my_grains():</div><div class="line">    grains = &#123;&apos;zero&apos; : [&apos;HelloWorld&apos;]&#125;</div><div class="line">    return grains</div><div class="line"></div><div class="line">//推送_grains内模块到minion</div><div class="line">salt &apos;*&apos; saltutil.sync_grains</div><div class="line"></div><div class="line">// 查看新増grains</div><div class="line"> salt &apos;*&apos; grains.item zero</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    zero:</div><div class="line">        - HelloWorld</div><div class="line">//重新加载模块，刷新grains静态数据</div><div class="line">salt &apos;*&apos; sys.reload_modules</div></pre></td></tr></table></figure>
<p>在minin的<code>/var/cache/salt/minion/extmods/grains</code>目录下，可以找到master下发的grains文件</p>
<ul>
<li>删除自定义granins</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; grains.remove salt &apos;Hello SaltStack&apos;</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/01/markdown-syntax.html" itemprop="url">
                  Markdown简明语法说明
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-01T15:20:25+08:00" content="2016-04-01">
              2016-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/Markdown/" itemprop="url" rel="index">
                    <span itemprop="name">Markdown</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/01/markdown-syntax.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/01/markdown-syntax.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/01/markdown-syntax.html" class="leancloud_visitors" data-flag-title="Markdown简明语法说明">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<h1 id="什么是Markdown"><a href="#什么是Markdown" class="headerlink" title="什么是Markdown"></a>什么是Markdown</h1><p>Markdown 是一种轻量级标记语言，创始人为约翰·格鲁伯（John Gruber）。它允许人们“使用易读易写的纯文本格式编写文档，然后转换成有效的XHTML(或者HTML)文档”。目前被越来越多的写作爱好者、撰稿者广泛使用。</p>
<h1 id="Markdown语法说明"><a href="#Markdown语法说明" class="headerlink" title="Markdown语法说明"></a>Markdown语法说明</h1><p><a href="https://github.com/riku/Markdown-Syntax-CN/blob/master/syntax.md" target="_blank" rel="external">https://github.com/riku/Markdown-Syntax-CN/blob/master/syntax.md</a></p>
<ul>
<li><a href="#overview">概述</a><ul>
<li><a href="#philosophy">宗旨</a></li>
<li><a href="#html">兼容 HTML</a></li>
<li><a href="#autoescape">特殊字符自动转换</a></li>
</ul>
</li>
<li><a href="#block">区块元素</a><ul>
<li><a href="#p">段落和换行</a></li>
<li><a href="#header">标题</a></li>
<li><a href="#blockquote">区块引用</a></li>
<li><a href="#list">列表</a></li>
<li><a href="#precode">代码区块</a></li>
<li><a href="#hr">分隔线</a></li>
</ul>
</li>
<li><a href="#span">区段元素</a><ul>
<li><a href="#link">链接</a></li>
<li><a href="#em">强调</a></li>
<li><a href="#code">代码</a></li>
<li><a href="#img">图片</a></li>
</ul>
</li>
<li><a href="#misc">其它</a><ul>
<li><a href="#backslash">反斜杠</a></li>
<li><a href="#autolink">自动链接</a></li>
</ul>
</li>
<li><a href="#acknowledgement">感谢</a><ul>
<li><a href="#editor">Markdown 免费编辑器</a></li>
</ul>
</li>
</ul>
<hr>
<h2 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h2><h3 id="philosophy">宗旨</h3>

<p>Markdown 的目标是实现「易读易写」。</p>
<p>可读性，无论如何，都是最重要的。一份使用 Markdown 格式撰写的文件应该可以直接以纯文本发布，并且看起来不会像是由许多标签或是格式指令所构成。Markdown 语法受到一些既有 text-to-HTML 格式的影响，包括 <a href="http://docutils.sourceforge.net/mirror/setext.html" target="_blank" rel="external">Setext</a>、<a href="http://www.aaronsw.com/2002/atx/" target="_blank" rel="external">atx</a>、<a href="http://textism.com/tools/textile/" target="_blank" rel="external">Textile</a>、<a href="http://docutils.sourceforge.net/rst.html" target="_blank" rel="external">reStructuredText</a>、<a href="http://www.triptico.com/software/grutatxt.html" target="_blank" rel="external">Grutatext</a> 和 <a href="http://ettext.taint.org/doc/" target="_blank" rel="external">EtText</a>，而最大灵感来源其实是纯文本电子邮件的格式。</p>
<p>总之， Markdown 的语法全由一些符号所组成，这些符号经过精挑细选，其作用一目了然。比如：在文字两旁加上星号，看起来就像*强调*。Markdown 的列表看起来，嗯，就是列表。Markdown 的区块引用看起来就真的像是引用一段文字，就像你曾在电子邮件中见过的那样。</p>
<h3 id="html">兼容 HTML</h3>

<p>Markdown 语法的目标是：成为一种适用于网络的<em>书写</em>语言。</p>
<p>Markdown 并不是想取代 HTML的地位，甚至接近它。它的语法种类很少，只对应 HTML 标记的一小部分。Markdown 的构想<em>不是</em>要使得 HTML 文档更容易书写。在我看来， HTML 已经很容易写了。Markdown 的理念是，能让文档更容易读、写和随意改。HTML 是一种<em>发布</em>的格式，Markdown 是一种<em>书写</em>的格式。就这样，Markdown 的格式语法只涵盖纯文本可以涵盖的范围。</p>
<p>不在 Markdown 涵盖范围之内的标签，都可以直接在文档里面用 HTML 撰写。不需要额外标注这是 HTML 或是 Markdown；只要直接加标签就可以了。</p>
<p>要制约的只有一些 HTML 区块元素――比如 <code>&lt;div&gt;</code>、<code>&lt;table&gt;</code>、<code>&lt;pre&gt;</code>、<code>&lt;p&gt;</code> 等标签，必须在前后加上空行与其它内容区隔开，还要求它们的开始标签与结尾标签不能用制表符或空格来缩进。Markdown 的生成器有足够智能，不会在 HTML 区块标签外加上不必要的 <code>&lt;p&gt;</code> 标签。</p>
<p>例子如下，在 Markdown 文件里加上一段 HTML 表格：</p>
<pre><code>这是一个普通段落。

&lt;table&gt;
    &lt;tr&gt;
        &lt;td&gt;Foo&lt;/td&gt;
    &lt;/tr&gt;
&lt;/table&gt;

这是另一个普通段落。
</code></pre><p>请注意，在 HTML 区块标签间的 Markdown 格式语法将不会被处理。比如，你在 HTML 区块内使用 Markdown 样式的<code>*强调*</code>会没有效果。</p>
<p>HTML 的区段（行内）标签如 <code>&lt;span&gt;</code>、<code>&lt;cite&gt;</code>、<code>&lt;del&gt;</code> 可以在 Markdown 的段落、列表或是标题里随意使用。依照个人习惯，甚至可以不用 Markdown 格式，而直接采用 HTML 标签来格式化。举例说明：如果比较喜欢 HTML 的 <code>&lt;a&gt;</code> 或 <code>&lt;img&gt;</code> 标签，可以直接使用这些标签，而不用 Markdown 提供的链接或是图像标签语法。</p>
<p>和处在 HTML 区块标签间不同，Markdown 语法在 HTML 区段标签间是有效的。</p>
<h3 id="autoescape">特殊字符自动转换</h3>

<p>在 HTML 文件中，有两个字符需要特殊处理： <code>&lt;</code> 和 <code>&amp;</code> 。 <code>&lt;</code> 符号用于起始标签，<code>&amp;</code> 符号则用于标记 HTML 实体，如果你只是想要显示这些字符的原型，你必须要使用实体的形式，像是 <code>&amp;lt;</code> 和 <code>&amp;amp;</code>。</p>
<p><code>&amp;</code> 字符尤其让网络文档编写者受折磨，如果你要打「<code>AT&amp;T</code>」 ，你必须要写成「<code>AT&amp;amp;T</code>」。而网址中的 <code>&amp;</code> 字符也要转换。比如你要链接到：</p>
<pre><code>http://images.google.com/images?num=30&amp;q=larry+bird
</code></pre><p>你必须要把网址转换写为：</p>
<pre><code>http://images.google.com/images?num=30&amp;amp;q=larry+bird
</code></pre><p>才能放到链接标签的 <code>href</code> 属性里。不用说也知道这很容易忽略，这也可能是 HTML 标准检验所检查到的错误中，数量最多的。</p>
<p>Markdown 让你可以自然地书写字符，需要转换的由它来处理好了。如果你使用的 <code>&amp;</code> 字符是 HTML 字符实体的一部分，它会保留原状，否则它会被转换成 <code>&amp;amp</code>;。</p>
<p>所以你如果要在文档中插入一个版权符号 <code>©</code>，你可以这样写：</p>
<pre><code>&amp;copy;
</code></pre><p>Markdown 会保留它不动。而若你写：</p>
<pre><code>AT&amp;T
</code></pre><p>Markdown 就会将它转为：</p>
<pre><code>AT&amp;amp;T
</code></pre><p>类似的状况也会发生在 <code>&lt;</code> 符号上，因为 Markdown 允许 <a href="#html">兼容 HTML</a> ，如果你是把 <code>&lt;</code> 符号作为 HTML 标签的定界符使用，那 Markdown 也不会对它做任何转换，但是如果你写：</p>
<pre><code>4 &lt; 5
</code></pre><p>Markdown 将会把它转换为：</p>
<pre><code>4 &amp;lt; 5
</code></pre><p>不过需要注意的是，code 范围内，不论是行内还是区块， <code>&lt;</code> 和 <code>&amp;</code> 两个符号都<em>一定</em>会被转换成 HTML 实体，这项特性让你可以很容易地用 Markdown 写 HTML code （和 HTML 相对而言， HTML 语法中，你要把所有的 <code>&lt;</code> 和 <code>&amp;</code> 都转换为 HTML 实体，才能在 HTML 文件里面写出 HTML code。）</p>
<hr>
<h2 id="block">区块元素</h2>


<h3 id="p">段落和换行</h3>

<p>一个 Markdown 段落是由一个或多个连续的文本行组成，它的前后要有一个以上的空行（空行的定义是显示上看起来像是空的，便会被视为空行。比方说，若某一行只包含空格和制表符，则该行也会被视为空行）。普通段落不该用空格或制表符来缩进。</p>
<p>「由一个或多个连续的文本行组成」这句话其实暗示了 Markdown 允许段落内的强迫换行（插入换行符），这个特性和其他大部分的 text-to-HTML 格式不一样（包括 Movable Type 的「Convert Line Breaks」选项），其它的格式会把每个换行符都转成 <code>&lt;br /&gt;</code> 标签。</p>
<p>如果你<em>确实</em>想要依赖 Markdown 来插入 <code>&lt;br /&gt;</code> 标签的话，在插入处先按入两个以上的空格然后回车。</p>
<p>的确，需要多费点事（多加空格）来产生 <code>&lt;br /&gt;</code> ，但是简单地「每个换行都转换为 <code>&lt;br /&gt;</code>」的方法在 Markdown 中并不适合， Markdown 中 email 式的 <a href="#blockquote">区块引用</a> 和多段落的 <a href="#list">列表</a> 在使用换行来排版的时候，不但更好用，还更方便阅读。</p>
<h3 id="header">标题</h3>

<p>Markdown 支持两种标题的语法，类 <a href="http://docutils.sourceforge.net/mirror/setext.html" target="_blank" rel="external">Setext</a> 和类 <a href="http://www.aaronsw.com/2002/atx/" target="_blank" rel="external">atx</a> 形式。</p>
<p>类 Setext 形式是用底线的形式，利用 <code>=</code> （最高阶标题）和 <code>-</code> （第二阶标题），例如：</p>
<pre><code>This is an H1
=============

This is an H2
-------------
</code></pre><p>任何数量的 <code>=</code> 和 <code>-</code> 都可以有效果。</p>
<p>类 Atx 形式则是在行首插入 1 到 6 个 <code>#</code> ，对应到标题 1 到 6 阶，例如：</p>
<pre><code># 这是 H1

## 这是 H2

###### 这是 H6
</code></pre><p>你可以选择性地「闭合」类 atx 样式的标题，这纯粹只是美观用的，若是觉得这样看起来比较舒适，你就可以在行尾加上 <code>#</code>，而行尾的 <code>#</code> 数量也不用和开头一样（行首的井字符数量决定标题的阶数）：</p>
<pre><code># 这是 H1 #

## 这是 H2 ##

### 这是 H3 ######
</code></pre><h3 id="blockquote">区块引用 Blockquotes</h3>

<p>Markdown 标记区块引用是使用类似 email 中用 <code>&gt;</code> 的引用方式。如果你还熟悉在 email 信件中的引言部分，你就知道怎么在 Markdown 文件中建立一个区块引用，那会看起来像是你自己先断好行，然后在每行的最前面加上 <code>&gt;</code> ：</p>
<pre><code>&gt; This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,
&gt; consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.
&gt; Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.
&gt;
&gt; Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse
&gt; id sem consectetuer libero luctus adipiscing.
</code></pre><p>Markdown 也允许你偷懒只在整个段落的第一行最前面加上 <code>&gt;</code> ：</p>
<pre><code>&gt; This is a blockquote with two paragraphs. Lorem ipsum dolor sit amet,
consectetuer adipiscing elit. Aliquam hendrerit mi posuere lectus.
Vestibulum enim wisi, viverra nec, fringilla in, laoreet vitae, risus.

&gt; Donec sit amet nisl. Aliquam semper ipsum sit amet velit. Suspendisse
id sem consectetuer libero luctus adipiscing.
</code></pre><p>区块引用可以嵌套（例如：引用内的引用），只要根据层次加上不同数量的 <code>&gt;</code> ：</p>
<pre><code>&gt; This is the first level of quoting.
&gt;
&gt; &gt; This is nested blockquote.
&gt;
&gt; Back to the first level.
</code></pre><p>引用的区块内也可以使用其他的 Markdown 语法，包括标题、列表、代码区块等：</p>
<pre><code>&gt; ## 这是一个标题。
&gt;
&gt; 1.   这是第一行列表项。
&gt; 2.   这是第二行列表项。
&gt;
&gt; 给出一些例子代码：
&gt;
&gt;     return shell_exec(&quot;echo $input | $markdown_script&quot;);
</code></pre><p>任何像样的文本编辑器都能轻松地建立 email 型的引用。例如在 BBEdit 中，你可以选取文字后然后从选单中选择<em>增加引用阶层</em>。</p>
<h3 id="list">列表</h3>

<p>Markdown 支持有序列表和无序列表。</p>
<p>无序列表使用星号、加号或是减号作为列表标记：</p>
<pre><code>*   Red
*   Green
*   Blue
</code></pre><p>效果就是</p>
<ul>
<li>red</li>
<li>green</li>
<li>blue</li>
</ul>
<p>等同于：</p>
<pre><code>+   Red
+   Green
+   Blue
</code></pre><p>也等同于：</p>
<pre><code>-   Red
-   Green
-   Blue
</code></pre><p>有序列表则使用数字接着一个英文句点：</p>
<pre><code>1.  Bird
2.  McHale
3.  Parish
</code></pre><p>很重要的一点是，你在列表标记上使用的数字并不会影响输出的 HTML 结果，上面的列表所产生的 HTML 标记为：</p>
<pre><code>&lt;ol&gt;
&lt;li&gt;Bird&lt;/li&gt;
&lt;li&gt;McHale&lt;/li&gt;
&lt;li&gt;Parish&lt;/li&gt;
&lt;/ol&gt;
</code></pre><p>如果你的列表标记写成：</p>
<pre><code>1.  Bird
1.  McHale
1.  Parish
</code></pre><p>或甚至是：</p>
<pre><code>3. Bird
1. McHale
8. Parish
</code></pre><p>你都会得到完全相同的 HTML 输出。重点在于，你可以让 Markdown 文件的列表数字和输出的结果相同，或是你懒一点，你可以完全不用在意数字的正确性。</p>
<p>如果你使用懒惰的写法，建议第一个项目最好还是从 1. 开始，因为 Markdown 未来可能会支持有序列表的 start 属性。</p>
<p>列表项目标记通常是放在最左边，但是其实也可以缩进，最多 3 个空格，项目标记后面则一定要接着至少一个空格或制表符。</p>
<p>要让列表看起来更漂亮，你可以把内容用固定的缩进整理好：</p>
<pre><code>*   Lorem ipsum dolor sit amet, consectetuer adipiscing elit.
    Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,
    viverra nec, fringilla in, laoreet vitae, risus.
*   Donec sit amet nisl. Aliquam semper ipsum sit amet velit.
    Suspendisse id sem consectetuer libero luctus adipiscing.
</code></pre><p>但是如果你懒，那也行：</p>
<pre><code>*   Lorem ipsum dolor sit amet, consectetuer adipiscing elit.
Aliquam hendrerit mi posuere lectus. Vestibulum enim wisi,
viverra nec, fringilla in, laoreet vitae, risus.
*   Donec sit amet nisl. Aliquam semper ipsum sit amet velit.
Suspendisse id sem consectetuer libero luctus adipiscing.
</code></pre><p>如果列表项目间用空行分开，在输出 HTML 时 Markdown 就会将项目内容用 <code>&lt;p&gt;</code><br>标签包起来，举例来说：</p>
<pre><code>*   Bird
*   Magic
</code></pre><p>会被转换为：</p>
<pre><code>&lt;ul&gt;
&lt;li&gt;Bird&lt;/li&gt;
&lt;li&gt;Magic&lt;/li&gt;
&lt;/ul&gt;
</code></pre><p>但是这个：</p>
<pre><code>*   Bird

*   Magic
</code></pre><p>会被转换为：</p>
<pre><code>&lt;ul&gt;
&lt;li&gt;&lt;p&gt;Bird&lt;/p&gt;&lt;/li&gt;
&lt;li&gt;&lt;p&gt;Magic&lt;/p&gt;&lt;/li&gt;
&lt;/ul&gt;
</code></pre><p>列表项目可以包含多个段落，每个项目下的段落都必须缩进 4 个空格或是 1 个制表符：</p>
<pre><code>1.  This is a list item with two paragraphs. Lorem ipsum dolor
    sit amet, consectetuer adipiscing elit. Aliquam hendrerit
    mi posuere lectus.

    Vestibulum enim wisi, viverra nec, fringilla in, laoreet
    vitae, risus. Donec sit amet nisl. Aliquam semper ipsum
    sit amet velit.

2.  Suspendisse id sem consectetuer libero luctus adipiscing.
</code></pre><p>如果你每行都有缩进，看起来会看好很多，当然，再次地，如果你很懒惰，Markdown 也允许：</p>
<pre><code>*   This is a list item with two paragraphs.

    This is the second paragraph in the list item. You&apos;re
only required to indent the first line. Lorem ipsum dolor
sit amet, consectetuer adipiscing elit.

*   Another item in the same list.
</code></pre><p>如果要在列表项目内放进引用，那 <code>&gt;</code> 就需要缩进：</p>
<pre><code>*   A list item with a blockquote:

    &gt; This is a blockquote
    &gt; inside a list item.
</code></pre><p>如果要放代码区块的话，该区块就需要缩进<em>两次</em>，也就是 8 个空格或是 2 个制表符：</p>
<pre><code>*   一列表项包含一个列表区块：

        &lt;代码写在这&gt;
</code></pre><p>当然，项目列表很可能会不小心产生，像是下面这样的写法：</p>
<pre><code>1986. What a great season.
</code></pre><p>换句话说，也就是在行首出现<em>数字-句点-空白</em>，要避免这样的状况，你可以在句点前面加上反斜杠。</p>
<pre><code>1986\. What a great season.
</code></pre><h3 id="precode">代码区块</h3>

<p>和程序相关的写作或是标签语言原始码通常会有已经排版好的代码区块，通常这些区块我们并不希望它以一般段落文件的方式去排版，而是照原来的样子显示，Markdown 会用 <code>&lt;pre&gt;</code> 和 <code>&lt;code&gt;</code> 标签来把代码区块包起来。</p>
<p>要在 Markdown 中建立代码区块很简单，只要简单地缩进 4 个空格或是 1 个制表符就可以，例如，下面的输入：</p>
<pre><code>这是一个普通段落：

    这是一个代码区块。
</code></pre><p>Markdown 会转换成：</p>
<pre><code>&lt;p&gt;这是一个普通段落：&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;这是一个代码区块。
&lt;/code&gt;&lt;/pre&gt;
</code></pre><p>这个每行一阶的缩进（4 个空格或是 1 个制表符），都会被移除，例如：</p>
<pre><code>Here is an example of AppleScript:

    tell application &quot;Foo&quot;
        beep
    end tell
</code></pre><p>会被转换为：</p>
<pre><code>&lt;p&gt;Here is an example of AppleScript:&lt;/p&gt;

&lt;pre&gt;&lt;code&gt;tell application &quot;Foo&quot;
    beep
end tell
&lt;/code&gt;&lt;/pre&gt;
</code></pre><p>一个代码区块会一直持续到没有缩进的那一行（或是文件结尾）。</p>
<p>在代码区块里面， <code>&amp;</code> 、 <code>&lt;</code> 和 <code>&gt;</code> 会自动转成 HTML 实体，这样的方式让你非常容易使用 Markdown 插入范例用的 HTML 原始码，只需要复制贴上，再加上缩进就可以了，剩下的 Markdown 都会帮你处理，例如：</p>
<pre><code>&lt;div class=&quot;footer&quot;&gt;
    &amp;copy; 2004 Foo Corporation
&lt;/div&gt;
</code></pre><p>会被转换为：</p>
<pre><code>&lt;pre&gt;&lt;code&gt;&amp;lt;div class=&quot;footer&quot;&amp;gt;
    &amp;amp;copy; 2004 Foo Corporation
&amp;lt;/div&amp;gt;
&lt;/code&gt;&lt;/pre&gt;
</code></pre><p>代码区块中，一般的 Markdown 语法不会被转换，像是星号便只是星号，这表示你可以很容易地以 Markdown 语法撰写 Markdown 语法相关的文件。</p>
<h3 id="hr">分隔线</h3>

<p>你可以在一行中用三个以上的星号、减号、底线来建立一个分隔线，行内不能有其他东西。你也可以在星号或是减号中间插入空格。下面每种写法都可以建立分隔线：</p>
<pre><code>* * *

***

*****

- - -

---------------------------------------
</code></pre><hr>
<h2 id="span">区段元素</h2>

<h3 id="link">链接</h3>

<p>Markdown 支持两种形式的链接语法： <em>行内式</em>和<em>参考式</em>两种形式。</p>
<p>不管是哪一种，链接文字都是用 [方括号] 来标记。</p>
<p>要建立一个<em>行内式</em>的链接，只要在方块括号后面紧接着圆括号并插入网址链接即可，如果你还想要加上链接的 title 文字，只要在网址后面，用双引号把 title 文字包起来即可，例如：</p>
<pre><code>This is [an example](http://example.com/ &quot;Title&quot;) inline link.

[This link](http://example.net/) has no title attribute.
</code></pre><p>会产生：</p>
<pre><code>&lt;p&gt;This is &lt;a href=&quot;http://example.com/&quot; title=&quot;Title&quot;&gt;
an example&lt;/a&gt; inline link.&lt;/p&gt;

&lt;p&gt;&lt;a href=&quot;http://example.net/&quot;&gt;This link&lt;/a&gt; has no
title attribute.&lt;/p&gt;
</code></pre><p>如果你是要链接到同样主机的资源，你可以使用相对路径：</p>
<pre><code>See my [About](/about/) page for details.   
</code></pre><p><em>参考式</em>的链接是在链接文字的括号后面再接上另一个方括号，而在第二个方括号里面要填入用以辨识链接的标记：</p>
<pre><code>This is [an example][id] reference-style link.
</code></pre><p>你也可以选择性地在两个方括号中间加上一个空格：</p>
<pre><code>This is [an example] [id] reference-style link.
</code></pre><p>接着，在文件的任意处，你可以把这个标记的链接内容定义出来：</p>
<pre><code>[id]: http://example.com/  &quot;Optional Title Here&quot;
</code></pre><p>链接内容定义的形式为：</p>
<ul>
<li>方括号（前面可以选择性地加上至多三个空格来缩进），里面输入链接文字</li>
<li>接着一个冒号</li>
<li>接着一个以上的空格或制表符</li>
<li>接着链接的网址</li>
<li>选择性地接着 title 内容，可以用单引号、双引号或是括弧包着</li>
</ul>
<p>下面这三种链接的定义都是相同：</p>
<pre><code>[foo]: http://example.com/  &quot;Optional Title Here&quot;
[foo]: http://example.com/  &apos;Optional Title Here&apos;
[foo]: http://example.com/  (Optional Title Here)
</code></pre><p><strong>请注意：</strong>有一个已知的问题是 Markdown.pl 1.0.1 会忽略单引号包起来的链接 title。</p>
<p>链接网址也可以用尖括号包起来：</p>
<pre><code>[id]: &lt;http://example.com/&gt;  &quot;Optional Title Here&quot;
</code></pre><p>你也可以把 title 属性放到下一行，也可以加一些缩进，若网址太长的话，这样会比较好看：</p>
<pre><code>[id]: http://example.com/longish/path/to/resource/here
    &quot;Optional Title Here&quot;
</code></pre><p>网址定义只有在产生链接的时候用到，并不会直接出现在文件之中。</p>
<p>链接辨别标签可以有字母、数字、空白和标点符号，但是并<em>不</em>区分大小写，因此下面两个链接是一样的：</p>
<pre><code>[link text][a]
[link text][A]
</code></pre><p><em>隐式链接标记</em>功能让你可以省略指定链接标记，这种情形下，链接标记会视为等同于链接文字，要用隐式链接标记只要在链接文字后面加上一个空的方括号，如果你要让 “Google” 链接到 google.com，你可以简化成：</p>
<pre><code>[Google][]
</code></pre><p>然后定义链接内容：</p>
<pre><code>[Google]: http://google.com/
</code></pre><p>由于链接文字可能包含空白，所以这种简化型的标记内也许包含多个单词：</p>
<pre><code>Visit [Daring Fireball][] for more information.
</code></pre><p>然后接着定义链接：</p>
<pre><code>[Daring Fireball]: http://daringfireball.net/
</code></pre><p>链接的定义可以放在文件中的任何一个地方，我比较偏好直接放在链接出现段落的后面，你也可以把它放在文件最后面，就像是注解一样。</p>
<p>下面是一个参考式链接的范例：</p>
<pre><code>I get 10 times more traffic from [Google] [1] than from
[Yahoo] [2] or [MSN] [3].

  [1]: http://google.com/        &quot;Google&quot;
  [2]: http://search.yahoo.com/  &quot;Yahoo Search&quot;
  [3]: http://search.msn.com/    &quot;MSN Search&quot;
</code></pre><p>如果改成用链接名称的方式写：</p>
<pre><code>I get 10 times more traffic from [Google][] than from
[Yahoo][] or [MSN][].

  [google]: http://google.com/        &quot;Google&quot;
  [yahoo]:  http://search.yahoo.com/  &quot;Yahoo Search&quot;
  [msn]:    http://search.msn.com/    &quot;MSN Search&quot;
</code></pre><p>上面两种写法都会产生下面的 HTML。</p>
<pre><code>&lt;p&gt;I get 10 times more traffic from &lt;a href=&quot;http://google.com/&quot;
title=&quot;Google&quot;&gt;Google&lt;/a&gt; than from
&lt;a href=&quot;http://search.yahoo.com/&quot; title=&quot;Yahoo Search&quot;&gt;Yahoo&lt;/a&gt;
or &lt;a href=&quot;http://search.msn.com/&quot; title=&quot;MSN Search&quot;&gt;MSN&lt;/a&gt;.&lt;/p&gt;
</code></pre><p>下面是用行内式写的同样一段内容的 Markdown 文件，提供作为比较之用：</p>
<pre><code>I get 10 times more traffic from [Google](http://google.com/ &quot;Google&quot;)
than from [Yahoo](http://search.yahoo.com/ &quot;Yahoo Search&quot;) or
[MSN](http://search.msn.com/ &quot;MSN Search&quot;).
</code></pre><p>参考式的链接其实重点不在于它比较好写，而是它比较好读，比较一下上面的范例，使用参考式的文章本身只有 81 个字符，但是用行内形式的却会增加到 176 个字元，如果是用纯 HTML 格式来写，会有 234 个字元，在 HTML 格式中，标签比文本还要多。</p>
<p>使用 Markdown 的参考式链接，可以让文件更像是浏览器最后产生的结果，让你可以把一些标记相关的元数据移到段落文字之外，你就可以增加链接而不让文章的阅读感觉被打断。</p>
<h3 id="em">强调</h3>

<p>Markdown 使用星号（<code>*</code>）和底线（<code>_</code>）作为标记强调字词的符号，被 <code>*</code> 或 <code>_</code> 包围的字词会被转成用 <code>&lt;em&gt;</code> 标签包围，用两个 <code>*</code> 或 <code>_</code> 包起来的话，则会被转成 <code>&lt;strong&gt;</code>，例如：</p>
<pre><code>*single asterisks*

_single underscores_

**double asterisks**

__double underscores__
</code></pre><p>会转成：</p>
<pre><code>&lt;em&gt;single asterisks&lt;/em&gt;

&lt;em&gt;single underscores&lt;/em&gt;

&lt;strong&gt;double asterisks&lt;/strong&gt;

&lt;strong&gt;double underscores&lt;/strong&gt;
</code></pre><p>你可以随便用你喜欢的样式，唯一的限制是，你用什么符号开启标签，就要用什么符号结束。</p>
<p>强调也可以直接插在文字中间：</p>
<pre><code>un*frigging*believable
</code></pre><p>但是<strong>如果你的 <code>*</code> 和 <code>_</code> 两边都有空白的话，它们就只会被当成普通的符号</strong>。</p>
<p>如果要在文字前后直接插入普通的星号或底线，你可以用反斜线：</p>
<pre><code>\*this text is surrounded by literal asterisks\*
</code></pre><h3 id="code">代码</h3>

<p>如果要标记一小段行内代码，你可以用反引号把它包起来（<code>` </code>），例如：</p>
<pre><code>Use the `printf()` function.
</code></pre><p>会产生：</p>
<pre><code>&lt;p&gt;Use the &lt;code&gt;printf()&lt;/code&gt; function.&lt;/p&gt;
</code></pre><p>如果要在代码区段内插入反引号，你可以用多个反引号来开启和结束代码区段：</p>
<pre><code>``There is a literal backtick (`) here.``
</code></pre><p>这段语法会产生：</p>
<pre><code>&lt;p&gt;&lt;code&gt;There is a literal backtick (`) here.&lt;/code&gt;&lt;/p&gt;
</code></pre><p>代码区段的起始和结束端都可以放入一个空白，起始端后面一个，结束端前面一个，这样你就可以在区段的一开始就插入反引号：</p>
<pre><code>A single backtick in a code span: `` ` ``

A backtick-delimited string in a code span: `` `foo` ``
</code></pre><p>会产生：</p>
<pre><code>&lt;p&gt;A single backtick in a code span: &lt;code&gt;`&lt;/code&gt;&lt;/p&gt;

&lt;p&gt;A backtick-delimited string in a code span: &lt;code&gt;`foo`&lt;/code&gt;&lt;/p&gt;
</code></pre><p>在代码区段内，<code>&amp;</code> 和尖括号<strong>都</strong>会被自动地转成 HTML 实体，这使得插入 HTML 原始码变得很容易，Markdown 会把下面这段：</p>
<pre><code>Please don&apos;t use any `&lt;blink&gt;` tags.
</code></pre><p>转为：</p>
<pre><code>&lt;p&gt;Please don&apos;t use any &lt;code&gt;&amp;lt;blink&amp;gt;&lt;/code&gt; tags.&lt;/p&gt;
</code></pre><p>你也可以这样写：</p>
<pre><code>`&amp;#8212;` is the decimal-encoded equivalent of `&amp;mdash;`.
</code></pre><p>以产生：</p>
<pre><code>&lt;p&gt;&lt;code&gt;&amp;amp;#8212;&lt;/code&gt; is the decimal-encoded
equivalent of &lt;code&gt;&amp;amp;mdash;&lt;/code&gt;.&lt;/p&gt;
</code></pre><h3 id="img">图片</h3>

<p>很明显地，要在纯文字应用中设计一个「自然」的语法来插入图片是有一定难度的。</p>
<p>Markdown 使用一种和链接很相似的语法来标记图片，同样也允许两种样式： <em>行内式</em>和<em>参考式</em>。</p>
<p>行内式的图片语法看起来像是：</p>
<pre><code>![Alt text](/path/to/img.jpg)

![Alt text](/path/to/img.jpg &quot;Optional title&quot;)
</code></pre><p>详细叙述如下：</p>
<ul>
<li>一个惊叹号 <code>!</code></li>
<li>接着一个方括号，里面放上图片的替代文字</li>
<li>接着一个普通括号，里面放上图片的网址，最后还可以用引号包住并加上<br>选择性的 ‘title’ 文字。</li>
</ul>
<p>参考式的图片语法则长得像这样：</p>
<pre><code>![Alt text][id]
</code></pre><p>「id」是图片参考的名称，图片参考的定义方式则和链接参考一样：</p>
<pre><code>[id]: url/to/image  &quot;Optional title attribute&quot;
</code></pre><p>到目前为止， Markdown 还没有办法指定图片的宽高，如果你需要的话，你可以使用普通的 <code>&lt;img&gt;</code> 标签。</p>
<hr>
<h2 id="misc">其它</h2>

<h3 id="autolink">自动链接</h3>

<p>Markdown 支持以比较简短的自动链接形式来处理网址和电子邮件信箱，只要是用尖括号包起来， Markdown 就会自动把它转成链接。一般网址的链接文字就和链接地址一样，例如：</p>
<pre><code>&lt;http://example.com/&gt;
</code></pre><p>Markdown 会转为：</p>
<pre><code>&lt;a href=&quot;http://example.com/&quot;&gt;http://example.com/&lt;/a&gt;
</code></pre><p>邮址的自动链接也很类似，只是 Markdown 会先做一个编码转换的过程，把文字字符转成 16 进位码的 HTML 实体，这样的格式可以糊弄一些不好的邮址收集机器人，例如：</p>
<pre><code>&lt;address@example.com&gt;
</code></pre><p>Markdown 会转成：</p>
<pre><code>&lt;a href=&quot;&amp;#x6D;&amp;#x61;i&amp;#x6C;&amp;#x74;&amp;#x6F;:&amp;#x61;&amp;#x64;&amp;#x64;&amp;#x72;&amp;#x65;
&amp;#115;&amp;#115;&amp;#64;&amp;#101;&amp;#120;&amp;#x61;&amp;#109;&amp;#x70;&amp;#x6C;e&amp;#x2E;&amp;#99;&amp;#111;
&amp;#109;&quot;&gt;&amp;#x61;&amp;#x64;&amp;#x64;&amp;#x72;&amp;#x65;&amp;#115;&amp;#115;&amp;#64;&amp;#101;&amp;#120;&amp;#x61;
&amp;#109;&amp;#x70;&amp;#x6C;e&amp;#x2E;&amp;#99;&amp;#111;&amp;#109;&lt;/a&gt;
</code></pre><p>在浏览器里面，这段字串（其实是 <code>&lt;a href=&quot;mailto:address@example.com&quot;&gt;address@example.com&lt;/a&gt;</code>）会变成一个可以点击的「address@example.com」链接。</p>
<p>（这种作法虽然可以糊弄不少的机器人，但并不能全部挡下来，不过总比什么都不做好些。不管怎样，公开你的信箱终究会引来广告信件的。）</p>
<h3 id="backslash">反斜杠</h3>

<p>Markdown 可以利用反斜杠来插入一些在语法中有其它意义的符号，例如：如果你想要用星号加在文字旁边的方式来做出强调效果（但不用 <code>&lt;em&gt;</code> 标签），你可以在星号的前面加上反斜杠：</p>
<pre><code>\*literal asterisks\*
</code></pre><p>Markdown 支持以下这些符号前面加上反斜杠来帮助插入普通的符号：</p>
<pre><code>\   反斜线
`   反引号
*   星号
_   底线
{}  花括号
[]  方括号
()  括弧
#   井字号
+   加号
-   减号
.   英文句点
!   惊叹号
</code></pre><h2 id="acknowledgement">感谢</h2>

<p>感谢 <a href="https://twitter.com/#!/leafy7382" target="_blank" rel="external">leafy7382</a> 协助翻译，<a href="http://iamhlb.com/" target="_blank" rel="external">hlb</a>、<a href="http://twitter.com/randylien" target="_blank" rel="external">Randylien</a> 帮忙润稿，<a href="https://twitter.com/#!/ethantw" target="_blank" rel="external">ethantw</a> 的<a href="http://ethantw.net/projects/han/" target="_blank" rel="external">汉字标准格式・CSS Reset</a>， <a href="http://kidwm.net/" target="_blank" rel="external">WM</a> 回报文字错误。</p>
<p>感谢 <a href="https://github.com/fenprace" target="_blank" rel="external">fenprace</a>，<a href="https://github.com/addv" target="_blank" rel="external">addv</a>。</p>
<hr>
<h2 id="editor">Markdown 免费编辑器</h2>

<p>Windows 平台</p>
<ul>
<li><a href="http://markdownpad.com/" target="_blank" rel="external">MarkdownPad</a></li>
<li><a href="http://code52.org/DownmarkerWPF/" target="_blank" rel="external">MarkPad</a></li>
</ul>
<p>Linux 平台</p>
<ul>
<li><a href="http://sourceforge.net/p/retext/home/ReText/" target="_blank" rel="external">ReText</a></li>
</ul>
<p>Mac 平台</p>
<ul>
<li><a href="http://mouapp.com/" target="_blank" rel="external">Mou</a></li>
</ul>
<p>在线编辑器</p>
<ul>
<li><a href="http://markable.in/" target="_blank" rel="external">Markable.in</a></li>
<li><a href="http://dillinger.io/" target="_blank" rel="external">Dillinger.io</a></li>
</ul>
<p>浏览器插件</p>
<ul>
<li><a href="https://chrome.google.com/webstore/detail/oknndfeeopgpibecfjljjfanledpbkog" target="_blank" rel="external">MaDe</a> (Chrome)</li>
</ul>
<p>高级应用</p>
<ul>
<li><a href="http://www.sublimetext.com/2" target="_blank" rel="external">Sublime Text 2</a> + <a href="http://ttscoff.github.com/MarkdownEditing/" target="_blank" rel="external">MarkdownEditing</a> / <a href="http://lucifr.com/2012/07/12/markdownediting-for-sublime-text-2/" target="_blank" rel="external">教程</a></li>
</ul>
<p>*** 如有更好的 Markdown 免费编辑器推荐，请到<a href="https://gitcafe.com/riku/Markdown-Syntax-CN/tickets/1" target="_blank" rel="external">这里反馈</a>，谢谢！</p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/04/01/Running/跑步日记-2016-03-31.html" itemprop="url">
                  跑步日记-2016-03-31
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-04-01T10:58:03+08:00" content="2016-04-01">
              2016-04-01
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/悦跑生活/" itemprop="url" rel="index">
                    <span itemprop="name">悦跑生活</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/04/01/Running/跑步日记-2016-03-31.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/04/01/Running/跑步日记-2016-03-31.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/04/01/Running/跑步日记-2016-03-31.html" class="leancloud_visitors" data-flag-title="跑步日记-2016-03-31">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <a id="more"></a>
<p>今天跑步时间做了调整，由晨跑变成了夜跑，因为早起对我来说实在有些困难。不过晚上的状态相对昨天有了提高，中途也休息了几次，但是明显比昨天跑的轻松。 <img src="http://www.zerounix.com/images/running/running_2106-03-31.jpg" alt="running_2106-03-31"></p>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/31/saltstack-target.html" itemprop="url">
                  SaltStack--target
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-31T17:32:59+08:00" content="2016-03-31">
              2016-03-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/31/saltstack-target.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/31/saltstack-target.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/31/saltstack-target.html" class="leancloud_visitors" data-flag-title="SaltStack--target">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          <p>本文总结了SaltStack如何定位目标主机，以及介绍一些常用的使用案例.<br>
          <div class="post-more-link text-center">
            <a class="btn" href="/2016/03/31/saltstack-target.html#more" rel="contents">
              阅读全文 &raquo;
            </a>
          </div>
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
      

  
  

  
  
  

  <article class="post post-type-normal " itemscope itemtype="//schema.org/Article">

    
      <header class="post-header">

        
        
          <h1 class="post-title" itemprop="name headline">
            
            
              
                
                <a class="post-title-link" href="/2016/03/31/saltstack-install.html" itemprop="url">
                  SaltStack--安装
                </a>
              
            
          </h1>
        

        <div class="post-meta">
          <span class="post-time">
            <span class="post-meta-item-icon">
              <i class="fa fa-calendar-o"></i>
            </span>
            <span class="post-meta-item-text">发表于</span>
            <time itemprop="dateCreated" datetime="2016-03-31T11:21:59+08:00" content="2016-03-31">
              2016-03-31
            </time>
          </span>

          
            <span class="post-category" >
              &nbsp; | &nbsp;
              <span class="post-meta-item-icon">
                <i class="fa fa-folder-o"></i>
              </span>
              <span class="post-meta-item-text">分类于</span>
              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/" itemprop="url" rel="index">
                    <span itemprop="name">运维自动化</span>
                  </a>
                </span>

                
                
                  ， 
                

              
                <span itemprop="about" itemscope itemtype="https://schema.org/Thing">
                  <a href="/categories/运维自动化/SaltStack/" itemprop="url" rel="index">
                    <span itemprop="name">SaltStack</span>
                  </a>
                </span>

                
                

              
            </span>
          

          
            
              <span class="post-comments-count">
                &nbsp; | &nbsp;
                <a href="/2016/03/31/saltstack-install.html#comments" itemprop="discussionUrl">
                  <span class="post-comments-count ds-thread-count" data-thread-key="2016/03/31/saltstack-install.html" itemprop="commentsCount"></span>
                </a>
              </span>
            
          

          

          
          
             <span id="/2016/03/31/saltstack-install.html" class="leancloud_visitors" data-flag-title="SaltStack--安装">
               &nbsp; | &nbsp;
               <span class="post-meta-item-icon">
                 <i class="fa fa-eye"></i>
               </span>
               <span class="post-meta-item-text">阅读次数 </span>
               <span class="leancloud-visitors-count"></span>
              </span>
          

          
        </div>
      </header>
    


    <div class="post-body" itemprop="articleBody">

      
      

      
        
          
            <h2 id="初识SaltStack"><a href="#初识SaltStack" class="headerlink" title="初识SaltStack"></a>初识SaltStack</h2><h3 id="什么是SaltStack"><a href="#什么是SaltStack" class="headerlink" title="什么是SaltStack"></a>什么是SaltStack</h3><p>SaltStack是继Puppet、Chef之后新出现的配置管理及远程执行工具。SaltStack是基于Python开发的一套C/S架构配置关机工具，底层使用ZeroMQ消息队列pub/sub方式通信，使用SSL证书剪发的方式进行认证管理。与Puppet相比，SaltStack没有那么笨重，较为轻量，不想Puppet有一套自己的DSL用来编写配置。SaltStack使用YAML作为配置文件格式，这样写起来既简单有容易，同时也便于动态生成；此外SaltStack在远程执行命令时的速度也非常快，并包含丰富的模块，SaltStack很好的包含了状态管理的优点，大大提好运维人员的工作效率。简单总结有两大用处：</p>
<ul>
<li><strong>配置管理系统，能够维护预定义状态的远程节点（比如，确保指定的软件包被安装和特定的服务在运行）</strong></li>
<li><strong>一个分布式远程执行系统，用来在远程节点上执行命令和查询数据，可以单个节点，也可以是选定规则</strong></li>
</ul>
<p><img src="http://www.zerounix.com/images/devops/saltstack/salt_functions.png" alt="salt_functions">]</p>
<p><strong>SaltStack特点</strong></p>
<p><strong>简单：</strong></p>
<pre><code>兼顾大规模部署和小规模系统环境，Salt非常简单配置和维护，不管是本地网络系统，还是跨数据中心。salt采用C/S架构，需要的功能内建到一组daemon中，只需要简单的配置就可以工作，也可以调整来满足自己特定需求。
</code></pre><p><strong>并行执行：</strong></p>
<ul>
<li>通过并行方式让远程节点执行命令</li>
<li>采用安全的加密协议</li>
<li>最小、最快使用网络和负责</li>
<li>提供简单的编程接口</li>
<li>提供更细粒度的控制，使系统不止按照主机名，还允许按照系统属性来分类</li>
</ul>
<p><strong>成熟技术之上构建：</strong></p>
<ul>
<li>网络层采用优秀的ZeroMQ库，salt的守护进程包含可行和透明的AMQ代理</li>
<li>使用公钥和Master端通信，使用更快的AES加密协议，集成认证和加密在Salt中</li>
<li>使用msgpack通讯，所以更快速和更轻量网络交换</li>
</ul>
<p><strong>Python客户端接口：</strong></p>
<ul>
<li>允许简单的拓展，Salt程序可以写成Python模块，Client收集数据发送回Master或者其他程序</li>
<li>可以从简单的Python API调用或者从命令行调用，因此可以执行一次命令或者大型应用程序的一部分</li>
</ul>
<p><strong>快速、灵活、可扩展：</strong></p>
<ul>
<li>高速在一台或者一组服务器执行命令</li>
<li>速度快、配置简单、扩展性好，提供远程执行架构，可以管理任意数量的多样化需求的服务器</li>
<li>集成最好的远程执行工具，增强处理能力、拓展使用范围，可以使用多样化复杂的网络</li>
</ul>
<p><strong>开源：</strong></p>
<p>Salt是在Apache 2.0 Licence下开发，可以用在开源或者私有项目</p>
<p> <img src="E:\dropbox\Dropbox\hexo\source\images\devops\saltstack\salt-module.png" alt="salt-module"></p>
<hr>
<h3 id="支持的系统"><a href="#支持的系统" class="headerlink" title="支持的系统"></a><strong>支持的系统</strong></h3><p>常见的发行版都已被支持：</p>
<ul>
<li>Arch Linux</li>
<li>Debian</li>
<li>Fedora</li>
<li>FreeBSD</li>
<li>Gentoo</li>
<li>OS X</li>
<li>RHEL / CentOS / Scientific Linux / Amazon Linux / Oracle Linux（EPEL5、EPEL6、EPEL7）</li>
<li>Sloaris</li>
<li>Ubuntu</li>
<li>Windows</li>
<li>SUSE</li>
</ul>
<h2 id="安装SaltStack"><a href="#安装SaltStack" class="headerlink" title="安装SaltStack"></a>安装SaltStack</h2><h3 id="SaltStack软件依赖"><a href="#SaltStack软件依赖" class="headerlink" title="SaltStack软件依赖"></a>SaltStack软件依赖</h3><p>由于SaltStack是基于Python开发，对Python版本和python模块有一定要求。</p>
<ul>
<li>Python：版本大于2.6、小于3.0</li>
<li>msgpack-python ：高性能消息交换格式</li>
<li>YAML：SaltStack配置解析定义语法</li>
<li>Jinja2：SaltStack配置模版</li>
<li>MarkupSafe：Python unicode转换库</li>
<li>apache-libcloud：SaltStack对云架构编排库</li>
<li>Requests：HTTP Python库</li>
<li>ZeroMQ：SaltStack消息系统<ul>
<li>pyzmq：ZeroMQ Python库</li>
<li>PyCrypto：Python密码库</li>
<li>M2Crypto：Openssl Python包装库</li>
</ul>
</li>
</ul>
<h3 id="安装SaltStack-1"><a href="#安装SaltStack-1" class="headerlink" title="安装SaltStack"></a>安装SaltStack</h3><p>SaltStack提供了四种安装方式（yum、pip、源码、salt-bootstrap），部署环境为<code>CentOS Linux release 7.1.1503 (Core)</code></p>
<ul>
<li>Master（172.16.11.210）</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">rpm -ivh http://mirrors.yun-idc.com/epel/7/x86_64/e/epel-release-7-5.noarch.rpm</div><div class="line">yum install salt-master -y</div><div class="line">systemctl start salt-master</div></pre></td></tr></table></figure>
<ul>
<li>Minion（172.16.11.211）<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">rpm -ivh http://mirrors.yun-idc.com/epel/7/x86_64/e/epel-release-7-5.noarch.rpm</div><div class="line">yum install salt-minion -y</div><div class="line">sed -i &apos;s/#master: salt/master: 172.16.11.210/g&apos; /etc/salt/minion   // 这里为Master的ip地址</div><div class="line">echo &quot;172.16.11.211&quot; &gt; /etc/salt/minion_id                          // 在Master认证是显示的minion id</div><div class="line">systemctl start salt-minion</div></pre></td></tr></table></figure>
</li>
</ul>
<hr>
<h2 id="SaltStack证书管理"><a href="#SaltStack证书管理" class="headerlink" title="SaltStack证书管理"></a>SaltStack证书管理</h2><p>Salt在master和minion通信使用AES加密，保证发给minion的指令安全，Master和minion之间认证采用信任接受的Key，在发送命令到minion之前，minon的key需要先被master所接受，运行salt-key可以列出当前key状态。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">salt-key -L                                // 查看当前证书情况</div><div class="line"> Accepted Keys:</div><div class="line"> Denied Keys:</div><div class="line"> Unaccepted Keys:</div><div class="line"> 172.16.11.211</div><div class="line"> Rejected Keys:</div><div class="line"></div><div class="line">salt-key -A -y                              // 同意签证所有没接受的请求                                 </div><div class="line"> The following keys are going to be accepted:</div><div class="line"> Unaccepted Keys:</div><div class="line"> 172.16.11.211</div><div class="line"> Key for minion 172.16.11.211 accepted.</div><div class="line"></div><div class="line">salt-key -L                               </div><div class="line"> Accepted Keys:</div><div class="line"> 172.16.11.211</div><div class="line"> Denied Keys:</div><div class="line"> Unaccepted Keys:</div><div class="line"> Rejected Keys:</div></pre></td></tr></table></figure>
<p>更多的证书管理通过<code>salt-key  -h</code>查看。</p>
<hr>
<h2 id="配置SaltStack"><a href="#配置SaltStack" class="headerlink" title="配置SaltStack"></a>配置SaltStack</h2><h3 id="Master端"><a href="#Master端" class="headerlink" title="Master端"></a>Master端</h3><p>master端的配置文件是<code>/etc/salt/master</code>，其中的配置选项较多，在日常使用中，需要经常修改Master的配置文件。SaltStack的大部分配置都可以保持默认，只需根据自己的实际需求更改配置即可。其中下面几个在平时使用过程中，会经常能改。</p>
<ul>
<li>max_open_files ：     根据Master将Minin数量进行适当的调整</li>
<li>timeout  ： 可以根据Master 和Minion的网络状况调整</li>
<li>auto_accept和autosign_file： 在大规模部署Minion的时候可以设置为自动签证</li>
<li>master_tops和所有以external开头的参数： 这些参数是SaltStack与外部系统进行整合的相关配置参数</li>
</ul>
<p>详细配置信息可以参考：<a href="http://arlen.blog.51cto.com/7175583/1423997" target="_blank" rel="external">http://arlen.blog.51cto.com/7175583/1423997</a></p>
<h3 id="Minion"><a href="#Minion" class="headerlink" title="Minion"></a>Minion</h3><p>master端的配置文件是<code>/etc/salt/minion</code>，大部分情况保持默认即可<br>详细配置信息可以参考：<a href="http://arlen.blog.51cto.com/7175583/1424008" target="_blank" rel="external">http://arlen.blog.51cto.com/7175583/1424008</a></p>
<hr>
<h2 id="SaltStack常用命令操作"><a href="#SaltStack常用命令操作" class="headerlink" title="SaltStack常用命令操作"></a>SaltStack常用命令操作</h2><h4 id="Master端-1"><a href="#Master端-1" class="headerlink" title="Master端"></a>Master端</h4><ul>
<li>salt              // salt master核心操作命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt [options] &apos;&lt;target&gt;&apos; &lt;function&gt; [arguments]</div><div class="line">salt &apos;*&apos; test.ping</div></pre></td></tr></table></figure>
<ul>
<li>salt-cp         // 文件传输命令 ，不支持目录分发</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-cp [options] &apos;&lt;target&gt;&apos; SOURCE DEST</div><div class="line">salt-cp &apos;*&apos; test.txt /root/</div></pre></td></tr></table></figure>
<ul>
<li>salt-key       // 证书管理</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-key [options]</div><div class="line">salt-key -L</div></pre></td></tr></table></figure>
<ul>
<li>salt-master  // 服务命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-master [options]</div><div class="line">salt-master -d         //后台运行master</div></pre></td></tr></table></figure>
<ul>
<li>salt-run       // 执行 runner</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-run [options] [runner.func]</div><div class="line">salt-run manage.status</div></pre></td></tr></table></figure>
<ul>
<li>salt-unity</li>
</ul>
<h3 id="Minion端"><a href="#Minion端" class="headerlink" title="Minion端"></a>Minion端</h3><ul>
<li>salt-call   //  拉取命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-call [options] &lt;function&gt; [arguments]</div><div class="line">salt-call test.ping           //自己执行test.ping命令</div></pre></td></tr></table></figure>
<ul>
<li>salt-minion  // 服务命令</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt-minion [options]</div><div class="line">salt-minion -d         //后台运行</div></pre></td></tr></table></figure>
<hr>
<h2 id="SaltStack常用模块"><a href="#SaltStack常用模块" class="headerlink" title="SaltStack常用模块"></a>SaltStack常用模块</h2><p>Saltstack通过模块来实现管理，具备丰富的模块功能，命令形式也较为自由。</p>
<ul>
<li>sys.doc：类似Linux的man命令，可以显示minion支持的模块的详细操作说明</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">salt &apos;*&apos; sys.doc status.all_status        //查询status.all_status模块函数的使用方法                                                                     </div><div class="line">&apos;status.all_status:&apos;</div><div class="line">    Return a composite of all status data and info for this minion.</div><div class="line">    Warning: There is a LOT here!</div><div class="line">    CLI Example:</div><div class="line">        salt &apos;*&apos; status.all_status</div></pre></td></tr></table></figure>
<ul>
<li>status ：status模块是系统状态的常用信息模块，可以利用status模块查看系统信息</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; status.loadavg   // 查询负载信息，还有status.[cpuinfo,diskstats,meminfo,w]</div><div class="line">172.16.11.211:</div><div class="line">    ----------</div><div class="line">    1-min:</div><div class="line">        0.05</div><div class="line">    15-min:</div><div class="line">        0.05</div><div class="line">    5-min:</div><div class="line">        0.07</div></pre></td></tr></table></figure>
<ul>
<li>test：  更多使用方法使用访问官方网站或者<code>salt &#39;*&#39; sys.doc test</code></li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos;  test.ping</div><div class="line">172.16.11.211:</div><div class="line">    True</div></pre></td></tr></table></figure>
<ul>
<li>state：是salt state的管理模块，可以通过state模块简单的对minin操作sls状态</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">salt &apos;172.16.11.211&apos; state.highstate //更新指定minons的所有sls状态</div><div class="line"></div><div class="line">salt &apos;172.16.11.211&apos; state.running //查看当前运行的sls状态</div><div class="line"></div><div class="line">salt &apos;172.16.11.211&apos; state.single pkg.installed name=vim //动态指定一个sls状态</div></pre></td></tr></table></figure>
<ul>
<li>saltutil ： SaltStack的一些辅助操作命令模块</li>
</ul>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">salt &apos;*&apos; saltutil.is_running state.highstate     //判断一个函数是否正在使用</div><div class="line">salt &apos;*&apos; saltutil.kill_job &lt;job id&gt;              // 强制关闭一个job进程</div></pre></td></tr></table></figure>

          
        
      
    </div>

    <div>
      
    </div>

    <div>
      
    </div>

    <footer class="post-footer">
      

      

      
      
        <div class="post-eof"></div>
      
    </footer>
  </article>


    
  </section>

  
  <nav class="pagination">
    <a class="extend prev" rel="prev" href="/"><i class="fa fa-angle-left"></i></a><a class="page-number" href="/">1</a><span class="page-number current">2</span><a class="page-number" href="/page/3/">3</a><span class="space">&hellip;</span><a class="page-number" href="/page/11/">11</a><a class="extend next" rel="next" href="/page/3/"><i class="fa fa-angle-right"></i></a>
  </nav>



          </div>
          


          

        </div>
        
          
  
  <div class="sidebar-toggle">
    <div class="sidebar-toggle-line-wrap">
      <span class="sidebar-toggle-line sidebar-toggle-line-first"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-middle"></span>
      <span class="sidebar-toggle-line sidebar-toggle-line-last"></span>
    </div>
  </div>

  <aside id="sidebar" class="sidebar">
    <div class="sidebar-inner">

      

      

      <section class="site-overview sidebar-panel  sidebar-panel-active ">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="//schema.org/Person">
          <img class="site-author-image" itemprop="image"
               src="http://czero000.github.io/images/blog/avatar.jpg"
               alt="C.c" />
          <p class="site-author-name" itemprop="name">C.c</p>
          <p class="site-description motion-element" itemprop="description">Love Linux ♥ Love Python. 猴赛雷</p>
        </div>
        <nav class="site-state motion-element">
          <div class="site-state-item site-state-posts">
            <a href="/archives">
              <span class="site-state-item-count">104</span>
              <span class="site-state-item-name">日志</span>
            </a>
          </div>

          
            <div class="site-state-item site-state-categories">
              <a href="/categories">
                <span class="site-state-item-count">18</span>
                <span class="site-state-item-name">分类</span>
              </a>
            </div>
          

          
            <div class="site-state-item site-state-tags">
              <a href="/tags">
                <span class="site-state-item-count">76</span>
                <span class="site-state-item-name">标签</span>
              </a>
            </div>
          

        </nav>

        

        <div class="links-of-author motion-element">
          
        </div>

        
        
          <div class="cc-license motion-element" itemprop="license">
            <a href="https://creativecommons.org/licenses/by-nc-sa/4.0/" class="cc-opacity" target="_blank">
              <img src="/images/cc-by-nc-sa.svg" alt="Creative Commons" />
            </a>
          </div>
        

        
        

      </section>

      

    </div>
  </aside>


        
      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="footer-inner">
        <div class="copyright" >
  
  &copy;  2015 - 
  <span itemprop="copyrightYear">2016</span>
  <span class="with-love">
    <i class="fa fa-heart"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">C.c</span>
</div>

<div class="powered-by">
  由 <a class="theme-link" href="https://hexo.io">Hexo</a> 强力驱动
</div>

<div class="theme-info">
  主题 -
  <a class="theme-link" href="https://github.com/iissnan/hexo-theme-next">
    NexT.Pisces
  </a>
</div>

        

        
      </div>
    </footer>

    <div class="back-to-top">
      <i class="fa fa-arrow-up"></i>
    </div>
  </div>

  

<script type="text/javascript">
  if (Object.prototype.toString.call(window.Promise) !== '[object Function]') {
    window.Promise = null;
  }
</script>









  



  
  <script type="text/javascript" src="/vendors/jquery/index.js?v=2.1.3"></script>

  
  <script type="text/javascript" src="/vendors/fastclick/lib/fastclick.min.js?v=1.0.6"></script>

  
  <script type="text/javascript" src="/vendors/jquery_lazyload/jquery.lazyload.js?v=1.9.7"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/velocity/velocity.ui.min.js?v=1.2.1"></script>

  
  <script type="text/javascript" src="/vendors/fancybox/source/jquery.fancybox.pack.js?v=2.1.5"></script>


  


  <script type="text/javascript" src="/js/src/utils.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/motion.js?v=5.0.2"></script>



  
  


  <script type="text/javascript" src="/js/src/affix.js?v=5.0.2"></script>

  <script type="text/javascript" src="/js/src/schemes/pisces.js?v=5.0.2"></script>



  

  


  <script type="text/javascript" src="/js/src/bootstrap.js?v=5.0.2"></script>



  

  
    
  

  <script type="text/javascript">
    var duoshuoQuery = {short_name:"czero000"};
    (function() {
      var ds = document.createElement('script');
      ds.type = 'text/javascript';ds.async = true;
      ds.id = 'duoshuo-script';
      ds.src = (document.location.protocol == 'https:' ? 'https:' : 'http:') + '//static.duoshuo.com/embed.js';
      ds.charset = 'UTF-8';
      (document.getElementsByTagName('head')[0]
      || document.getElementsByTagName('body')[0]).appendChild(ds);
    })();
  </script>

  
    
    <script src="/vendors/ua-parser-js/dist/ua-parser.min.js?v=0.7.9"></script>
    <script src="/js/src/hook-duoshuo.js"></script>
  






  
  

  

  

  
  <script src="https://cdn1.lncld.net/static/js/av-core-mini-0.6.1.js"></script>
  <script>AV.initialize("Rl3Nh6z96ldNfoGXOaUqBT47-gzGzoHsz", "NmOEHbcsySJxEnVKuV23xr49");</script>
  <script>
    function showTime(Counter) {
      var query = new AV.Query(Counter);
      var entries = [];
      var $visitors = $(".leancloud_visitors");

      $visitors.each(function () {
        entries.push( $(this).attr("id").trim() );
      });

      query.containedIn('url', entries);
      query.find()
        .done(function (results) {
          var COUNT_CONTAINER_REF = '.leancloud-visitors-count';

          if (results.length === 0) {
            $visitors.find(COUNT_CONTAINER_REF).text(0);
            return;
          }

          for (var i = 0; i < results.length; i++) {
            var item = results[i];
            var url = item.get('url');
            var time = item.get('time');
            var element = document.getElementById(url);

            $(element).find(COUNT_CONTAINER_REF).text(time);
          }
          for(var i = 0; i < entries.length; i++) {
            var url = entries[i];
            var element = document.getElementById(url);
            var countSpan = $(element).find(COUNT_CONTAINER_REF);
            if( countSpan.text() == '') {
              countSpan.text(0);
            }
          }
        })
        .fail(function (object, error) {
          console.log("Error: " + error.code + " " + error.message);
        });
    }

    function addCount(Counter) {
      var $visitors = $(".leancloud_visitors");
      var url = $visitors.attr('id').trim();
      var title = $visitors.attr('data-flag-title').trim();
      var query = new AV.Query(Counter);

      query.equalTo("url", url);
      query.find({
        success: function(results) {
          if (results.length > 0) {
            var counter = results[0];
            counter.fetchWhenSave(true);
            counter.increment("time");
            counter.save(null, {
              success: function(counter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(counter.get('time'));
              },
              error: function(counter, error) {
                console.log('Failed to save Visitor num, with error message: ' + error.message);
              }
            });
          } else {
            var newcounter = new Counter();
            /* Set ACL */
            var acl = new AV.ACL();
            acl.setPublicReadAccess(true);
            acl.setPublicWriteAccess(true);
            newcounter.setACL(acl);
            /* End Set ACL */
            newcounter.set("title", title);
            newcounter.set("url", url);
            newcounter.set("time", 1);
            newcounter.save(null, {
              success: function(newcounter) {
                var $element = $(document.getElementById(url));
                $element.find('.leancloud-visitors-count').text(newcounter.get('time'));
              },
              error: function(newcounter, error) {
                console.log('Failed to create');
              }
            });
          }
        },
        error: function(error) {
          console.log('Error:' + error.code + " " + error.message);
        }
      });
    }

    $(function() {
      var Counter = AV.Object.extend("Counter");
      if ($('.leancloud_visitors').length == 1) {
        addCount(Counter);
      } else if ($('.post-title-link').length > 1) {
        showTime(Counter);
      }
    });
  </script>



  
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>



</body>
</html>
